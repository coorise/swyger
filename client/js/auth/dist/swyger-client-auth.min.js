var ba=Object.defineProperty,xa=Object.defineProperties;var Ea=Object.getOwnPropertyDescriptors;var ws=Object.getOwnPropertySymbols;var ka=Object.prototype.hasOwnProperty,_a=Object.prototype.propertyIsEnumerable;var Zn=(r,e,t)=>e in r?ba(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,V=(r,e)=>{for(var t in e||(e={}))ka.call(e,t)&&Zn(r,t,e[t]);if(ws)for(var t of ws(e))_a.call(e,t)&&Zn(r,t,e[t]);return r},we=(r,e)=>xa(r,Ea(e));var bs=(r,e,t)=>(Zn(r,typeof e!="symbol"?e+"":e,t),t),xs=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var Fe=(r,e,t)=>(xs(r,e,"read from private field"),t?t.call(r):e.get(r)),_t=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},tn=(r,e,t,n)=>(xs(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var k=(r,e,t)=>new Promise((n,s)=>{var i=c=>{try{a(t.next(c))}catch(u){s(u)}},o=c=>{try{a(t.throw(c))}catch(u){s(u)}},a=c=>c.done?n(c.value):Promise.resolve(c.value).then(i,o);a((t=t.apply(r,e)).next())});const qe=Object.create(null);qe.open="0";qe.close="1";qe.ping="2";qe.pong="3";qe.message="4";qe.upgrade="5";qe.noop="6";const hn=Object.create(null);Object.keys(qe).forEach(r=>{hn[qe[r]]=r});const Aa={type:"error",data:"parser error"},Sa=typeof Blob=="function"||typeof Blob!="undefined"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Ta=typeof ArrayBuffer=="function",Oa=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r&&r.buffer instanceof ArrayBuffer,hi=({type:r,data:e},t,n)=>Sa&&e instanceof Blob?t?n(e):Es(e,n):Ta&&(e instanceof ArrayBuffer||Oa(e))?t?n(e):Es(new Blob([e]),n):n(qe[r]+(e||"")),Es=(r,e)=>{const t=new FileReader;return t.onload=function(){const n=t.result.split(",")[1];e("b"+(n||""))},t.readAsDataURL(r)},ks="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ut=typeof Uint8Array=="undefined"?[]:new Uint8Array(256);for(let r=0;r<ks.length;r++)Ut[ks.charCodeAt(r)]=r;const Pa=r=>{let e=r.length*.75,t=r.length,n,s=0,i,o,a,c;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);const u=new ArrayBuffer(e),l=new Uint8Array(u);for(n=0;n<t;n+=4)i=Ut[r.charCodeAt(n)],o=Ut[r.charCodeAt(n+1)],a=Ut[r.charCodeAt(n+2)],c=Ut[r.charCodeAt(n+3)],l[s++]=i<<2|o>>4,l[s++]=(o&15)<<4|a>>2,l[s++]=(a&3)<<6|c&63;return u},Ia=typeof ArrayBuffer=="function",di=(r,e)=>{if(typeof r!="string")return{type:"message",data:pi(r,e)};const t=r.charAt(0);return t==="b"?{type:"message",data:Ra(r.substring(1),e)}:hn[t]?r.length>1?{type:hn[t],data:r.substring(1)}:{type:hn[t]}:Aa},Ra=(r,e)=>{if(Ia){const t=Pa(r);return pi(t,e)}else return{base64:!0,data:r}},pi=(r,e)=>{switch(e){case"blob":return r instanceof ArrayBuffer?new Blob([r]):r;case"arraybuffer":default:return r}},yi=String.fromCharCode(30),Ca=(r,e)=>{const t=r.length,n=new Array(t);let s=0;r.forEach((i,o)=>{hi(i,!1,a=>{n[o]=a,++s===t&&e(n.join(yi))})})},Na=(r,e)=>{const t=r.split(yi),n=[];for(let s=0;s<t.length;s++){const i=di(t[s],e);if(n.push(i),i.type==="error")break}return n},mi=4;function de(r){if(r)return $a(r)}function $a(r){for(var e in de.prototype)r[e]=de.prototype[e];return r}de.prototype.on=de.prototype.addEventListener=function(r,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+r]=this._callbacks["$"+r]||[]).push(e),this};de.prototype.once=function(r,e){function t(){this.off(r,t),e.apply(this,arguments)}return t.fn=e,this.on(r,t),this};de.prototype.off=de.prototype.removeListener=de.prototype.removeAllListeners=de.prototype.removeEventListener=function(r,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+r];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+r],this;for(var n,s=0;s<t.length;s++)if(n=t[s],n===e||n.fn===e){t.splice(s,1);break}return t.length===0&&delete this._callbacks["$"+r],this};de.prototype.emit=function(r){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+r],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t){t=t.slice(0);for(var n=0,s=t.length;n<s;++n)t[n].apply(this,e)}return this};de.prototype.emitReserved=de.prototype.emit;de.prototype.listeners=function(r){return this._callbacks=this._callbacks||{},this._callbacks["$"+r]||[]};de.prototype.hasListeners=function(r){return!!this.listeners(r).length};const Le=(()=>typeof self!="undefined"?self:typeof window!="undefined"?window:Function("return this")())();function gi(r,...e){return e.reduce((t,n)=>(r.hasOwnProperty(n)&&(t[n]=r[n]),t),{})}const ja=Le.setTimeout,Ba=Le.clearTimeout;function $n(r,e){e.useNativeTimers?(r.setTimeoutFn=ja.bind(Le),r.clearTimeoutFn=Ba.bind(Le)):(r.setTimeoutFn=Le.setTimeout.bind(Le),r.clearTimeoutFn=Le.clearTimeout.bind(Le))}const La=1.33;function Da(r){return typeof r=="string"?Ua(r):Math.ceil((r.byteLength||r.size)*La)}function Ua(r){let e=0,t=0;for(let n=0,s=r.length;n<s;n++)e=r.charCodeAt(n),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(n++,t+=4);return t}class Fa extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class vi extends de{constructor(e){super(),this.writable=!1,$n(this,e),this.opts=e,this.query=e.query,this.socket=e.socket}onError(e,t,n){return super.emitReserved("error",new Fa(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=di(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}}const wi="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),mr=64,Ma={};let _s=0,nn=0,As;function Ss(r){let e="";do e=wi[r%mr]+e,r=Math.floor(r/mr);while(r>0);return e}function bi(){const r=Ss(+new Date);return r!==As?(_s=0,As=r):r+"."+Ss(_s++)}for(;nn<mr;nn++)Ma[wi[nn]]=nn;function xi(r){let e="";for(let t in r)r.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(r[t]));return e}function Ka(r){let e={},t=r.split("&");for(let n=0,s=t.length;n<s;n++){let i=t[n].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}let Ei=!1;try{Ei=typeof XMLHttpRequest!="undefined"&&"withCredentials"in new XMLHttpRequest}catch(r){}const Va=Ei;function ki(r){const e=r.xdomain;try{if(typeof XMLHttpRequest!="undefined"&&(!e||Va))return new XMLHttpRequest}catch(t){}if(!e)try{return new Le[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch(t){}}function za(){}const Wa=function(){return new ki({xdomain:!1}).responseType!=null}();class Ha extends vi{constructor(e){if(super(e),this.polling=!1,typeof location!="undefined"){const n=location.protocol==="https:";let s=location.port;s||(s=n?"443":"80"),this.xd=typeof location!="undefined"&&e.hostname!==location.hostname||s!==e.port,this.xs=e.secure!==n}const t=e&&e.forceBase64;this.supportsBinary=Wa&&!t}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let n=0;this.polling&&(n++,this.once("pollComplete",function(){--n||t()})),this.writable||(n++,this.once("drain",function(){--n||t()}))}else t()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=n=>{if(this.readyState==="opening"&&n.type==="open"&&this.onOpen(),n.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(n)};Na(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this.polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this.poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Ca(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){let e=this.query||{};const t=this.opts.secure?"https":"http";let n="";this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=bi()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.opts.port&&(t==="https"&&Number(this.opts.port)!==443||t==="http"&&Number(this.opts.port)!==80)&&(n=":"+this.opts.port);const s=xi(e),i=this.opts.hostname.indexOf(":")!==-1;return t+"://"+(i?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(s.length?"?"+s:"")}request(e={}){return Object.assign(e,{xd:this.xd,xs:this.xs},this.opts),new Je(this.uri(),e)}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",(s,i)=>{this.onError("xhr post error",s,i)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,n)=>{this.onError("xhr poll error",t,n)}),this.pollXhr=e}}class Je extends de{constructor(e,t){super(),$n(this,t),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=t.async!==!1,this.data=t.data!==void 0?t.data:null,this.create()}create(){const e=gi(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new ki(e);try{t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let n in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(n)&&t.setRequestHeader(n,this.opts.extraHeaders[n])}}catch(n){}if(this.method==="POST")try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(n){}try{t.setRequestHeader("Accept","*/*")}catch(n){}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),t.onreadystatechange=()=>{t.readyState===4&&(t.status===200||t.status===1223?this.onLoad():this.setTimeoutFn(()=>{this.onError(typeof t.status=="number"?t.status:0)},0))},t.send(this.data)}catch(n){this.setTimeoutFn(()=>{this.onError(n)},0);return}typeof document!="undefined"&&(this.index=Je.requestsCount++,Je.requests[this.index]=this)}onError(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}cleanup(e){if(!(typeof this.xhr=="undefined"||this.xhr===null)){if(this.xhr.onreadystatechange=za,e)try{this.xhr.abort()}catch(t){}typeof document!="undefined"&&delete Je.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}Je.requestsCount=0;Je.requests={};if(typeof document!="undefined"){if(typeof attachEvent=="function")attachEvent("onunload",Ts);else if(typeof addEventListener=="function"){const r="onpagehide"in Le?"pagehide":"unload";addEventListener(r,Ts,!1)}}function Ts(){for(let r in Je.requests)Je.requests.hasOwnProperty(r)&&Je.requests[r].abort()}const _i=(()=>typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0))(),rn=Le.WebSocket||Le.MozWebSocket,Os=!0,Ja="arraybuffer",Ps=typeof navigator!="undefined"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class qa extends vi{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,n=Ps?{}:gi(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=Os&&!Ps?t?new rn(e,t):new rn(e):new rn(e,t,n)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType||Ja,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],s=t===e.length-1;hi(n,this.supportsBinary,i=>{const o={};try{Os&&this.ws.send(i)}catch(a){}s&&_i(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws!="undefined"&&(this.ws.close(),this.ws=null)}uri(){let e=this.query||{};const t=this.opts.secure?"wss":"ws";let n="";this.opts.port&&(t==="wss"&&Number(this.opts.port)!==443||t==="ws"&&Number(this.opts.port)!==80)&&(n=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=bi()),this.supportsBinary||(e.b64=1);const s=xi(e),i=this.opts.hostname.indexOf(":")!==-1;return t+"://"+(i?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(s.length?"?"+s:"")}check(){return!!rn}}const Ya={websocket:qa,polling:Ha},Ga=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Qa=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function gr(r){const e=r,t=r.indexOf("["),n=r.indexOf("]");t!=-1&&n!=-1&&(r=r.substring(0,t)+r.substring(t,n).replace(/:/g,";")+r.substring(n,r.length));let s=Ga.exec(r||""),i={},o=14;for(;o--;)i[Qa[o]]=s[o]||"";return t!=-1&&n!=-1&&(i.source=e,i.host=i.host.substring(1,i.host.length-1).replace(/;/g,":"),i.authority=i.authority.replace("[","").replace("]","").replace(/;/g,":"),i.ipv6uri=!0),i.pathNames=Xa(i,i.path),i.queryKey=Za(i,i.query),i}function Xa(r,e){const t=/\/{2,9}/g,n=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&n.splice(0,1),e.slice(-1)=="/"&&n.splice(n.length-1,1),n}function Za(r,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(n,s,i){s&&(t[s]=i)}),t}class at extends de{constructor(e,t={}){super(),this.writeBuffer=[],e&&typeof e=="object"&&(t=e,e=null),e?(e=gr(e),t.hostname=e.host,t.secure=e.protocol==="https"||e.protocol==="wss",t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=gr(t.host).host),$n(this,t),this.secure=t.secure!=null?t.secure:typeof location!="undefined"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location!="undefined"?location.hostname:"localhost"),this.port=t.port||(typeof location!="undefined"&&location.port?location.port:this.secure?"443":"80"),this.transports=t.transports||["polling","websocket"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Ka(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,typeof addEventListener=="function"&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=mi,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new Ya[e](n)}open(){let e;if(this.opts.rememberUpgrade&&at.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)e="websocket";else if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}else e=this.transports[0];this.readyState="opening";try{e=this.createTransport(e)}catch(t){this.transports.shift(),this.open();return}e.open(),this.setTransport(e)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",t=>this.onClose("transport close",t))}probe(e){let t=this.createTransport(e),n=!1;at.priorWebsocketSuccess=!1;const s=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",f=>{if(!n)if(f.type==="pong"&&f.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;at.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{n||this.readyState!=="closed"&&(l(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const y=new Error("probe error");y.transport=t.name,this.emitReserved("upgradeError",y)}}))};function i(){n||(n=!0,l(),t.close(),t=null)}const o=f=>{const y=new Error("probe error: "+f);y.transport=t.name,i(),this.emitReserved("upgradeError",y)};function a(){o("transport closed")}function c(){o("socket closed")}function u(f){t&&f.name!==t.name&&i()}const l=()=>{t.removeListener("open",s),t.removeListener("error",o),t.removeListener("close",a),this.off("close",c),this.off("upgrading",u)};t.once("open",s),t.once("error",o),t.once("close",a),this.once("close",c),this.once("upgrading",u),t.open()}onOpen(){if(this.readyState="open",at.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush(),this.readyState==="open"&&this.opts.upgrade){let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let n=0;n<this.writeBuffer.length;n++){const s=this.writeBuffer[n].data;if(s&&(t+=Da(s)),n>0&&t>this.maxPayload)return this.writeBuffer.slice(0,n);t+=2}return this.writeBuffer}write(e,t,n){return this.sendPacket("message",e,t,n),this}send(e,t,n){return this.sendPacket("message",e,t,n),this}sendPacket(e,t,n,s){if(typeof t=="function"&&(s=t,t=void 0),typeof n=="function"&&(s=n,n=null),this.readyState==="closing"||this.readyState==="closed")return;n=n||{},n.compress=n.compress!==!1;const i={type:e,data:t,options:n};this.emitReserved("packetCreate",i),this.writeBuffer.push(i),s&&this.once("flush",s),this.flush()}close(){const e=()=>{this.onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?n():e()}):this.upgrading?n():e()),this}onError(e){at.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}onClose(e,t){(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")&&(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),typeof removeEventListener=="function"&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let n=0;const s=e.length;for(;n<s;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}at.protocol=mi;function ec(r,e="",t){let n=r;t=t||typeof location!="undefined"&&location,r==null&&(r=t.protocol+"//"+t.host),typeof r=="string"&&(r.charAt(0)==="/"&&(r.charAt(1)==="/"?r=t.protocol+r:r=t.host+r),/^(https?|wss?):\/\//.test(r)||(typeof t!="undefined"?r=t.protocol+"//"+r:r="https://"+r),n=gr(r)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";const i=n.host.indexOf(":")!==-1?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+i+":"+n.port+e,n.href=n.protocol+"://"+i+(t&&t.port===n.port?"":":"+n.port),n}const tc=typeof ArrayBuffer=="function",nc=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r.buffer instanceof ArrayBuffer,Ai=Object.prototype.toString,rc=typeof Blob=="function"||typeof Blob!="undefined"&&Ai.call(Blob)==="[object BlobConstructor]",sc=typeof File=="function"||typeof File!="undefined"&&Ai.call(File)==="[object FileConstructor]";function Dr(r){return tc&&(r instanceof ArrayBuffer||nc(r))||rc&&r instanceof Blob||sc&&r instanceof File}function dn(r,e){if(!r||typeof r!="object")return!1;if(Array.isArray(r)){for(let t=0,n=r.length;t<n;t++)if(dn(r[t]))return!0;return!1}if(Dr(r))return!0;if(r.toJSON&&typeof r.toJSON=="function"&&arguments.length===1)return dn(r.toJSON(),!0);for(const t in r)if(Object.prototype.hasOwnProperty.call(r,t)&&dn(r[t]))return!0;return!1}function ic(r){const e=[],t=r.data,n=r;return n.data=vr(t,e),n.attachments=e.length,{packet:n,buffers:e}}function vr(r,e){if(!r)return r;if(Dr(r)){const t={_placeholder:!0,num:e.length};return e.push(r),t}else if(Array.isArray(r)){const t=new Array(r.length);for(let n=0;n<r.length;n++)t[n]=vr(r[n],e);return t}else if(typeof r=="object"&&!(r instanceof Date)){const t={};for(const n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=vr(r[n],e));return t}return r}function oc(r,e){return r.data=wr(r.data,e),delete r.attachments,r}function wr(r,e){if(!r)return r;if(r&&r._placeholder===!0){if(typeof r.num=="number"&&r.num>=0&&r.num<e.length)return e[r.num];throw new Error("illegal attachments")}else if(Array.isArray(r))for(let t=0;t<r.length;t++)r[t]=wr(r[t],e);else if(typeof r=="object")for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(r[t]=wr(r[t],e));return r}const ac=5;var ee;(function(r){r[r.CONNECT=0]="CONNECT",r[r.DISCONNECT=1]="DISCONNECT",r[r.EVENT=2]="EVENT",r[r.ACK=3]="ACK",r[r.CONNECT_ERROR=4]="CONNECT_ERROR",r[r.BINARY_EVENT=5]="BINARY_EVENT",r[r.BINARY_ACK=6]="BINARY_ACK"})(ee||(ee={}));class cc{constructor(e){this.replacer=e}encode(e){return(e.type===ee.EVENT||e.type===ee.ACK)&&dn(e)?this.encodeAsBinary({type:e.type===ee.EVENT?ee.BINARY_EVENT:ee.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===ee.BINARY_EVENT||e.type===ee.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=ic(e),n=this.encodeAsString(t.packet),s=t.buffers;return s.unshift(n),s}}class Ur extends de{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===ee.BINARY_EVENT;n||t.type===ee.BINARY_ACK?(t.type=n?ee.EVENT:ee.ACK,this.reconstructor=new uc(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(Dr(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(ee[n.type]===void 0)throw new Error("unknown packet type "+n.type);if(n.type===ee.BINARY_EVENT||n.type===ee.BINARY_ACK){const i=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const o=e.substring(i,t);if(o!=Number(o)||e.charAt(t)!=="-")throw new Error("Illegal attachments");n.attachments=Number(o)}if(e.charAt(t+1)==="/"){const i=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););n.nsp=e.substring(i,t)}else n.nsp="/";const s=e.charAt(t+1);if(s!==""&&Number(s)==s){const i=t+1;for(;++t;){const o=e.charAt(t);if(o==null||Number(o)!=o){--t;break}if(t===e.length)break}n.id=Number(e.substring(i,t+1))}if(e.charAt(++t)){const i=this.tryParse(e.substr(t));if(Ur.isPayloadValid(n.type,i))n.data=i;else throw new Error("invalid payload")}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(t){return!1}}static isPayloadValid(e,t){switch(e){case ee.CONNECT:return typeof t=="object";case ee.DISCONNECT:return t===void 0;case ee.CONNECT_ERROR:return typeof t=="string"||typeof t=="object";case ee.EVENT:case ee.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="string"||typeof t[0]=="number");case ee.ACK:case ee.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class uc{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=oc(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const lc=Object.freeze(Object.defineProperty({__proto__:null,protocol:ac,get PacketType(){return ee},Encoder:cc,Decoder:Ur},Symbol.toStringTag,{value:"Module"}));function Ke(r,e,t){return r.on(e,t),function(){r.off(e,t)}}const fc=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Si extends de{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Ke(e,"open",this.onopen.bind(this)),Ke(e,"packet",this.onpacket.bind(this)),Ke(e,"error",this.onerror.bind(this)),Ke(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(fc.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const n={type:ee.EVENT,data:t};if(n.options={},n.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const o=this.ids++,a=t.pop();this._registerAckCallback(o,a),n.id=o}const s=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!s||!this.connected)||(this.connected?(this.notifyOutgoingListeners(n),this.packet(n)):this.sendBuffer.push(n)),this.flags={},this}_registerAckCallback(e,t){var n;const s=(n=this.flags.timeout)!==null&&n!==void 0?n:this._opts.ackTimeout;if(s===void 0){this.acks[e]=t;return}const i=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let o=0;o<this.sendBuffer.length;o++)this.sendBuffer[o].id===e&&this.sendBuffer.splice(o,1);t.call(this,new Error("operation has timed out"))},s);this.acks[e]=(...o)=>{this.io.clearTimeoutFn(i),t.apply(this,[null,...o])}}emitWithAck(e,...t){const n=this.flags.timeout!==void 0||this._opts.ackTimeout!==void 0;return new Promise((s,i)=>{t.push((o,a)=>n?o?i(o):s(a):s(o)),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((s,...i)=>n!==this._queue[0]?void 0:(s!==null?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(s)):(this._queue.shift(),t&&t(null,...i)),n.pending=!1,this._drainQueue())),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:ee.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t)}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case ee.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case ee.EVENT:case ee.BINARY_EVENT:this.onevent(e);break;case ee.ACK:case ee.BINARY_ACK:this.onack(e);break;case ee.DISCONNECT:this.ondisconnect();break;case ee.CONNECT_ERROR:this.destroy();const n=new Error(e.data.message);n.data=e.data.data,this.emitReserved("connect_error",n);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...s){n||(n=!0,t.packet({type:ee.ACK,id:e,data:s}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(t.apply(this,e.data),delete this.acks[e.id])}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:ee.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function Nt(r){r=r||{},this.ms=r.min||100,this.max=r.max||1e4,this.factor=r.factor||2,this.jitter=r.jitter>0&&r.jitter<=1?r.jitter:0,this.attempts=0}Nt.prototype.duration=function(){var r=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*r);r=(Math.floor(e*10)&1)==0?r-t:r+t}return Math.min(r,this.max)|0};Nt.prototype.reset=function(){this.attempts=0};Nt.prototype.setMin=function(r){this.ms=r};Nt.prototype.setMax=function(r){this.max=r};Nt.prototype.setJitter=function(r){this.jitter=r};class br extends de{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,$n(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((n=t.randomizationFactor)!==null&&n!==void 0?n:.5),this.backoff=new Nt({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const s=t.parser||lc;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new at(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const s=Ke(t,"open",function(){n.onopen(),e&&e()}),i=Ke(t,"error",o=>{n.cleanup(),n._readyState="closed",this.emitReserved("error",o),e?e(o):n.maybeReconnectOnOpen()});if(this._timeout!==!1){const o=this._timeout;o===0&&s();const a=this.setTimeoutFn(()=>{s(),t.close(),t.emit("error",new Error("timeout"))},o);this.opts.autoUnref&&a.unref(),this.subs.push(function(){clearTimeout(a)})}return this.subs.push(s),this.subs.push(i),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Ke(e,"ping",this.onping.bind(this)),Ke(e,"data",this.ondata.bind(this)),Ke(e,"error",this.onerror.bind(this)),Ke(e,"close",this.onclose.bind(this)),Ke(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){_i(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new Si(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t)if(this.nsps[n].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(s=>{s?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",s)):e.onreconnect()}))},t);this.opts.autoUnref&&n.unref(),this.subs.push(function(){clearTimeout(n)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Bt={};function pn(r,e){typeof r=="object"&&(e=r,r=void 0),e=e||{};const t=ec(r,e.path||"/socket.io"),n=t.source,s=t.id,i=t.path,o=Bt[s]&&i in Bt[s].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||o;let c;return a?c=new br(n,e):(Bt[s]||(Bt[s]=new br(n,e)),c=Bt[s]),t.query&&!e.query&&(e.query=t.queryKey),c.socket(t.path,e)}Object.assign(pn,{Manager:br,Socket:Si,io:pn,connect:pn});const hc={init:({API_KEY:r,HOST_SERVER:e,CURRENT:t,ENV:n,API_VERSION:s})=>{var a,c;let i={};const o=localStorage.getItem("accessToken");try{const u={Accept:"application/json","Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Key":r,"Access-Control-Allow-Methods":"POST, GET, OPTIONS, PUT, DELETE, HEAD,PATCH","Access-Control-Allow-Headers":"X-PINGOTHER, Origin, X-Requested-With, Content-Type, Accept","Access-Control-Max-Age":"1728000"};return o&&(u.Authorization="Bearer "+o),i.auth=pn(e.AUTH,{extraHeaders:u}),(a=i==null?void 0:i.auth)==null||a.on("connect",()=>{var f,y,p,d,h;n==="dev"&&console.log("Swyger Auth Client JS is connected with Swyger Server!!!");let l=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");l.uid&&(f=i.auth)!=null&&f.id&&(n==="dev"&&console.log("The socket device id is: ",(y=i.auth)==null?void 0:y.id),(d=i==null?void 0:i.auth)==null||d.emit((s==null?void 0:s.AUTH)+"/user/join",{socketId:(p=i.auth)==null?void 0:p.id,currentUserId:l.uid}),(h=i==null?void 0:i.auth)==null||h.on((s==null?void 0:s.AUTH)+"/user/status",m=>{if(l.status!=="online"){let g;m.from===l.uid&&(g=m==null?void 0:m.value),g!=null&&g.status&&(n==="dev"&&console.log("user is online: ",g),l.status=g.status,localStorage.setItem("userInfo",JSON.stringify(l)))}}))}),(c=i==null?void 0:i.auth)==null||c.on("disconnect",l=>{n==="dev"&&console.log("The device is disconnected from Auth server!");let f=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");f.uid&&f.status!=="offline"&&(f.status="offline",localStorage.setItem("userInfo",JSON.stringify(f)))}),i}catch(u){}}};function xr(r){this.message=r}xr.prototype=new Error,xr.prototype.name="InvalidCharacterError";var Is=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(r){var e=String(r).replace(/=+$/,"");if(e.length%4==1)throw new xr("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,n,s=0,i=0,o="";n=e.charAt(i++);~n&&(t=s%4?64*t+n:n,s++%4)?o+=String.fromCharCode(255&t>>(-2*s&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return o};function dc(r){var e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(t){return decodeURIComponent(Is(t).replace(/(.)/g,function(n,s){var i=s.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i}))}(e)}catch(t){return Is(e)}}function _n(r){this.message=r}function pc(r,e){if(typeof r!="string")throw new _n("Invalid token specified");var t=(e=e||{}).header===!0?0:1;try{return JSON.parse(dc(r.split(".")[t]))}catch(n){throw new _n("Invalid token specified: "+n.message)}}_n.prototype=new Error,_n.prototype.name="InvalidTokenError";function Ti(r,e){return function(){return r.apply(e,arguments)}}const{toString:yc}=Object.prototype,{getPrototypeOf:Fr}=Object,jn=(r=>e=>{const t=yc.call(e);return r[t]||(r[t]=t.slice(8,-1).toLowerCase())})(Object.create(null)),Ye=r=>(r=r.toLowerCase(),e=>jn(e)===r),Bn=r=>e=>typeof e===r,{isArray:$t}=Array,Ft=Bn("undefined");function mc(r){return r!==null&&!Ft(r)&&r.constructor!==null&&!Ft(r.constructor)&&De(r.constructor.isBuffer)&&r.constructor.isBuffer(r)}const Oi=Ye("ArrayBuffer");function gc(r){let e;return typeof ArrayBuffer!="undefined"&&ArrayBuffer.isView?e=ArrayBuffer.isView(r):e=r&&r.buffer&&Oi(r.buffer),e}const vc=Bn("string"),De=Bn("function"),Pi=Bn("number"),Ln=r=>r!==null&&typeof r=="object",wc=r=>r===!0||r===!1,yn=r=>{if(jn(r)!=="object")return!1;const e=Fr(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)},bc=Ye("Date"),xc=Ye("File"),Ec=Ye("Blob"),kc=Ye("FileList"),_c=r=>Ln(r)&&De(r.pipe),Ac=r=>{let e;return r&&(typeof FormData=="function"&&r instanceof FormData||De(r.append)&&((e=jn(r))==="formdata"||e==="object"&&De(r.toString)&&r.toString()==="[object FormData]"))},Sc=Ye("URLSearchParams"),Tc=r=>r.trim?r.trim():r.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function qt(r,e,{allOwnKeys:t=!1}={}){if(r===null||typeof r=="undefined")return;let n,s;if(typeof r!="object"&&(r=[r]),$t(r))for(n=0,s=r.length;n<s;n++)e.call(null,r[n],n,r);else{const i=t?Object.getOwnPropertyNames(r):Object.keys(r),o=i.length;let a;for(n=0;n<o;n++)a=i[n],e.call(null,r[a],a,r)}}function Ii(r,e){e=e.toLowerCase();const t=Object.keys(r);let n=t.length,s;for(;n-- >0;)if(s=t[n],e===s.toLowerCase())return s;return null}const Ri=(()=>typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:typeof window!="undefined"?window:global)(),Ci=r=>!Ft(r)&&r!==Ri;function Er(){const{caseless:r}=Ci(this)&&this||{},e={},t=(n,s)=>{const i=r&&Ii(e,s)||s;yn(e[i])&&yn(n)?e[i]=Er(e[i],n):yn(n)?e[i]=Er({},n):$t(n)?e[i]=n.slice():e[i]=n};for(let n=0,s=arguments.length;n<s;n++)arguments[n]&&qt(arguments[n],t);return e}const Oc=(r,e,t,{allOwnKeys:n}={})=>(qt(e,(s,i)=>{t&&De(s)?r[i]=Ti(s,t):r[i]=s},{allOwnKeys:n}),r),Pc=r=>(r.charCodeAt(0)===65279&&(r=r.slice(1)),r),Ic=(r,e,t,n)=>{r.prototype=Object.create(e.prototype,n),r.prototype.constructor=r,Object.defineProperty(r,"super",{value:e.prototype}),t&&Object.assign(r.prototype,t)},Rc=(r,e,t,n)=>{let s,i,o;const a={};if(e=e||{},r==null)return e;do{for(s=Object.getOwnPropertyNames(r),i=s.length;i-- >0;)o=s[i],(!n||n(o,r,e))&&!a[o]&&(e[o]=r[o],a[o]=!0);r=t!==!1&&Fr(r)}while(r&&(!t||t(r,e))&&r!==Object.prototype);return e},Cc=(r,e,t)=>{r=String(r),(t===void 0||t>r.length)&&(t=r.length),t-=e.length;const n=r.indexOf(e,t);return n!==-1&&n===t},Nc=r=>{if(!r)return null;if($t(r))return r;let e=r.length;if(!Pi(e))return null;const t=new Array(e);for(;e-- >0;)t[e]=r[e];return t},$c=(r=>e=>r&&e instanceof r)(typeof Uint8Array!="undefined"&&Fr(Uint8Array)),jc=(r,e)=>{const n=(r&&r[Symbol.iterator]).call(r);let s;for(;(s=n.next())&&!s.done;){const i=s.value;e.call(r,i[0],i[1])}},Bc=(r,e)=>{let t;const n=[];for(;(t=r.exec(e))!==null;)n.push(t);return n},Lc=Ye("HTMLFormElement"),Dc=r=>r.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,n,s){return n.toUpperCase()+s}),Rs=(({hasOwnProperty:r})=>(e,t)=>r.call(e,t))(Object.prototype),Uc=Ye("RegExp"),Ni=(r,e)=>{const t=Object.getOwnPropertyDescriptors(r),n={};qt(t,(s,i)=>{e(s,i,r)!==!1&&(n[i]=s)}),Object.defineProperties(r,n)},Fc=r=>{Ni(r,(e,t)=>{if(De(r)&&["arguments","caller","callee"].indexOf(t)!==-1)return!1;const n=r[t];if(!!De(n)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+t+"'")})}})},Mc=(r,e)=>{const t={},n=s=>{s.forEach(i=>{t[i]=!0})};return $t(r)?n(r):n(String(r).split(e)),t},Kc=()=>{},Vc=(r,e)=>(r=+r,Number.isFinite(r)?r:e),er="abcdefghijklmnopqrstuvwxyz",Cs="0123456789",$i={DIGIT:Cs,ALPHA:er,ALPHA_DIGIT:er+er.toUpperCase()+Cs},zc=(r=16,e=$i.ALPHA_DIGIT)=>{let t="";const{length:n}=e;for(;r--;)t+=e[Math.random()*n|0];return t};function Wc(r){return!!(r&&De(r.append)&&r[Symbol.toStringTag]==="FormData"&&r[Symbol.iterator])}const Hc=r=>{const e=new Array(10),t=(n,s)=>{if(Ln(n)){if(e.indexOf(n)>=0)return;if(!("toJSON"in n)){e[s]=n;const i=$t(n)?[]:{};return qt(n,(o,a)=>{const c=t(o,s+1);!Ft(c)&&(i[a]=c)}),e[s]=void 0,i}}return n};return t(r,0)},Jc=Ye("AsyncFunction"),qc=r=>r&&(Ln(r)||De(r))&&De(r.then)&&De(r.catch),C={isArray:$t,isArrayBuffer:Oi,isBuffer:mc,isFormData:Ac,isArrayBufferView:gc,isString:vc,isNumber:Pi,isBoolean:wc,isObject:Ln,isPlainObject:yn,isUndefined:Ft,isDate:bc,isFile:xc,isBlob:Ec,isRegExp:Uc,isFunction:De,isStream:_c,isURLSearchParams:Sc,isTypedArray:$c,isFileList:kc,forEach:qt,merge:Er,extend:Oc,trim:Tc,stripBOM:Pc,inherits:Ic,toFlatObject:Rc,kindOf:jn,kindOfTest:Ye,endsWith:Cc,toArray:Nc,forEachEntry:jc,matchAll:Bc,isHTMLForm:Lc,hasOwnProperty:Rs,hasOwnProp:Rs,reduceDescriptors:Ni,freezeMethods:Fc,toObjectSet:Mc,toCamelCase:Dc,noop:Kc,toFiniteNumber:Vc,findKey:Ii,global:Ri,isContextDefined:Ci,ALPHABET:$i,generateString:zc,isSpecCompliantForm:Wc,toJSONObject:Hc,isAsyncFn:Jc,isThenable:qc};function re(r,e,t,n,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=r,this.name="AxiosError",e&&(this.code=e),t&&(this.config=t),n&&(this.request=n),s&&(this.response=s)}C.inherits(re,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:C.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const ji=re.prototype,Bi={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(r=>{Bi[r]={value:r}});Object.defineProperties(re,Bi);Object.defineProperty(ji,"isAxiosError",{value:!0});re.from=(r,e,t,n,s,i)=>{const o=Object.create(ji);return C.toFlatObject(r,o,function(c){return c!==Error.prototype},a=>a!=="isAxiosError"),re.call(o,r.message,e,t,n,s),o.cause=r,o.name=r.name,i&&Object.assign(o,i),o};const Yc=null;function kr(r){return C.isPlainObject(r)||C.isArray(r)}function Li(r){return C.endsWith(r,"[]")?r.slice(0,-2):r}function Ns(r,e,t){return r?r.concat(e).map(function(s,i){return s=Li(s),!t&&i?"["+s+"]":s}).join(t?".":""):e}function Gc(r){return C.isArray(r)&&!r.some(kr)}const Qc=C.toFlatObject(C,{},null,function(e){return/^is[A-Z]/.test(e)});function Dn(r,e,t){if(!C.isObject(r))throw new TypeError("target must be an object");e=e||new FormData,t=C.toFlatObject(t,{metaTokens:!0,dots:!1,indexes:!1},!1,function(h,m){return!C.isUndefined(m[h])});const n=t.metaTokens,s=t.visitor||l,i=t.dots,o=t.indexes,c=(t.Blob||typeof Blob!="undefined"&&Blob)&&C.isSpecCompliantForm(e);if(!C.isFunction(s))throw new TypeError("visitor must be a function");function u(d){if(d===null)return"";if(C.isDate(d))return d.toISOString();if(!c&&C.isBlob(d))throw new re("Blob is not supported. Use a Buffer instead.");return C.isArrayBuffer(d)||C.isTypedArray(d)?c&&typeof Blob=="function"?new Blob([d]):Buffer.from(d):d}function l(d,h,m){let g=d;if(d&&!m&&typeof d=="object"){if(C.endsWith(h,"{}"))h=n?h:h.slice(0,-2),d=JSON.stringify(d);else if(C.isArray(d)&&Gc(d)||(C.isFileList(d)||C.endsWith(h,"[]"))&&(g=C.toArray(d)))return h=Li(h),g.forEach(function(x,S){!(C.isUndefined(x)||x===null)&&e.append(o===!0?Ns([h],S,i):o===null?h:h+"[]",u(x))}),!1}return kr(d)?!0:(e.append(Ns(m,h,i),u(d)),!1)}const f=[],y=Object.assign(Qc,{defaultVisitor:l,convertValue:u,isVisitable:kr});function p(d,h){if(!C.isUndefined(d)){if(f.indexOf(d)!==-1)throw Error("Circular reference detected in "+h.join("."));f.push(d),C.forEach(d,function(g,w){(!(C.isUndefined(g)||g===null)&&s.call(e,g,C.isString(w)?w.trim():w,h,y))===!0&&p(g,h?h.concat(w):[w])}),f.pop()}}if(!C.isObject(r))throw new TypeError("data must be an object");return p(r),e}function $s(r){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(r).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function Mr(r,e){this._pairs=[],r&&Dn(r,this,e)}const Di=Mr.prototype;Di.append=function(e,t){this._pairs.push([e,t])};Di.toString=function(e){const t=e?function(n){return e.call(this,n,$s)}:$s;return this._pairs.map(function(s){return t(s[0])+"="+t(s[1])},"").join("&")};function Xc(r){return encodeURIComponent(r).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Ui(r,e,t){if(!e)return r;const n=t&&t.encode||Xc,s=t&&t.serialize;let i;if(s?i=s(e,t):i=C.isURLSearchParams(e)?e.toString():new Mr(e,t).toString(n),i){const o=r.indexOf("#");o!==-1&&(r=r.slice(0,o)),r+=(r.indexOf("?")===-1?"?":"&")+i}return r}class Zc{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:n?n.synchronous:!1,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){C.forEach(this.handlers,function(n){n!==null&&e(n)})}}const js=Zc,Fi={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},eu=typeof URLSearchParams!="undefined"?URLSearchParams:Mr,tu=typeof FormData!="undefined"?FormData:null,nu=typeof Blob!="undefined"?Blob:null,ru=(()=>{let r;return typeof navigator!="undefined"&&((r=navigator.product)==="ReactNative"||r==="NativeScript"||r==="NS")?!1:typeof window!="undefined"&&typeof document!="undefined"})(),su=(()=>typeof WorkerGlobalScope!="undefined"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function")(),He={isBrowser:!0,classes:{URLSearchParams:eu,FormData:tu,Blob:nu},isStandardBrowserEnv:ru,isStandardBrowserWebWorkerEnv:su,protocols:["http","https","file","blob","url","data"]};function iu(r,e){return Dn(r,new He.classes.URLSearchParams,Object.assign({visitor:function(t,n,s,i){return He.isNode&&C.isBuffer(t)?(this.append(n,t.toString("base64")),!1):i.defaultVisitor.apply(this,arguments)}},e))}function ou(r){return C.matchAll(/\w+|\[(\w*)]/g,r).map(e=>e[0]==="[]"?"":e[1]||e[0])}function au(r){const e={},t=Object.keys(r);let n;const s=t.length;let i;for(n=0;n<s;n++)i=t[n],e[i]=r[i];return e}function Mi(r){function e(t,n,s,i){let o=t[i++];const a=Number.isFinite(+o),c=i>=t.length;return o=!o&&C.isArray(s)?s.length:o,c?(C.hasOwnProp(s,o)?s[o]=[s[o],n]:s[o]=n,!a):((!s[o]||!C.isObject(s[o]))&&(s[o]=[]),e(t,n,s[o],i)&&C.isArray(s[o])&&(s[o]=au(s[o])),!a)}if(C.isFormData(r)&&C.isFunction(r.entries)){const t={};return C.forEachEntry(r,(n,s)=>{e(ou(n),s,t,0)}),t}return null}const cu={"Content-Type":void 0};function uu(r,e,t){if(C.isString(r))try{return(e||JSON.parse)(r),C.trim(r)}catch(n){if(n.name!=="SyntaxError")throw n}return(t||JSON.stringify)(r)}const Un={transitional:Fi,adapter:["xhr","http"],transformRequest:[function(e,t){const n=t.getContentType()||"",s=n.indexOf("application/json")>-1,i=C.isObject(e);if(i&&C.isHTMLForm(e)&&(e=new FormData(e)),C.isFormData(e))return s&&s?JSON.stringify(Mi(e)):e;if(C.isArrayBuffer(e)||C.isBuffer(e)||C.isStream(e)||C.isFile(e)||C.isBlob(e))return e;if(C.isArrayBufferView(e))return e.buffer;if(C.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let a;if(i){if(n.indexOf("application/x-www-form-urlencoded")>-1)return iu(e,this.formSerializer).toString();if((a=C.isFileList(e))||n.indexOf("multipart/form-data")>-1){const c=this.env&&this.env.FormData;return Dn(a?{"files[]":e}:e,c&&new c,this.formSerializer)}}return i||s?(t.setContentType("application/json",!1),uu(e)):e}],transformResponse:[function(e){const t=this.transitional||Un.transitional,n=t&&t.forcedJSONParsing,s=this.responseType==="json";if(e&&C.isString(e)&&(n&&!this.responseType||s)){const o=!(t&&t.silentJSONParsing)&&s;try{return JSON.parse(e)}catch(a){if(o)throw a.name==="SyntaxError"?re.from(a,re.ERR_BAD_RESPONSE,this,null,this.response):a}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:He.classes.FormData,Blob:He.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};C.forEach(["delete","get","head"],function(e){Un.headers[e]={}});C.forEach(["post","put","patch"],function(e){Un.headers[e]=C.merge(cu)});const Kr=Un,lu=C.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),fu=r=>{const e={};let t,n,s;return r&&r.split(`
`).forEach(function(o){s=o.indexOf(":"),t=o.substring(0,s).trim().toLowerCase(),n=o.substring(s+1).trim(),!(!t||e[t]&&lu[t])&&(t==="set-cookie"?e[t]?e[t].push(n):e[t]=[n]:e[t]=e[t]?e[t]+", "+n:n)}),e},Bs=Symbol("internals");function Lt(r){return r&&String(r).trim().toLowerCase()}function mn(r){return r===!1||r==null?r:C.isArray(r)?r.map(mn):String(r)}function hu(r){const e=Object.create(null),t=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;for(;n=t.exec(r);)e[n[1]]=n[2];return e}const du=r=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(r.trim());function tr(r,e,t,n,s){if(C.isFunction(n))return n.call(this,e,t);if(s&&(e=t),!!C.isString(e)){if(C.isString(n))return e.indexOf(n)!==-1;if(C.isRegExp(n))return n.test(e)}}function pu(r){return r.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,t,n)=>t.toUpperCase()+n)}function yu(r,e){const t=C.toCamelCase(" "+e);["get","set","has"].forEach(n=>{Object.defineProperty(r,n+t,{value:function(s,i,o){return this[n].call(this,e,s,i,o)},configurable:!0})})}class Fn{constructor(e){e&&this.set(e)}set(e,t,n){const s=this;function i(a,c,u){const l=Lt(c);if(!l)throw new Error("header name must be a non-empty string");const f=C.findKey(s,l);(!f||s[f]===void 0||u===!0||u===void 0&&s[f]!==!1)&&(s[f||c]=mn(a))}const o=(a,c)=>C.forEach(a,(u,l)=>i(u,l,c));return C.isPlainObject(e)||e instanceof this.constructor?o(e,t):C.isString(e)&&(e=e.trim())&&!du(e)?o(fu(e),t):e!=null&&i(t,e,n),this}get(e,t){if(e=Lt(e),e){const n=C.findKey(this,e);if(n){const s=this[n];if(!t)return s;if(t===!0)return hu(s);if(C.isFunction(t))return t.call(this,s,n);if(C.isRegExp(t))return t.exec(s);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=Lt(e),e){const n=C.findKey(this,e);return!!(n&&this[n]!==void 0&&(!t||tr(this,this[n],n,t)))}return!1}delete(e,t){const n=this;let s=!1;function i(o){if(o=Lt(o),o){const a=C.findKey(n,o);a&&(!t||tr(n,n[a],a,t))&&(delete n[a],s=!0)}}return C.isArray(e)?e.forEach(i):i(e),s}clear(e){const t=Object.keys(this);let n=t.length,s=!1;for(;n--;){const i=t[n];(!e||tr(this,this[i],i,e,!0))&&(delete this[i],s=!0)}return s}normalize(e){const t=this,n={};return C.forEach(this,(s,i)=>{const o=C.findKey(n,i);if(o){t[o]=mn(s),delete t[i];return}const a=e?pu(i):String(i).trim();a!==i&&delete t[i],t[a]=mn(s),n[a]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return C.forEach(this,(n,s)=>{n!=null&&n!==!1&&(t[s]=e&&C.isArray(n)?n.join(", "):n)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const n=new this(e);return t.forEach(s=>n.set(s)),n}static accessor(e){const n=(this[Bs]=this[Bs]={accessors:{}}).accessors,s=this.prototype;function i(o){const a=Lt(o);n[a]||(yu(s,o),n[a]=!0)}return C.isArray(e)?e.forEach(i):i(e),this}}Fn.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);C.freezeMethods(Fn.prototype);C.freezeMethods(Fn);const Ze=Fn;function nr(r,e){const t=this||Kr,n=e||t,s=Ze.from(n.headers);let i=n.data;return C.forEach(r,function(a){i=a.call(t,i,s.normalize(),e?e.status:void 0)}),s.normalize(),i}function Ki(r){return!!(r&&r.__CANCEL__)}function Yt(r,e,t){re.call(this,r==null?"canceled":r,re.ERR_CANCELED,e,t),this.name="CanceledError"}C.inherits(Yt,re,{__CANCEL__:!0});function mu(r,e,t){const n=t.config.validateStatus;!t.status||!n||n(t.status)?r(t):e(new re("Request failed with status code "+t.status,[re.ERR_BAD_REQUEST,re.ERR_BAD_RESPONSE][Math.floor(t.status/100)-4],t.config,t.request,t))}const gu=He.isStandardBrowserEnv?function(){return{write:function(t,n,s,i,o,a){const c=[];c.push(t+"="+encodeURIComponent(n)),C.isNumber(s)&&c.push("expires="+new Date(s).toGMTString()),C.isString(i)&&c.push("path="+i),C.isString(o)&&c.push("domain="+o),a===!0&&c.push("secure"),document.cookie=c.join("; ")},read:function(t){const n=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return n?decodeURIComponent(n[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}();function vu(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)}function wu(r,e){return e?r.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):r}function Vi(r,e){return r&&!vu(e)?wu(r,e):e}const bu=He.isStandardBrowserEnv?function(){const e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a");let n;function s(i){let o=i;return e&&(t.setAttribute("href",o),o=t.href),t.setAttribute("href",o),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:t.pathname.charAt(0)==="/"?t.pathname:"/"+t.pathname}}return n=s(window.location.href),function(o){const a=C.isString(o)?s(o):o;return a.protocol===n.protocol&&a.host===n.host}}():function(){return function(){return!0}}();function xu(r){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(r);return e&&e[1]||""}function Eu(r,e){r=r||10;const t=new Array(r),n=new Array(r);let s=0,i=0,o;return e=e!==void 0?e:1e3,function(c){const u=Date.now(),l=n[i];o||(o=u),t[s]=c,n[s]=u;let f=i,y=0;for(;f!==s;)y+=t[f++],f=f%r;if(s=(s+1)%r,s===i&&(i=(i+1)%r),u-o<e)return;const p=l&&u-l;return p?Math.round(y*1e3/p):void 0}}function Ls(r,e){let t=0;const n=Eu(50,250);return s=>{const i=s.loaded,o=s.lengthComputable?s.total:void 0,a=i-t,c=n(a),u=i<=o;t=i;const l={loaded:i,total:o,progress:o?i/o:void 0,bytes:a,rate:c||void 0,estimated:c&&o&&u?(o-i)/c:void 0,event:s};l[e?"download":"upload"]=!0,r(l)}}const ku=typeof XMLHttpRequest!="undefined",_u=ku&&function(r){return new Promise(function(t,n){let s=r.data;const i=Ze.from(r.headers).normalize(),o=r.responseType;let a;function c(){r.cancelToken&&r.cancelToken.unsubscribe(a),r.signal&&r.signal.removeEventListener("abort",a)}C.isFormData(s)&&(He.isStandardBrowserEnv||He.isStandardBrowserWebWorkerEnv?i.setContentType(!1):i.setContentType("multipart/form-data;",!1));let u=new XMLHttpRequest;if(r.auth){const p=r.auth.username||"",d=r.auth.password?unescape(encodeURIComponent(r.auth.password)):"";i.set("Authorization","Basic "+btoa(p+":"+d))}const l=Vi(r.baseURL,r.url);u.open(r.method.toUpperCase(),Ui(l,r.params,r.paramsSerializer),!0),u.timeout=r.timeout;function f(){if(!u)return;const p=Ze.from("getAllResponseHeaders"in u&&u.getAllResponseHeaders()),h={data:!o||o==="text"||o==="json"?u.responseText:u.response,status:u.status,statusText:u.statusText,headers:p,config:r,request:u};mu(function(g){t(g),c()},function(g){n(g),c()},h),u=null}if("onloadend"in u?u.onloadend=f:u.onreadystatechange=function(){!u||u.readyState!==4||u.status===0&&!(u.responseURL&&u.responseURL.indexOf("file:")===0)||setTimeout(f)},u.onabort=function(){!u||(n(new re("Request aborted",re.ECONNABORTED,r,u)),u=null)},u.onerror=function(){n(new re("Network Error",re.ERR_NETWORK,r,u)),u=null},u.ontimeout=function(){let d=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const h=r.transitional||Fi;r.timeoutErrorMessage&&(d=r.timeoutErrorMessage),n(new re(d,h.clarifyTimeoutError?re.ETIMEDOUT:re.ECONNABORTED,r,u)),u=null},He.isStandardBrowserEnv){const p=(r.withCredentials||bu(l))&&r.xsrfCookieName&&gu.read(r.xsrfCookieName);p&&i.set(r.xsrfHeaderName,p)}s===void 0&&i.setContentType(null),"setRequestHeader"in u&&C.forEach(i.toJSON(),function(d,h){u.setRequestHeader(h,d)}),C.isUndefined(r.withCredentials)||(u.withCredentials=!!r.withCredentials),o&&o!=="json"&&(u.responseType=r.responseType),typeof r.onDownloadProgress=="function"&&u.addEventListener("progress",Ls(r.onDownloadProgress,!0)),typeof r.onUploadProgress=="function"&&u.upload&&u.upload.addEventListener("progress",Ls(r.onUploadProgress)),(r.cancelToken||r.signal)&&(a=p=>{!u||(n(!p||p.type?new Yt(null,r,u):p),u.abort(),u=null)},r.cancelToken&&r.cancelToken.subscribe(a),r.signal&&(r.signal.aborted?a():r.signal.addEventListener("abort",a)));const y=xu(l);if(y&&He.protocols.indexOf(y)===-1){n(new re("Unsupported protocol "+y+":",re.ERR_BAD_REQUEST,r));return}u.send(s||null)})},gn={http:Yc,xhr:_u};C.forEach(gn,(r,e)=>{if(r){try{Object.defineProperty(r,"name",{value:e})}catch(t){}Object.defineProperty(r,"adapterName",{value:e})}});const Au={getAdapter:r=>{r=C.isArray(r)?r:[r];const{length:e}=r;let t,n;for(let s=0;s<e&&(t=r[s],!(n=C.isString(t)?gn[t.toLowerCase()]:t));s++);if(!n)throw n===!1?new re(`Adapter ${t} is not supported by the environment`,"ERR_NOT_SUPPORT"):new Error(C.hasOwnProp(gn,t)?`Adapter '${t}' is not available in the build`:`Unknown adapter '${t}'`);if(!C.isFunction(n))throw new TypeError("adapter is not a function");return n},adapters:gn};function rr(r){if(r.cancelToken&&r.cancelToken.throwIfRequested(),r.signal&&r.signal.aborted)throw new Yt(null,r)}function Ds(r){return rr(r),r.headers=Ze.from(r.headers),r.data=nr.call(r,r.transformRequest),["post","put","patch"].indexOf(r.method)!==-1&&r.headers.setContentType("application/x-www-form-urlencoded",!1),Au.getAdapter(r.adapter||Kr.adapter)(r).then(function(n){return rr(r),n.data=nr.call(r,r.transformResponse,n),n.headers=Ze.from(n.headers),n},function(n){return Ki(n)||(rr(r),n&&n.response&&(n.response.data=nr.call(r,r.transformResponse,n.response),n.response.headers=Ze.from(n.response.headers))),Promise.reject(n)})}const Us=r=>r instanceof Ze?r.toJSON():r;function It(r,e){e=e||{};const t={};function n(u,l,f){return C.isPlainObject(u)&&C.isPlainObject(l)?C.merge.call({caseless:f},u,l):C.isPlainObject(l)?C.merge({},l):C.isArray(l)?l.slice():l}function s(u,l,f){if(C.isUndefined(l)){if(!C.isUndefined(u))return n(void 0,u,f)}else return n(u,l,f)}function i(u,l){if(!C.isUndefined(l))return n(void 0,l)}function o(u,l){if(C.isUndefined(l)){if(!C.isUndefined(u))return n(void 0,u)}else return n(void 0,l)}function a(u,l,f){if(f in e)return n(u,l);if(f in r)return n(void 0,u)}const c={url:i,method:i,data:i,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(u,l)=>s(Us(u),Us(l),!0)};return C.forEach(Object.keys(Object.assign({},r,e)),function(l){const f=c[l]||s,y=f(r[l],e[l],l);C.isUndefined(y)&&f!==a||(t[l]=y)}),t}const zi="1.4.0",Vr={};["object","boolean","number","function","string","symbol"].forEach((r,e)=>{Vr[r]=function(n){return typeof n===r||"a"+(e<1?"n ":" ")+r}});const Fs={};Vr.transitional=function(e,t,n){function s(i,o){return"[Axios v"+zi+"] Transitional option '"+i+"'"+o+(n?". "+n:"")}return(i,o,a)=>{if(e===!1)throw new re(s(o," has been removed"+(t?" in "+t:"")),re.ERR_DEPRECATED);return t&&!Fs[o]&&(Fs[o]=!0,console.warn(s(o," has been deprecated since v"+t+" and will be removed in the near future"))),e?e(i,o,a):!0}};function Su(r,e,t){if(typeof r!="object")throw new re("options must be an object",re.ERR_BAD_OPTION_VALUE);const n=Object.keys(r);let s=n.length;for(;s-- >0;){const i=n[s],o=e[i];if(o){const a=r[i],c=a===void 0||o(a,i,r);if(c!==!0)throw new re("option "+i+" must be "+c,re.ERR_BAD_OPTION_VALUE);continue}if(t!==!0)throw new re("Unknown option "+i,re.ERR_BAD_OPTION)}}const _r={assertOptions:Su,validators:Vr},rt=_r.validators;class An{constructor(e){this.defaults=e,this.interceptors={request:new js,response:new js}}request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=It(this.defaults,t);const{transitional:n,paramsSerializer:s,headers:i}=t;n!==void 0&&_r.assertOptions(n,{silentJSONParsing:rt.transitional(rt.boolean),forcedJSONParsing:rt.transitional(rt.boolean),clarifyTimeoutError:rt.transitional(rt.boolean)},!1),s!=null&&(C.isFunction(s)?t.paramsSerializer={serialize:s}:_r.assertOptions(s,{encode:rt.function,serialize:rt.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let o;o=i&&C.merge(i.common,i[t.method]),o&&C.forEach(["delete","get","head","post","put","patch","common"],d=>{delete i[d]}),t.headers=Ze.concat(o,i);const a=[];let c=!0;this.interceptors.request.forEach(function(h){typeof h.runWhen=="function"&&h.runWhen(t)===!1||(c=c&&h.synchronous,a.unshift(h.fulfilled,h.rejected))});const u=[];this.interceptors.response.forEach(function(h){u.push(h.fulfilled,h.rejected)});let l,f=0,y;if(!c){const d=[Ds.bind(this),void 0];for(d.unshift.apply(d,a),d.push.apply(d,u),y=d.length,l=Promise.resolve(t);f<y;)l=l.then(d[f++],d[f++]);return l}y=a.length;let p=t;for(f=0;f<y;){const d=a[f++],h=a[f++];try{p=d(p)}catch(m){h.call(this,m);break}}try{l=Ds.call(this,p)}catch(d){return Promise.reject(d)}for(f=0,y=u.length;f<y;)l=l.then(u[f++],u[f++]);return l}getUri(e){e=It(this.defaults,e);const t=Vi(e.baseURL,e.url);return Ui(t,e.params,e.paramsSerializer)}}C.forEach(["delete","get","head","options"],function(e){An.prototype[e]=function(t,n){return this.request(It(n||{},{method:e,url:t,data:(n||{}).data}))}});C.forEach(["post","put","patch"],function(e){function t(n){return function(i,o,a){return this.request(It(a||{},{method:e,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:o}))}}An.prototype[e]=t(),An.prototype[e+"Form"]=t(!0)});const vn=An;class zr{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let t;this.promise=new Promise(function(i){t=i});const n=this;this.promise.then(s=>{if(!n._listeners)return;let i=n._listeners.length;for(;i-- >0;)n._listeners[i](s);n._listeners=null}),this.promise.then=s=>{let i;const o=new Promise(a=>{n.subscribe(a),i=a}).then(s);return o.cancel=function(){n.unsubscribe(i)},o},e(function(i,o,a){n.reason||(n.reason=new Yt(i,o,a),t(n.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}static source(){let e;return{token:new zr(function(s){e=s}),cancel:e}}}const Tu=zr;function Ou(r){return function(t){return r.apply(null,t)}}function Pu(r){return C.isObject(r)&&r.isAxiosError===!0}const Ar={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(Ar).forEach(([r,e])=>{Ar[e]=r});const Iu=Ar;function Wi(r){const e=new vn(r),t=Ti(vn.prototype.request,e);return C.extend(t,vn.prototype,e,{allOwnKeys:!0}),C.extend(t,e,null,{allOwnKeys:!0}),t.create=function(s){return Wi(It(r,s))},t}const ge=Wi(Kr);ge.Axios=vn;ge.CanceledError=Yt;ge.CancelToken=Tu;ge.isCancel=Ki;ge.VERSION=zi;ge.toFormData=Dn;ge.AxiosError=re;ge.Cancel=ge.CanceledError;ge.all=function(e){return Promise.all(e)};ge.spread=Ou;ge.isAxiosError=Pu;ge.mergeConfig=It;ge.AxiosHeaders=Ze;ge.formToJSON=r=>Mi(C.isHTMLForm(r)?new FormData(r):r);ge.HttpStatusCode=Iu;ge.default=ge;const Ru=ge,Ms={init:({API_KEY:r})=>(...i)=>k(void 0,[...i],function*(e="post",t="/",n={},s={}){var f,y,p,d;const o=localStorage.getItem("accessToken");let a={Accept:"application/json","Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Key":r,"Access-Control-Allow-Methods":"POST, GET, OPTIONS, PUT, DELETE, HEAD,PATCH","Access-Control-Allow-Headers":"X-PINGOTHER, Origin, X-Requested-With, Content-Type, Accept","Access-Control-Max-Age":"1728000"};o&&(a.Authorization="Bearer "+o);const c=t;s!=null&&s.headers&&(a=Object.assign(...a,...s.headers),delete s.headers);const u=Object.assign({mode:"cors",method:e,url:c,data:n,headers:a},s);let l={};try{const h=yield Ru(u);l.data=((f=h==null?void 0:h.data)==null?void 0:f.data)||(h==null?void 0:h.data),h!=null&&h.error&&(l.error=h.error),l.data||(l.data={})}catch(h){l.error=((p=(y=h.response)==null?void 0:y.data)==null?void 0:p.error)||((d=h.response)==null?void 0:d.error),l.error||(l.error={})}return l})};let sn;const Cu=new Uint8Array(16);function Nu(){if(!sn&&(sn=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!sn))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return sn(Cu)}const Ee=[];for(let r=0;r<256;++r)Ee.push((r+256).toString(16).slice(1));function $u(r,e=0){return(Ee[r[e+0]]+Ee[r[e+1]]+Ee[r[e+2]]+Ee[r[e+3]]+"-"+Ee[r[e+4]]+Ee[r[e+5]]+"-"+Ee[r[e+6]]+Ee[r[e+7]]+"-"+Ee[r[e+8]]+Ee[r[e+9]]+"-"+Ee[r[e+10]]+Ee[r[e+11]]+Ee[r[e+12]]+Ee[r[e+13]]+Ee[r[e+14]]+Ee[r[e+15]]).toLowerCase()}const ju=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ks={randomUUID:ju};function Bu(r,e,t){if(Ks.randomUUID&&!e&&!r)return Ks.randomUUID();r=r||{};const n=r.random||(r.rng||Nu)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){t=t||0;for(let s=0;s<16;++s)e[t+s]=n[s];return e}return $u(n)}var Lu={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(c,u,l){this.fn=c,this.context=u,this.once=l||!1}function i(c,u,l,f,y){if(typeof l!="function")throw new TypeError("The listener must be a function");var p=new s(l,f||c,y),d=t?t+u:u;return c._events[d]?c._events[d].fn?c._events[d]=[c._events[d],p]:c._events[d].push(p):(c._events[d]=p,c._eventsCount++),c}function o(c,u){--c._eventsCount===0?c._events=new n:delete c._events[u]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var u=[],l,f;if(this._eventsCount===0)return u;for(f in l=this._events)e.call(l,f)&&u.push(t?f.slice(1):f);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(l)):u},a.prototype.listeners=function(u){var l=t?t+u:u,f=this._events[l];if(!f)return[];if(f.fn)return[f.fn];for(var y=0,p=f.length,d=new Array(p);y<p;y++)d[y]=f[y].fn;return d},a.prototype.listenerCount=function(u){var l=t?t+u:u,f=this._events[l];return f?f.fn?1:f.length:0},a.prototype.emit=function(u,l,f,y,p,d){var h=t?t+u:u;if(!this._events[h])return!1;var m=this._events[h],g=arguments.length,w,x;if(m.fn){switch(m.once&&this.removeListener(u,m.fn,void 0,!0),g){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,l),!0;case 3:return m.fn.call(m.context,l,f),!0;case 4:return m.fn.call(m.context,l,f,y),!0;case 5:return m.fn.call(m.context,l,f,y,p),!0;case 6:return m.fn.call(m.context,l,f,y,p,d),!0}for(x=1,w=new Array(g-1);x<g;x++)w[x-1]=arguments[x];m.fn.apply(m.context,w)}else{var S=m.length,O;for(x=0;x<S;x++)switch(m[x].once&&this.removeListener(u,m[x].fn,void 0,!0),g){case 1:m[x].fn.call(m[x].context);break;case 2:m[x].fn.call(m[x].context,l);break;case 3:m[x].fn.call(m[x].context,l,f);break;case 4:m[x].fn.call(m[x].context,l,f,y);break;default:if(!w)for(O=1,w=new Array(g-1);O<g;O++)w[O-1]=arguments[O];m[x].fn.apply(m[x].context,w)}}return!0},a.prototype.on=function(u,l,f){return i(this,u,l,f,!1)},a.prototype.once=function(u,l,f){return i(this,u,l,f,!0)},a.prototype.removeListener=function(u,l,f,y){var p=t?t+u:u;if(!this._events[p])return this;if(!l)return o(this,p),this;var d=this._events[p];if(d.fn)d.fn===l&&(!y||d.once)&&(!f||d.context===f)&&o(this,p);else{for(var h=0,m=[],g=d.length;h<g;h++)(d[h].fn!==l||y&&!d[h].once||f&&d[h].context!==f)&&m.push(d[h]);m.length?this._events[p]=m.length===1?m[0]:m:o(this,p)}return this},a.prototype.removeAllListeners=function(u){var l;return u?(l=t?t+u:u,this._events[l]&&o(this,l)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(Lu);function sr(r,e){try{r(e)}catch(t){console.error("Error in subscription callback",t)}}const st=Symbol("subscriptions"),it=Symbol("oneTimeEvents");class Rt{constructor(){this[st]=[],this[it]=new Map}on(e,t){return this[it].has(e)?sr(t,this[it].get(e)):(this[st].push({event:e,callback:t,once:!1}),this)}off(e,t){return this[st]=this[st].filter(n=>n.event!==e||t&&n.callback!==t),this}once(e,t){return new Promise(n=>{const s=i=>{n(i),t==null||t(i)};this[it].has(e)?sr(s,this[it].get(e)):this[st].push({event:e,callback:s,once:!0})})}emit(e,t){if(this[it].has(e))throw new Error(`Event "${e}" was supposed to be emitted only once`);for(let n=0;n<this[st].length;n++){const s=this[st][n];s.event===e&&(sr(s.callback,t),s.once&&(this[st].splice(n,1),n--))}return this}emitOnce(e,t){if(this[it].has(e))throw new Error(`Event "${e}" was supposed to be emitted only once`);return this.emit(e,t),this[it].set(e,t),this.off(e),this}pipe(e,t){this.on(e,n=>{t.emit(e,n)})}pipeOnce(e,t){this.once(e,n=>{t.emitOnce(e,n)})}}function ot(r){return r=r.replace(/\[/g,"/[").replace(/^\/+/,"").replace(/\/+$/,""),r.length===0?[]:r.split("/").map(t=>t.startsWith("[")?parseInt(t.slice(1,-1)):t)}class T{static get(e){return new T(e)}static getChildPath(e,t){return T.get(e).child(t).path}static getPathKeys(e){return ot(e)}constructor(e){typeof e=="string"?this.keys=ot(e):e instanceof Array&&(this.keys=e),this.path=this.keys.reduce((t,n,s)=>s===0?`${n}`:typeof n=="string"?`${t}/${n}`:`${t}[${n}]`,"")}get key(){return this.keys.length===0?null:this.keys.slice(-1)[0]}get parent(){if(this.keys.length==0)return null;const e=this.keys.slice(0,-1);return new T(e)}get parentPath(){return this.keys.length===0?null:this.parent.path}child(e){if(typeof e=="string"){if(e.length===0)throw new Error(`child key for path "${this.path}" cannot be empty`);const t=ot(e);t.forEach(n=>{if(typeof n=="string"){if(/[\x00-\x08\x0b\x0c\x0e-\x1f/[\]\\]/.test(n))throw new Error(`Invalid child key "${n}" for path "${this.path}". Keys cannot contain control characters or any of the following characters: \\ / [ ]`);if(n.length>128)throw new Error(`child key "${n}" for path "${this.path}" is too long. Max key length is 128`);if(n.length===0)throw new Error(`child key for path "${this.path}" cannot be empty`)}}),e=t}return new T(this.keys.concat(e))}childPath(e){return this.child(e).path}get pathKeys(){return this.keys}static extractVariables(e,t){if(!e.includes("*")&&!e.includes("$"))return[];const n=ot(e),s=ot(t);let i=0;const o={get length(){return i}};return n.forEach((a,c)=>{const u=s[c];if(a==="*")o[i++]=u;else if(typeof a=="string"&&a[0]==="$"){o[i++]=u,o[a]=u;const l=a.slice(1);typeof o[l]=="undefined"&&(o[l]=u)}}),o}static fillVariables(e,t){if(e.indexOf("*")<0&&e.indexOf("$")<0)return e;const n=ot(e),s=ot(t),i=n.map((a,c)=>{if(a===s[c]||c>=s.length)return a;if(typeof a=="string"&&(a==="*"||a[0]==="$"))return s[c];throw new Error(`Path "${t}" cannot be used to fill variables of path "${e}" because they do not match`)});let o="";return i.forEach(a=>{typeof a=="number"?o+=`[${a}]`:(o.length>0&&(o+="/"),o+=a)}),o}static fillVariables2(e,t){if(typeof t!="object"||Object.keys(t).length===0)return e;const n=ot(e);let s=0;return n.reduce((o,a)=>typeof a=="string"&&(a==="*"||a.startsWith("$"))?T.getChildPath(o,t[s++]):T.getChildPath(o,a),"")}equals(e){const t=e instanceof T?e:new T(e);return this.path===t.path?!0:this.keys.length!==t.keys.length?!1:this.keys.every((n,s)=>{const i=t.keys[s];return i===n||typeof i=="string"&&(i==="*"||i[0]==="$")||typeof n=="string"&&(n==="*"||n[0]==="$")})}isAncestorOf(e){const t=e instanceof T?e:new T(e);return t.path===""||this.path===t.path?!1:this.path===""?!0:this.keys.length>=t.keys.length?!1:this.keys.every((n,s)=>{const i=t.keys[s];return i===n||typeof i=="string"&&(i==="*"||i[0]==="$")||typeof n=="string"&&(n==="*"||n[0]==="$")})}isDescendantOf(e){const t=e instanceof T?e:new T(e);return this.path===""||this.path===t.path?!1:e===""?!0:t.keys.length>=this.keys.length?!1:t.keys.every((n,s)=>{const i=this.keys[s];return i===n||typeof i=="string"&&(i==="*"||i[0]==="$")||typeof n=="string"&&(n==="*"||n[0]==="$")})}isOnTrailOf(e){const t=e instanceof T?e:new T(e);return this.path.length===0||t.path.length===0||this.path===t.path?!0:this.pathKeys.every((n,s)=>{if(s>=t.keys.length)return!0;const i=t.keys[s];return i===n||typeof i=="string"&&(i==="*"||i[0]==="$")||typeof n=="string"&&(n==="*"||n[0]==="$")})}isChildOf(e){const t=e instanceof T?e:new T(e);return this.path===""?!1:this.parent.equals(t)}isParentOf(e){const t=e instanceof T?e:new T(e);return t.path===""?!1:this.equals(t.parent)}}function ir(r,e,t=!1){if(!r.exists())return null;let n=t?r.previous():r.val();return typeof e=="number"?n[e]:(T.getPathKeys(e).every(s=>(n=n[s],typeof n!="undefined")),n||null)}function or(r){if(!r.exists())return[];const e=r.val();return e instanceof Array?new Array(e.length).map((t,n)=>n):typeof e=="object"?Object.keys(e):[]}class le{exists(){return!1}constructor(e,t,n=!1,s,i){this.ref=e,this.val=()=>t,this.previous=()=>s,this.exists=()=>n?!1:t!==null&&typeof t!="undefined",this.context=()=>i||{}}static for(e,t){return new le(e,t)}child(e){const t=ir(this,e,!1),n=ir(this,e,!0);return new le(this.ref.child(e),t,!1,n)}hasChild(e){return ir(this,e)!==null}hasChildren(){return or(this).length>0}numChildren(){return or(this).length}forEach(e){const t=this.val(),n=this.previous();return or(this).every(s=>{const i=new le(this.ref.child(s),t[s],!1,n[s]);return e(i)})}get key(){return this.ref.key}}class wn extends le{constructor(e,t,n){super(e,t,!1,void 0,n),this.previous=()=>{throw new Error("Iterate values to get previous values for each mutation")},this.val=(s=!0)=>(s&&console.warn("Unless you know what you are doing, it is best not to use the value of a mutations snapshot directly. Use child methods and forEach to iterate the mutations instead"),t)}forEach(e){return this.val(!1).every(n=>{const s=n.target.reduce((o,a)=>o.child(a),this.ref),i=new le(s,n.val,!1,n.prev);return e(i)})}child(e){if(typeof e!="number")throw new Error("child index must be a number");const t=this.val(!1)[e],n=t.target.reduce((s,i)=>s.child(i),this.ref);return new le(n,t.val,!1,t.prev)}}class Hi{constructor(e){this.stop=e,this._internal={state:"init",activatePromises:[]}}activated(e){return e&&(this._internal.activatePromises.push({callback:e}),this._internal.state==="active"?e(!0):this._internal.state==="canceled"&&e(!1,this._internal.cancelReason)),new Promise((t,n)=>{if(this._internal.state==="active")return t();if(this._internal.state==="canceled"&&!e)return n(new Error(this._internal.cancelReason));const s=()=>{};this._internal.activatePromises.push({resolve:t,reject:e?s:n})})}_setActivationState(e,t){for(this._internal.cancelReason=t,this._internal.state=e?"active":"canceled";this._internal.activatePromises.length>0;){const n=this._internal.activatePromises.shift();e?(n.callback&&n.callback(!0),n.resolve&&n.resolve()):(n.callback&&n.callback(!1,t),n.reject&&n.reject(t))}}}class Du{constructor(e,t,n){this.publish=e,this.start=t,this.cancel=n}}class Uu{constructor(e){const t=[];let n,s;const i="stopped (no more subscribers)";this.subscribe=(f,y)=>{if(typeof f!="function")throw new TypeError("callback must be a function");if(s===i)throw new Error("stream can't be used anymore because all subscribers were stopped");const p={callback:f,activationCallback:function(d,h){y==null||y(d,h),this.subscription._setActivationState(d,h)},subscription:new Hi(function(){return t.splice(t.indexOf(this),1),o()})};return t.push(p),typeof s!="undefined"&&(s===!0?(y==null||y(!0),p.subscription._setActivationState(!0)):typeof s=="string"&&(y==null||y(!1,s),p.subscription._setActivationState(!1,s))),p.subscription};const o=()=>{let f;return t.length===0&&(f=n==null?void 0:n(),s=i),Promise.resolve(f)};this.unsubscribe=f=>{(f?t.filter(p=>p.callback===f):t).forEach(p=>{const d=t.indexOf(p);t.splice(d,1)}),o()},this.stop=()=>{t.splice(0),o()};const a=f=>(t.forEach(y=>{try{y.callback(f)}catch(p){console.error(`Error running subscriber callback: ${p.message}`)}}),t.length===0&&o(),t.length>0),c=f=>{s=!0,n=f,t.forEach(y=>{var p;(p=y.activationCallback)==null||p.call(y,!0)})},u=f=>{s=f,t.forEach(y=>{var p;(p=y.activationCallback)==null||p.call(y,!1,f||new Error("unknown reason"))}),t.splice(0)},l=new Du(a,c,u);e(l)}}function Wr(r,e){const t="000000000"+r;return t.substr(t.length-e)}const Fu=typeof window=="object"?window:self,Mu=Object.keys(Fu).length;var li,fi;const Ku=(fi=(li=navigator.mimeTypes)==null?void 0:li.length)!=null?fi:0,Vu=Wr((Ku+navigator.userAgent.length).toString(36)+Mu.toString(36),4);function zu(){return Vu}let Dt=0;const Hr=4,Sn=36,Ji=Math.pow(Sn,Hr);function Vs(){return Wr((Math.random()*Ji<<0).toString(Sn),Hr)}function Wu(){return Dt=Dt<Ji?Dt:0,Dt++,Dt-1}function Hu(r=0){const e="c",t=(new Date().getTime()+r).toString(Sn),n=Wr(Wu().toString(Sn),Hr),s=zu(),i=Vs()+Vs();return e+t+n+s+i}let zs=0;class ke{static set timeBias(e){typeof e=="number"&&(zs=e)}static generate(){return Hu(zs).slice(1)}}class fe{constructor(e){this.path=e}}const Be={nextTick(r){setTimeout(r,0)}};class Tn{constructor(e){if(e instanceof Array)for(let t=0;t<e.length;t++)typeof e[t]!="undefined"&&(this[t]=e[t]);else e&&Object.assign(this,e)}}function Ju(r){const e=new Uint8Array(8);return new DataView(e.buffer).setFloat64(0,r),new Array(...e)}function qu(r){if((Array.isArray(r)?r.length:r.byteLength)!==8)throw new TypeError("must be 8 bytes");const t=new Uint8Array(r);return new DataView(t.buffer).getFloat64(0)}const ct={zero:BigInt(0),one:BigInt(1),two:BigInt(2),eight:BigInt(8),ff:BigInt(255)};function Yu(r){if(typeof r!="bigint")throw new Error("number must be a bigint");const e=[],t=r<ct.zero;do{const n=Number(r&ct.ff);e.push(n),r=r>>ct.eight}while(r!==(t?-ct.one:ct.zero));return e.reverse(),(t?e[0]<128:e[0]>=128)&&e.unshift(t?255:0),e}function Gu(r){const e=r[0]>=128;let t=ct.zero;for(let n of r)e&&(n=~n&255),t=(t<<ct.eight)+BigInt(n);return e&&(t=-(t+ct.one)),t}function Qu(r){if(typeof TextEncoder!="undefined")return new TextEncoder().encode(r);if(typeof Buffer=="function"){const e=Buffer.from(r,"utf-8");return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}else{const e=[];for(let t=0;t<r.length;t++){let n=r.charCodeAt(t);if(n>128){if((n&55296)===55296){const s=r.charCodeAt(t+1);if((s&56320)!==56320)throw new Error("follow-up utf-16 character does not start with 0xDC00");t++;const i=n&1023,o=s&1023;n=65536|i<<10|o}if(n<2048){const s=192|n>>6&31,i=128|n&63;e.push(s,i)}else if(n<65536){const s=224|n>>12&15,i=128|n>>6&63,o=128|n&63;e.push(s,i,o)}else if(n<2097152){const s=240|n>>18&7,i=128|n>>12&63,o=128|n>>6&63,a=128|n&63;e.push(s,i,o,a)}else throw new Error(`Cannot convert character ${r.charAt(t)} (code ${n}) to utf-8`)}else e.push(n<128?n:63)}return new Uint8Array(e)}}function qi(r){if(typeof TextDecoder!="undefined"){const e=new TextDecoder;if(r instanceof Uint8Array)return e.decode(r);const t=Uint8Array.from(r);return e.decode(t)}else if(typeof Buffer=="function"){if(r instanceof Array&&(r=Uint8Array.from(r)),!(r instanceof Buffer)&&"buffer"in r&&r.buffer instanceof ArrayBuffer){const e=r;r=Buffer.from(e.buffer,e.byteOffset,e.byteLength)}if(!(r instanceof Buffer))throw new Error("Unsupported buffer argument");return r.toString("utf-8")}else{if(!(r instanceof Uint8Array)&&"buffer"in r&&r.buffer instanceof ArrayBuffer){const e=r;r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}if(r instanceof Buffer||r instanceof Array||r instanceof Uint8Array){let e="";for(let t=0;t<r.length;t++){let n=r[t];if(n>128)if((n&240)===240){const s=n,i=r[t+1],o=r[t+2],a=r[t+3];n=(s&7)<<18|(i&63)<<12|(o&63)<<6|a&63,t+=3}else if((n&224)===224){const s=n,i=r[t+1],o=r[t+2];n=(s&15)<<12|(i&63)<<6|o&63,t+=2}else if((n&192)===192){const s=n,i=r[t+1];n=(s&31)<<6|i&63,t++}else throw new Error("invalid utf-8 data");if(n>=65536){n^=65536;const s=55296|n>>10,i=56320|n&1023;e+=String.fromCharCode(s),e+=String.fromCharCode(i)}else e+=String.fromCharCode(n)}return e}else throw new Error("Unsupported buffer argument")}}function Xu(r,e){const t=new r.constructor(r.length+e.length);return t.set(r),t.set(e,r.length),t}function Ve(r,e){var i;if(((i=r==null?void 0:r.constructor)==null?void 0:i.name)==="DataSnapshot")throw new TypeError(`Object to clone is a DataSnapshot (path "${r.ref.path}")`);const t=o=>(o!==null&&typeof o=="object"&&typeof o.constructor=="function"&&typeof o.constructor.name=="string"&&["Buffer","Uint8Array","Int8Array","Uint16Array","Int16Array","Uint32Array","Int32Array","BigUint64Array","BigInt64Array"].includes(o.constructor.name)&&(o=o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength)),o);if(r=t(r),typeof r!="object"||r===null||r instanceof Date||r instanceof ArrayBuffer||r instanceof fe||r instanceof RegExp)return r;const n=o=>{if(e.indexOf(o)>=0)throw new ReferenceError("object contains a circular reference");return o=t(o),o===null||o instanceof Date||o instanceof ArrayBuffer||o instanceof fe||o instanceof RegExp||typeof o=="object"&&(e.push(o),o=Ve(o,e),e.pop()),o};typeof e=="undefined"&&(e=[r]);const s=r instanceof Array?[]:r instanceof Tn?new Tn:{};return Object.keys(r).forEach(o=>{const a=r[o];typeof a!="function"&&(s[o]=n(a))}),s}const ut=r=>typeof r=="object"&&["ArrayBuffer","Buffer","Uint8Array","Uint16Array","Uint32Array","Int8Array","Int16Array","Int32Array"].includes(r.constructor.name);function On(r,e){if(r===e)return!0;if(typeof r!=typeof e)return!1;if(typeof r=="object"||typeof e=="object"){if(r===null||e===null)return!1;if(r instanceof fe||e instanceof fe)return r instanceof fe&&e instanceof fe&&r.path===e.path;if(r instanceof Date||e instanceof Date)return r instanceof Date&&e instanceof Date&&r.getTime()===e.getTime();if(r instanceof Array||e instanceof Array)return r instanceof Array&&e instanceof Array&&r.length===e.length&&r.every((s,i)=>On(r[i],e[i]));if(ut(r)||ut(e)){if(!ut(r)||!ut(e)||r.byteLength===e.byteLength)return!1;const s=r instanceof ArrayBuffer?new Uint8Array(r):new Uint8Array(r.buffer,r.byteOffset,r.byteLength),i=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength);return s.every((o,a)=>i[a]===o)}const t=Object.keys(r),n=Object.keys(e);return t.length===n.length&&t.every(s=>n.includes(s))&&t.every(s=>On(r[s],e[s]))}return!1}class Yi{constructor(e,t,n){this.added=e,this.removed=t,this.changed=n}forChild(e){if(this.added.includes(e))return"added";if(this.removed.includes(e))return"removed";const t=this.changed.find(n=>n.key===e);return t?t.change:"identical"}}function Jr(r,e,t=!1){const n=[void 0,null];if(r===e)return"identical";if(n.indexOf(r)>=0&&n.indexOf(e)<0)return"added";if(n.indexOf(r)<0&&n.indexOf(e)>=0)return"removed";if(typeof r!=typeof e)return"changed";if(ut(r)||ut(e)){if(!ut(r)||!ut(e))return"changed";const s=r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):new Uint8Array(r.buffer,r.byteOffset,r.byteLength),i=e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength);return s.byteLength===i.byteLength&&s.every((o,a)=>i[a]===o)?"identical":"changed"}else{if(r instanceof Date||e instanceof Date)return r instanceof Date&&e instanceof Date&&r.getTime()===e.getTime()?"identical":"changed";if(r instanceof fe||e instanceof fe)return r instanceof fe&&e instanceof fe&&r.path===e.path?"identical":"changed";if(typeof r=="object"){const s=r instanceof Array,i=f=>{let y=Object.keys(f).filter(p=>!n.includes(f[p]));return s&&(y=y.map(p=>parseInt(p))),y},o=i(r),a=i(e),c=o.filter(f=>!a.includes(f)),u=a.filter(f=>!o.includes(f)),l=a.reduce((f,y)=>{if(o.includes(y)){const p=r[y],d=e[y],h=Jr(p,d);h!=="identical"&&f.push({key:y,change:h})}return f},[]);return u.length===0&&c.length===0&&l.length===0?"identical":new Yi(u,c,t?l.sort((f,y)=>f.key<y.key?-1:1):l)}}return"changed"}function Gi(r,e,t=!1){const n=(i,o,a,c)=>{switch(o){case"identical":return[];case"changed":return[{target:i,prev:a,val:c}];case"added":return[{target:i,prev:null,val:c}];case"removed":return[{target:i,prev:a,val:null}];default:{let u=[];return o.added.forEach(l=>u.push({target:i.concat(l),prev:null,val:c[l]})),o.removed.forEach(l=>u.push({target:i.concat(l),prev:a[l],val:null})),o.changed.forEach(l=>{const f=n(i.concat(l.key),l.change,a[l.key],c[l.key]);u=u.concat(f)}),u}}},s=Jr(r,e,t);return n([],s,r,e)}function Zu(r,e,t){return e=e===null?null:e[r],typeof e=="undefined"&&(e=null),t=t===null?null:t[r],typeof t=="undefined"&&(t=null),{oldValue:e,newValue:t}}function el(r){Be.nextTick(r)}function Qi(){var r;return typeof globalThis!="undefined"?globalThis:typeof global!="undefined"?global:typeof window!="undefined"?window:typeof self!="undefined"?self:(r=function(){return this}())!=null?r:Function("return this")()}const Xi=Object.freeze(Object.defineProperty({__proto__:null,numberToBytes:Ju,bytesToNumber:qu,bigintToBytes:Yu,bytesToBigint:Gu,encodeString:Qu,decodeString:qi,concatTypedArrays:Xu,cloneObject:Ve,valuesAreEqual:On,ObjectDifferences:Yi,compareValues:Jr,getMutations:Gi,getChildValues:Zu,defer:el,getGlobalObject:Qi},Symbol.toStringTag,{value:"Module"})),tl="modulepreload",nl=function(r){return"/"+r},Ws={},rl=function(e,t,n){if(!t||t.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(t.map(i=>{if(i=nl(i),i in Ws)return;Ws[i]=!0;const o=i.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(!!n)for(let l=s.length-1;l>=0;l--){const f=s[l];if(f.href===i&&(!o||f.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${i}"]${a}`))return;const u=document.createElement("link");if(u.rel=o?"stylesheet":tl,o||(u.as="script",u.crossOrigin=""),u.href=i,document.head.appendChild(u),o)return new Promise((l,f)=>{u.addEventListener("load",l),u.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>e())};let Zi=!1,lt;k(void 0,null,function*(){const r=Qi();if(typeof r.Observable!="undefined"){lt=r.Observable;return}try{const{Observable:e}=yield rl(()=>Promise.resolve().then(()=>tp),void 0);lt=e}catch(e){lt=Yr}});function qr(){if(lt===Yr&&!Zi&&console.warn(`Using AceBase's simple Observable implementation because rxjs is not available. Add it to your project with "npm install rxjs", add it to AceBase using db.setObservable(Observable), or call db.setObservable("shim") to suppress this warning`),lt)return lt;throw new Error("RxJS Observable could not be loaded. ")}function sl(r){r==="shim"?(lt=Yr,Zi=!0):lt=r}class Yr{constructor(e){this._active=!1,this._subscribers=[],this._create=e}subscribe(e){if(!this._active){const i={next:o=>{this._subscribers.forEach(a=>{try{a(o)}catch(c){console.error("Error in subscriber callback:",c)}})}};this._cleanup=this._create(i),this._active=!0}return this._subscribers.push(e),{unsubscribe:()=>{this._subscribers.splice(this._subscribers.indexOf(e),1),this._subscribers.length===0&&(this._active=!1,this._cleanup())}}}}class Ne extends Array{static areEqual(e,t){return e.length===t.length&&e.every((n,s)=>t[s]===n)}static isAncestor(e,t){return e.length<t.length&&e.every((n,s)=>t[s]===n)}static isDescendant(e,t){return e.length>t.length&&t.every((n,s)=>e[s]===n)}}const dt=Symbol("isProxy");class il{static create(e,t){return k(this,null,function*(){var v;e=new ze(e.db,e.path);let n,s=!1,i=t==null?void 0:t.cursor,o;const a=ke.generate(),c=[],u=new Rt;u.on("cursor",E=>i=E),u.on("error",E=>{console.error(E.message,E.details)});const l=(E,b)=>{if(E.length===0)return n=b,!0;let A=n;const N=E.slice();for(;N.length>1;){const D=N.shift();if(!(D in A))return!1;A=A[D]}const B=N.shift();return b===null?A instanceof Array?A.splice(B,1):delete A[B]:A[B]=b,!0},f=()=>k(this,null,function*(){!s||(yield J())}),y=e.on("mutations",{syncFallback:f}).subscribe(E=>k(this,null,function*(){var D;if(!s)return;const b=E.context(),A=((D=b.acebase_proxy)==null?void 0:D.id)!==a;if(!A)return;E.val(!1).every(P=>{if(!l(P.target,P.val))return!1;const U=P.target.reduce((K,H)=>K.child(H),e),R=new le(U,P.val,!1,P.prev,E.context());return u.emit("mutation",{snapshot:R,isRemote:A}),!0})?(u.emit("cursor",b.acebase_cursor),W.emit("mutations",{origin:"remote",snap:E})):(console.warn(`Cached value of live data proxy on "${e.path}" appears outdated, will be reloaded`),yield J())}));let p=Promise.resolve();const d=[],h=[],m=()=>k(this,null,function*(){const E=[];for(let b=0,A=d[0];b<d.length;b++,A=d[b])h.find(N=>Ne.areEqual(N.target,A.target)||Ne.isAncestor(N.target,A.target))||(d.splice(b,1),b--,E.push(A));E.length!==0&&(E.forEach(b=>{b.value=Ve($e(n,b.target))}),Be.nextTick(()=>{const b={acebase_proxy:{id:a,source:"update"}};E.forEach(N=>{const B=N.target.reduce((P,U)=>P.child(U),e),D=new le(B,N.value,!1,N.previous,b);u.emit("mutation",{snapshot:D,isRemote:!1})});const A=new wn(e,E.map(N=>({target:N.target,val:N.value,prev:N.previous})),b);W.emit("mutations",{origin:"local",snap:A})}),p=E.reduce((b,A,N,B)=>(B.some(D=>Ne.isAncestor(D.target,A.target))||b.push(A),b),[]).reduce((b,A)=>{const N=A.target;if(N.length===0)b.push({ref:e,target:N,value:n,type:"set",previous:A.previous});else{const B=N.slice(0,-1),D=N.slice(-1)[0],P=B.reduce((H,te)=>H.child(te),e),U=b.find(H=>H.ref.path===P.path),R=$e(n,N),K=A.previous;U?(U.value[D]=R,U.previous[D]=K):b.push({ref:P,target:B,value:{[D]:R},type:"update",previous:{[D]:K}})}return b},[]).reduce((b,A)=>k(this,null,function*(){const N={acebase_proxy:{id:a,source:A.type}};yield b,yield A.ref.context(N)[A.type](A.value).catch(B=>{u.emit("error",{source:"update",message:`Error processing update of "/${e.path}"`,details:B});const D={acebase_proxy:{id:a,source:"update-rollback"}},P=[];if(A.type==="set"){ar(n,A.target,A.previous);const R=new le(A.ref,A.previous,!1,A.value,D);u.emit("mutation",{snapshot:R,isRemote:!1}),P.push({target:A.target,val:A.previous,prev:A.value})}else Object.keys(A.previous).forEach(R=>{ar(n,A.target.concat(R),A.previous[R]);const K=new le(A.ref.child(R),A.previous[R],!1,A.value[R],D);u.emit("mutation",{snapshot:K,isRemote:!1}),P.push({target:A.target.concat(R),val:A.previous[R],prev:A.value[R]})});P.forEach(R=>{const K=R.target.reduce((te,X)=>te.child(X),e),H=new le(K,R.val,!1,R.prev,D);u.emit("mutation",{snapshot:H,isRemote:!1})});const U=new wn(A.ref,P,D);W.emit("mutations",{origin:"local",snap:U})}),A.ref.cursor&&u.emit("cursor",A.ref.cursor)}),p),yield p)});let g=!1;const w=[],x=()=>{let E;const b=new Promise(A=>E=A);return w.push({resolve:E}),b};let S=null;const O=()=>{S||(S=setTimeout(()=>k(this,null,function*(){g=!0,S=null,yield m(),g=!1,w.splice(0).forEach(E=>E.resolve())}),0))},I=E=>{d.find(b=>Ne.areEqual(b.target,E))||d.push({target:E,previous:Ve($e(n,E))}),O()},W=new Rt,$=(E,b)=>{const A=D=>D!==null&&typeof D=="object",N=D=>k(this,null,function*(){var _e;const{snap:P,origin:U}=D,R=P.context(),K=((_e=R.acebase_proxy)==null?void 0:_e.id)===a;if(D.origin==="remote"&&K){console.error("DEV ISSUE: mutationsHandler was called from remote event originating from our own proxy");return}const H=P.val(!1).filter(ae=>ae.target.slice(0,E.length).every((ce,me)=>E[me]===ce));if(H.length===0)return;let te,X;const Z=H.find(ae=>ae.target.length<=E.length);if(Z){const ae=E.slice(Z.target.length);te=ae.reduce((ce,me)=>!A(ce)||!(me in ce)?null:ce[me],Z.val),X=ae.reduce((ce,me)=>!A(ce)||!(me in ce)?null:ce[me],Z.prev)}else{const ae=$e(n,E);te=Ve(ae),X=Ve(te),H.forEach(ce=>{const me=ce.target.slice(E.length);for(let oe=0,Se=te,ue=X;oe<me.length;oe++){const je=oe+1===me.length,Ae=me[oe];je?(Se[Ae]=ce.val,Se[Ae]===null&&delete Se[Ae],ue[Ae]=ce.prev,ue[Ae]===null&&delete ue[Ae]):(Se=Se[Ae]=Ae in Se?Se[Ae]:{},ue=ue[Ae]=Ae in ue?ue[Ae]:{})}})}Be.nextTick(()=>{let ae=!0;try{ae=b(Object.freeze(te),Object.freeze(X),!K,R)!==!1}catch(ce){u.emit("error",{source:U==="remote"?"remote_update":"local_update",message:"Error running subscription callback",details:ce})}ae===!1&&B()})});W.on("mutations",N);const B=()=>{W.off("mutations",N),c.splice(c.findIndex(D=>D.stop===B),1)};return c.push({target:E,stop:B}),{stop:B}},Y=(E,b,A)=>{if(E==="write")return I(b);if(E==="onChange")return $(b,A.callback);if(E==="subscribe"||E==="observe"){const N=D=>{const P=$e(n,b);D.next(P);const U=$(b,R=>{D.next(R)});return function(){U.stop()}};if(E==="subscribe")return N;const B=qr();return new B(N)}else if(E==="transaction")return h.some(B=>Ne.areEqual(b,B.target)||Ne.isAncestor(b,B.target)||Ne.isDescendant(b,B.target))?Promise.reject(new Error("Cannot start transaction because it conflicts with another transaction")):new Promise(B=>k(this,null,function*(){d.some(R=>Ne.areEqual(b,R.target)||Ne.isAncestor(b,R.target))&&(g||O(),yield x());const P={target:b,status:"started",transaction:null};h.push(P),P.transaction={get status(){return P.status},get completed(){return P.status!=="started"},get mutations(){return d.filter(R=>Ne.areEqual(P.target,R.target)||Ne.isAncestor(P.target,R.target))},get hasMutations(){return this.mutations.length>0},commit(){return k(this,null,function*(){if(this.completed)throw new Error(`Transaction has completed already (status '${P.status}')`);P.status="finished",h.splice(h.indexOf(P),1),g&&(yield x()),O(),yield x()})},rollback(){if(this.completed)throw new Error(`Transaction has completed already (status '${P.status}')`);P.status="canceled";const R=[];for(let K=0;K<d.length;K++){const H=d[K];(Ne.areEqual(P.target,H.target)||Ne.isAncestor(P.target,H.target))&&(d.splice(K,1),K--,R.push(H))}R.reverse().forEach(K=>{K.target.length===0?n=K.previous:ar(n,K.target,K.previous)}),h.splice(h.indexOf(P),1)}},B(P.transaction)}))},j=yield e.get({cache_mode:"allow",cache_cursor:t==null?void 0:t.cursor});if(j.context().acebase_origin!=="cache"&&u.emit("cursor",(v=e.cursor)!=null?v:null),s=!0,n=j.val(),n===null&&typeof(t==null?void 0:t.defaultValue)!="undefined"){n=t.defaultValue;const E={acebase_proxy:{id:a,source:"default"}};yield e.context(E).set(n)}o=eo({root:{ref:e,get cache(){return n}},target:[],id:a,flag:Y});const L=()=>{if(o===null)throw new Error("Proxy was destroyed")},J=()=>k(this,null,function*(){L(),d.splice(0);const E=yield e.get({allow_cache:!1}),b=n,A=E.val();n=A;const N=Gi(b,A);if(N.length===0)return;const B=E.context();B.acebase_proxy={id:a,source:"reload"},N.forEach(P=>{const U=Sr(e,P.target),R=new le(U,P.val,P.val===null,P.prev,B);u.emit("mutation",{snapshot:R,isRemote:!0})});const D=new wn(e,N,B);W.emit("mutations",{origin:"local",snap:D})});return{destroy(){return k(this,null,function*(){yield p;const E=[y.stop(),...c.map(b=>b.stop())];yield Promise.all(E),["cursor","mutation","error"].forEach(b=>u.off(b)),n=null,o=null})},stop(){this.destroy()},get value(){return L(),o},get hasValue(){return L(),n!==null},set value(E){L(),E!==null&&typeof E=="object"&&E[dt]&&(E=E.valueOf()),I([]),n=E},get ref(){return e},get cursor(){return i},reload:J,onMutation(E){L(),u.off("mutation"),u.on("mutation",({snapshot:b,isRemote:A})=>{try{E(b,A)}catch(N){u.emit("error",{source:"mutation_callback",message:"Error in dataproxy onMutation callback",details:N})}})},onError(E){L(),u.off("error"),u.on("error",b=>{try{E(b)}catch(A){console.error(`Error in dataproxy onError callback: ${A.message}`)}})},on(E,b){u.on(E,b)},off(E,b){u.off(E,b)}}})}}function $e(r,e){let t=r;for(const n of e)t=typeof t=="object"&&t!==null&&n in t?t[n]:null;return t}function ar(r,e,t){if(e.length===0)throw new Error("Cannot update root target, caller must do that itself!");const n=e.slice(0,-1).reduce((i,o)=>i[o],r),s=e.slice(-1)[0];t===null||typeof t=="undefined"?n instanceof Array?n.splice(s,1):delete n[s]:n[s]=t}function Sr(r,e){const t=T.get(r.path).childPath(e);return new ze(r.db,t)}function eo(r){const e=Sr(r.root.ref,r.target),t=[],n={get(i,o,a){if(i=$e(r.root.cache,r.target),typeof o=="symbol")if(o.toString()===Symbol.iterator.toString())o="values";else return o.toString()===dt.toString()?!0:Reflect.get(i,o,a);if(o==="valueOf")return function(){return i};if(i===null||typeof i!="object")throw new Error(`Cannot read property "${o}" of ${i}. Value of path "/${e.path}" is not an object (anymore)`);i instanceof Array&&typeof o=="string"&&/^[0-9]+$/.test(o)&&(o=parseInt(o));const c=i[o];if(c===null){delete i[o];return}const u=t.find(p=>p.prop===o);if(u){if(u.typeof===typeof c)return u.value;t.splice(t.indexOf(u),1)}const l=p=>{const d=i[p],h=t.find(g=>g.prop===p);if(h){if(h.typeof===typeof d)return h.value;t.splice(t.indexOf(h),1)}if(typeof d!="object")return d;const m=eo({root:r.root,target:r.target.concat(p),id:r.id,flag:r.flag});return t.push({typeof:typeof d,prop:p,value:m}),m},f=p=>p!==null&&typeof p=="object"&&p[dt]?p.getTarget():p;if(["string","number","boolean"].includes(typeof c)||c instanceof Date||c instanceof fe||c instanceof ArrayBuffer||typeof c=="object"&&"buffer"in c)return c;const y=i instanceof Array;if(o==="toString")return function(){return`[LiveDataProxy for "${e.path}"]`};if(typeof c=="undefined")return o==="push"?function(d){const h=e.push();return r.flag("write",r.target.concat(h.key)),i[h.key]=d,h.key}:o==="getTarget"?function(p=!0){return p&&console.warn("Use getTarget with caution - any changes will not be synchronized!"),i}:o==="getRef"?function(){return Sr(r.root.ref,r.target)}:o==="forEach"?function(d){const h=Object.keys(i);let m=!1;for(let g=0;!m&&g<h.length;g++){const w=h[g],x=l(w);m=d(x,w,g)===!1}}:["values","entries","keys"].includes(o)?function*(){const d=Object.keys(i);for(const h of d)if(o==="keys")yield h;else{const m=l(h);o==="entries"?yield[h,m]:yield m}}:o==="toArray"?function(d){const h=Object.keys(i).map(m=>l(m));return d&&h.sort(d),h}:o==="onChanged"?function(d){return r.flag("onChange",r.target,{callback:d})}:o==="subscribe"?function(){return r.flag("subscribe",r.target)}:o==="getObservable"?function(){return r.flag("observe",r.target)}:o==="getOrderedCollection"?function(d,h){return new ol(this,d,h)}:o==="startTransaction"?function(){return r.flag("transaction",r.target)}:o==="remove"&&!y?function(){if(r.target.length===0)throw new Error("Can't remove proxy root value");const d=$e(r.root.cache,r.target.slice(0,-1)),h=r.target.slice(-1)[0];r.flag("write",r.target),delete d[h]}:void 0;if(typeof c=="function"){if(y){const p=h=>(r.flag("write",r.target),h()),d=h=>h.map(m=>(m=f(m),Tr(m),m));if(o==="push")return function(...m){return m=d(m),p(()=>i.push(...m))};if(o==="pop")return function(){return p(()=>i.pop())};if(o==="splice")return function(m,g,...w){return w=d(w),p(()=>i.splice(m,g,...w))};if(o==="shift")return function(){return p(()=>i.shift())};if(o==="unshift")return function(...m){return m=d(m),p(()=>i.unshift(...m))};if(o==="sort")return function(m){return p(()=>i.sort(m))};if(o==="reverse")return function(){return p(()=>i.reverse())};if(["indexOf","lastIndexOf"].includes(o))return function(m,g){return m!==null&&typeof m=="object"&&m[dt]&&(m=m.getTarget(!1)),i[o](m,g)};if(["forEach","every","some","filter","map"].includes(o))return function(m){return i[o]((g,w)=>m(l(w),w,s))};if(["reduce","reduceRight"].includes(o))return function(m,g){return i[o]((w,x,S)=>m(w,l(S),S,s),g)};if(["find","findIndex"].includes(o))return function(m){let g=i[o]((w,x)=>m(l(x),x,s));if(o==="find"&&g){const w=i.indexOf(g);g=l(w)}return g};if(["values","entries","keys"].includes(o))return function*(){for(let m=0;m<i.length;m++)if(o==="keys")yield m;else{const g=l(m);o==="entries"?yield[m,g]:yield g}}}return c}return l(o)},set(i,o,a,c){if(i=$e(r.root.cache,r.target),typeof o=="symbol")return Reflect.set(i,o,a,c);if(i===null||typeof i!="object")throw new Error(`Cannot set property "${o}" of ${i}. Value of path "/${e.path}" is not an object`);if(i instanceof Array&&typeof o=="string"){if(!/^[0-9]+$/.test(o))throw new Error(`Cannot set property "${o}" on array value of path "/${e.path}"`);o=parseInt(o)}return a!==null&&(typeof a=="object"&&(a[dt]&&(a=a.valueOf()),a=Ve(a)),On(a,i[o]))||(r.target.some(u=>typeof u=="number")?r.flag("write",r.target.slice(0,r.target.findIndex(u=>typeof u=="number"))):i instanceof Array?r.flag("write",r.target):r.flag("write",r.target.concat(o)),a===null?delete i[o]:(Tr(a),i[o]=a)),!0},deleteProperty(i,o){if(i=$e(r.root.cache,r.target),i===null)throw new Error(`Cannot delete property ${o.toString()} of null`);return typeof o=="symbol"?Reflect.deleteProperty(i,o):(o in i&&(r.flag("write",r.target.concat(o)),delete i[o]),!0)},ownKeys(i){return i=$e(r.root.cache,r.target),Reflect.ownKeys(i)},has(i,o){return i=$e(r.root.cache,r.target),Reflect.has(i,o)},getOwnPropertyDescriptor(i,o){i=$e(r.root.cache,r.target);const a=Reflect.getOwnPropertyDescriptor(i,o);return a&&(a.configurable=!0),a},getPrototypeOf(i){return i=$e(r.root.cache,r.target),Reflect.getPrototypeOf(i)}},s=new Proxy({},n);return s}function Tr(r){typeof r=="object"&&Object.keys(r).forEach(e=>{const t=r[e];t===null||typeof t=="undefined"?delete r[e]:typeof t=="object"&&Tr(t)})}function bn(r){if(typeof r!="object"||!r[dt])throw new Error("Given value is not proxied. Make sure you are referencing the value through the live data proxy.");return r}class ol{constructor(e,t="order",n=10){if(this.collection=e,this.orderProperty=t,this.orderIncrement=n,typeof e!="object"||!e[dt])throw new Error("Collection is not proxied");if(e.valueOf()instanceof Array)throw new Error("Collection is an array, not an object collection");if(!Object.keys(e).every(i=>typeof e[i]=="object"))throw new Error("Collection has non-object children");if(!Object.keys(e).every(i=>typeof e[i][t]=="number")){const i=Object.keys(e);for(let o=0;o<i.length;o++){const a=e[i[o]];a[t]=o*n}}}getObservable(){return bn(this.collection).getObservable()}getArrayObservable(){const e=qr();return new e(t=>{const n=this.getObservable().subscribe(()=>{const s=this.getArray();t.next(s)});return function(){n.unsubscribe()}})}getArray(){return bn(this.collection).toArray((t,n)=>t[this.orderProperty]-n[this.orderProperty])}add(e,t,n){const s=this.getArray();let i=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(let u=0;u<s.length;u++){const l=s[u][this.orderProperty];i=Math.min(l,i),o=Math.max(l,o)}let a;if(typeof n=="number"){if(a=Object.keys(this.collection).find(u=>this.collection[u]===e),!a)throw new Error("item not found in collection");if(n===t)return{key:a,index:t};if(Math.abs(n-t)===1){const u=s[t],l=u[this.orderProperty];return u[this.orderProperty]=e[this.orderProperty],e[this.orderProperty]=l,{key:a,index:t}}else s.splice(n,1)}if(typeof t!="number"||t>=s.length)t=s.length,e[this.orderProperty]=s.length==0?0:o+this.orderIncrement;else if(t===0)e[this.orderProperty]=s.length==0?0:i-this.orderIncrement;else{const u=s.map(f=>f[this.orderProperty]),l=u[t]-u[t-1];if(l>1)e[this.orderProperty]=u[t]-Math.floor(l/2);else{s.splice(t,0,e);for(let f=0;f<s.length;f++)s[f][this.orderProperty]=f*this.orderIncrement}}return{key:typeof a=="string"?a:bn(this.collection).push(e),index:t}}delete(e){const n=this.getArray()[e];if(!n)throw new Error(`Item at index ${e} not found`);const s=Object.keys(this.collection).find(i=>this.collection[i]===n);if(!s)throw new Error("Cannot find target object to delete");return this.collection[s]=null,{key:s,index:e}}move(e,t){const n=this.getArray();return this.add(n[e],t,e)}sort(e){const t=this.getArray();t.sort(e);for(let n=0;n<t.length;n++)t[n][this.orderProperty]=n*this.orderIncrement}}class to{constructor(e){if(e||(e={}),typeof e.include!="undefined"&&!(e.include instanceof Array))throw new TypeError("options.include must be an array");if(typeof e.exclude!="undefined"&&!(e.exclude instanceof Array))throw new TypeError("options.exclude must be an array");if(typeof e.child_objects!="undefined"&&typeof e.child_objects!="boolean")throw new TypeError("options.child_objects must be a boolean");if(typeof e.cache_mode=="string"&&!["allow","bypass","force"].includes(e.cache_mode))throw new TypeError("invalid value for options.cache_mode");this.include=e.include||void 0,this.exclude=e.exclude||void 0,this.child_objects=typeof e.child_objects=="boolean"?e.child_objects:void 0,this.cache_mode=typeof e.cache_mode=="string"?e.cache_mode:typeof e.allow_cache=="boolean"?e.allow_cache?"allow":"bypass":"allow",this.cache_cursor=typeof e.cache_cursor=="string"?e.cache_cursor:void 0}}class al extends to{constructor(e){if(super(e),!["undefined","boolean"].includes(typeof e.snapshots))throw new TypeError("options.snapshots must be a boolean");this.snapshots=typeof e.snapshots=="boolean"?e.snapshots:!0}}const G=Symbol("private");class ze{constructor(e,t,n){this.db=e,t||(t=""),t=t.replace(/^\/|\/$/g,"");const i=T.get(t).key,o=[];this[G]={get path(){return t},get key(){return i},get callbacks(){return o},vars:n||{},context:{},pushed:!1,cursor:null}}context(e,t=!1){const n=this[G].context;if(typeof e=="object"){const s=e?t?n||{}:e:{};return e&&Object.keys(e).forEach(i=>{s[i]=e[i]}),this[G].context=s,this}else{if(typeof e=="undefined")return console.warn("Use snap.context() instead of snap.ref.context() to get updating context in event callbacks"),n;throw new Error("Invalid context argument")}}get cursor(){return this[G].cursor}set cursor(e){var t;this[G].cursor=e,(t=this.onCursor)==null||t.call(this,e)}get path(){return this[G].path}get key(){const e=this[G].key;return typeof e=="number"?`[${e}]`:e}get index(){const e=this[G].key;if(typeof e!="number")throw new Error(`"${e}" is not a number`);return e}get parent(){const e=T.fillVariables2(this.path,this.vars),t=T.get(e);return t.parentPath===null?null:new ze(this.db,t.parentPath).context(this[G].context)}get vars(){return this[G].vars}child(e){e=typeof e=="number"?e:e.replace(/^\/|\/$/g,"");const t=T.fillVariables2(this.path,this.vars),n=T.getChildPath(t,e);return new ze(this.db,n).context(this[G].context)}set(e,t){return k(this,null,function*(){try{if(this.isWildcardPath)throw new Error(`Cannot set the value of wildcard path "/${this.path}"`);if(this.parent===null)throw new Error("Cannot set the root object. Use update, or set individual child properties");if(typeof e=="undefined")throw new TypeError(`Cannot store undefined value in "/${this.path}"`);this.db.isReady||(yield this.db.ready()),e=this.db.types.serialize(this.path,e);const{cursor:n}=yield this.db.api.set(this.path,e,{context:this[G].context});if(this.cursor=n,typeof t=="function")try{t(null,this)}catch(s){console.error("Error in onComplete callback:",s)}}catch(n){if(typeof t=="function")try{t(n,this)}catch(s){console.error("Error in onComplete callback:",s)}else throw n}return this})}update(e,t){return k(this,null,function*(){try{if(this.isWildcardPath)throw new Error(`Cannot update the value of wildcard path "/${this.path}"`);if(this.db.isReady||(yield this.db.ready()),typeof e!="object"||e instanceof Array||e instanceof ArrayBuffer||e instanceof Date)yield this.set(e);else if(Object.keys(e).length===0)console.warn(`update called on path "/${this.path}", but there is nothing to update`);else{e=this.db.types.serialize(this.path,e);const{cursor:n}=yield this.db.api.update(this.path,e,{context:this[G].context});this.cursor=n}if(typeof t=="function")try{t(null,this)}catch(n){console.error("Error in onComplete callback:",n)}}catch(n){if(typeof t=="function")try{t(n,this)}catch(s){console.error("Error in onComplete callback:",s)}else throw n}return this})}transaction(e){return k(this,null,function*(){if(this.isWildcardPath)throw new Error(`Cannot start a transaction on wildcard path "/${this.path}"`);this.db.isReady||(yield this.db.ready());let t;const n=i=>{i=this.db.types.deserialize(this.path,i);const o=new le(this,i);let a;try{a=e(o)}catch(c){t=c;return}return a instanceof Promise?a.then(c=>this.db.types.serialize(this.path,c)).catch(c=>{t=c}):this.db.types.serialize(this.path,a)},{cursor:s}=yield this.db.api.transaction(this.path,n,{context:this[G].context});if(this.cursor=s,t)throw t;return this})}on(e,t,n){this.path===""&&["value","child_changed"].includes(e)&&console.warn("WARNING: Listening for value and child_changed events on the root node is a bad practice. These events require loading of all data (value event), or potentially lots of data (child_changed event) each time they are fired");let s=null;const i=new Uu(c=>{s=c}),o={event:e,stream:i,userCallback:typeof t=="function"&&t,ourCallback:(c,u,l,f,y)=>{if(c){this.db.debug.error(`Error getting data for event ${e} on path "${u}"`,c);return}const p=this.db.ref(u);p[G].vars=T.extractVariables(this.path,u);let d;if(e.startsWith("notify_"))d=p.context(y||{});else{const h={previous:this.db.types.deserialize(u,f),current:this.db.types.deserialize(u,l)};if(e==="child_removed")d=new le(p,h.previous,!0,h.previous,y);else if(e==="mutations")d=new wn(p,h.current,y);else{const m=e==="mutated"&&h.current===null;d=new le(p,h.current,m,h.previous,y)}}s.publish(d),y!=null&&y.acebase_cursor&&(this.cursor=y.acebase_cursor)}};this[G].callbacks.push(o);const a=()=>{typeof t=="function"&&i.subscribe(t,(y,p)=>{y||n&&n(p)});const c=typeof t=="object"?t:{newOnly:!t};typeof c.newOnly!="boolean"&&(c.newOnly=!1),this.isWildcardPath&&(c.newOnly=!0);const u=y=>{const p=this[G].callbacks;p.splice(p.indexOf(o),1),this.db.api.unsubscribe(this.path,e,o.ourCallback),this.db.debug.error(`Subscription "${e}" on path "/${this.path}" canceled because of an error: ${y.message}`),s.cancel(y.message)},l=this.db.api.subscribe(this.path,e,o.ourCallback,{newOnly:c.newOnly,cancelCallback:u,syncFallback:c.syncFallback}),f=()=>{const y=this[G].callbacks;return y.splice(y.indexOf(o),1),this.db.api.unsubscribe(this.path,e,o.ourCallback)};if(l instanceof Promise?l.then(()=>{s.start(f)}).catch(u):s.start(f),!c.newOnly){if(e==="value")this.get(y=>{s.publish(y)});else if(e==="child_added")this.get(y=>{const p=y.val();p===null||typeof p!="object"||Object.keys(p).forEach(d=>{const h=new le(this.child(d),p[d]);s.publish(h)})});else if(e==="notify_child_added"){let d=0;const h=()=>k(this,null,function*(){const m=yield this.db.api.reflect(this.path,"children",{limit:100,skip:d});m.list.forEach(g=>{const w=this.child(g.key);s.publish(w)}),m.more&&(d+=100,h())});h()}}};return this.db.isReady?a():this.db.ready(a),i}off(e,t){const s=this[G].callbacks.filter(i=>(!e||i.event===e)&&(!t||i.userCallback===t));return s.length===0&&this.db.debug.warn(`Can't find event subscriptions to stop (path: "${this.path}", event: ${e||"(any)"}, callback: ${t})`),s.forEach(i=>{i.stream.stop()}),this}get(e,t){if(!this.db.isReady){const i=this.db.ready().then(()=>this.get(e,t));return typeof e!="function"&&typeof t!="function"?i:void 0}if(t=typeof e=="function"?e:typeof t=="function"?t:void 0,this.isWildcardPath){const i=new Error(`Cannot get value of wildcard path "/${this.path}". Use .query() instead`);if(typeof t=="function")throw i;return Promise.reject(i)}const n=new to(typeof e=="object"?e:{cache_mode:"allow"}),s=this.db.api.get(this.path,n).then(i=>{var u;"context"in i&&"value"in i||(console.warn("AceBase api.get method returned an old response value. Update your acebase or acebase-client package"),i={value:i,context:{}});const a=this.db.types.deserialize(this.path,i.value),c=new le(this,a,void 0,void 0,i.context);return(u=i.context)!=null&&u.acebase_cursor&&(this.cursor=i.context.acebase_cursor),c});if(t){s.then(t).catch(i=>{console.error("Uncaught error:",i)});return}else return s}once(e,t){return e==="value"&&!this.isWildcardPath?this.get(t):new Promise(n=>{const s=i=>{this.off(e,s),n(i)};this.on(e,s)})}push(e,t){if(this.isWildcardPath){const i=new Error(`Cannot push to wildcard path "/${this.path}"`);if(typeof e=="undefined"||typeof t=="function")throw i;return Promise.reject(i)}const n=ke.generate(),s=this.child(n);return s[G].pushed=!0,typeof e!="undefined"?s.set(e,t).then(()=>s):s}remove(){return k(this,null,function*(){if(this.isWildcardPath)throw new Error(`Cannot remove wildcard path "/${this.path}". Use query().remove instead`);if(this.parent===null)throw new Error("Cannot remove the root node");return this.set(null)})}exists(){return k(this,null,function*(){if(this.isWildcardPath)throw new Error(`Cannot check wildcard path "/${this.path}" existence`);return this.db.isReady||(yield this.db.ready()),this.db.api.exists(this.path)})}get isWildcardPath(){return this.path.indexOf("*")>=0||this.path.indexOf("$")>=0}query(){return new no(this)}count(){return k(this,null,function*(){return(yield this.reflect("info",{child_count:!0})).children.count})}reflect(e,t){return k(this,null,function*(){if(this.isWildcardPath)throw new Error(`Cannot reflect on wildcard path "/${this.path}"`);return this.db.isReady||(yield this.db.ready()),this.db.api.reflect(this.path,e,t)})}export(n){return k(this,arguments,function*(e,t={format:"json",type_safe:!0}){if(this.isWildcardPath)throw new Error(`Cannot export wildcard path "/${this.path}"`);this.db.isReady||(yield this.db.ready());const s=typeof e=="function"?e:e.write.bind(e);return this.db.api.export(this.path,s,t)})}import(n){return k(this,arguments,function*(e,t={format:"json",suppress_events:!1}){if(this.isWildcardPath)throw new Error(`Cannot import to wildcard path "/${this.path}"`);return this.db.isReady||(yield this.db.ready()),this.db.api.import(this.path,e,t)})}proxy(e){const t=typeof e=="object"&&(typeof e.cursor!="undefined"||typeof e.defaultValue!="undefined");return typeof e!="undefined"&&!t&&(this.db.debug.warn("Warning: live data proxy is being initialized with a deprecated method signature. Use ref.proxy(options) instead of ref.proxy(defaultValue)"),e={defaultValue:e}),il.create(this,e)}observe(e){if(e)throw new Error("observe does not support data retrieval options yet");if(this.isWildcardPath)throw new Error(`Cannot observe wildcard path "/${this.path}"`);const t=qr();return new t(n=>{let s,i=!1,o=this.get(e).then(c=>{i=!0,s=c.val(),n.next(s)});const a=c=>{if(!i){o=o.then(()=>a(c));return}const u=c.ref.path;if(u===this.path)return s=c.val(),n.next(s);const l=T.getPathKeys(u).slice(T.getPathKeys(this.path).length);let f=s;for(;l.length>1;){const d=l.shift();d in f||(f[d]=typeof l[0]=="number"?[]:{}),f=f[d]}const y=l.shift(),p=c.val();p===null?f instanceof Array&&typeof y=="number"?f.splice(y,1):delete f[y]:f[y]=p,n.next(s)};return this.on("mutated",a),()=>{this.off("mutated",a)}})}forEach(e,t){return k(this,null,function*(){let n;if(typeof e=="function"?t=e:n=e,typeof t!="function")throw new TypeError("No callback function given");const s=yield this.reflect("children",{limit:0,skip:0}),i={canceled:!1,total:s.list.length,processed:0};for(let o=0;o<s.list.length;o++){const a=s.list[o].key,c=yield this.child(a).get(n);if(i.processed++,!c.exists())continue;if((yield t(c))===!1){i.canceled=!0;break}}return i})}getMutations(e){return k(this,null,function*(){const t=typeof e=="string"?e:void 0,n=e===null||typeof e=="undefined"?0:e instanceof Date?e.getTime():void 0;return this.db.api.getMutations({path:this.path,cursor:t,timestamp:n})})}getChanges(e){return k(this,null,function*(){const t=typeof e=="string"?e:void 0,n=e===null||typeof e=="undefined"?0:e instanceof Date?e.getTime():void 0;return this.db.api.getChanges({path:this.path,cursor:t,timestamp:n})})}}class no{constructor(e){this.ref=e,this[G]={filters:[],skip:0,take:0,order:[],events:{}}}filter(e,t,n){if((t==="in"||t==="!in")&&(!(n instanceof Array)||n.length===0))throw new Error(`${t} filter for ${e} must supply an Array compare argument containing at least 1 value`);if((t==="between"||t==="!between")&&(!(n instanceof Array)||n.length!==2))throw new Error(`${t} filter for ${e} must supply an Array compare argument containing 2 values`);if((t==="matches"||t==="!matches")&&!(n instanceof RegExp))throw new Error(`${t} filter for ${e} must supply a RegExp compare argument`);return this[G].filters.push({key:e,op:t,compare:n}),this}where(e,t,n){return this.filter(e,t,n)}take(e){return this[G].take=e,this}skip(e){return this[G].skip=e,this}sort(e,t=!0){if(!["string","number"].includes(typeof e))throw"key must be a string or number";return this[G].order.push({key:e,ascending:t}),this}order(e,t=!0){return this.sort(e,t)}get(e,t){if(!this.ref.db.isReady){const i=this.ref.db.ready().then(()=>this.get(e,t));return typeof e!="function"&&typeof t!="function"?i:void 0}t=typeof e=="function"?e:typeof t=="function"?t:void 0;const n=new al(typeof e=="object"?e:{snapshots:!0,cache_mode:"allow"});n.allow_cache=n.cache_mode!=="bypass",n.eventHandler=i=>{if(!this[G].events[i.name])return!1;const o=this[G].events[i.name];if(typeof o!="object"||o.length===0)return!1;if(["add","change","remove"].includes(i.name)){const a={name:i.name,ref:new ze(this.ref.db,i.path)};if(n.snapshots&&i.name!=="remove"){const c=s.types.deserialize(i.path,i.value);a.snapshot=new le(a.ref,c,!1)}i=a}o.forEach(a=>{var c,u;try{a(i)}catch(l){this.ref.db.debug.error(`Error executing "${i.name}" event handler of realtime query on path "${this.ref.path}": ${(u=(c=l==null?void 0:l.stack)!=null?c:l==null?void 0:l.message)!=null?u:l}`)}})},n.monitor={add:!1,change:!1,remove:!1},this[G].events&&(this[G].events.add&&this[G].events.add.length>0&&(n.monitor.add=!0),this[G].events.change&&this[G].events.change.length>0&&(n.monitor.change=!0),this[G].events.remove&&this[G].events.remove.length>0&&(n.monitor.remove=!0)),this.stop();const s=this.ref.db;return s.api.query(this.ref.path,this[G],n).catch(i=>{throw new Error(i)}).then(i=>{const{stop:o}=i;let{results:a,context:c}=i;if(this.stop=()=>k(this,null,function*(){yield o()}),"results"in i&&"context"in i||(console.warn("Query results missing context. Update your acebase and/or acebase-client packages"),a=i,c={}),n.snapshots){const u=a.map(l=>{const f=s.types.deserialize(l.path,l.val);return new le(s.ref(l.path),f,!1,void 0,c)});return Mn.from(u)}else{const u=a.map(l=>s.ref(l));return Gr.from(u)}}).then(i=>(t&&t(i),i))}stop(){return k(this,null,function*(){})}getRefs(e){return this.get({snapshots:!1},e)}find(){return this.get({snapshots:!1})}count(){return k(this,null,function*(){return(yield this.find()).length})}exists(){return k(this,null,function*(){const e=this[G].take,t=this.take(1).find();return this.take(e),(yield t).length!==0})}remove(e){return k(this,null,function*(){const t=yield this.find(),n=t.reduce((a,c)=>{const u=a[c.parent.path];return u?u.push(c):a[c.parent.path]=[c],a},{}),s=this.ref.db,i=Object.keys(n).map(a=>k(this,null,function*(){const c=t.reduce((l,f)=>(l[f.key]=null,l),{}),u=s.ref(a);try{return yield u.update(c),{ref:u,success:!0}}catch(l){return{ref:u,success:!1,error:l}}})),o=yield Promise.all(i);return e&&e(o),o})}on(e,t){return this[G].events[e]||(this[G].events[e]=[]),this[G].events[e].push(t),this}off(e,t){if(typeof e=="undefined")return this[G].events={},this;if(!this[G].events[e])return this;if(typeof t=="undefined")return delete this[G].events[e],this;const n=this[G].events[e].indexOf(t);return~n?(this[G].events[e].splice(n,1),this):this}forEach(e,t){return k(this,null,function*(){let n;if(typeof e=="function"?t=e:n=e,typeof t!="function")throw new TypeError("No callback function given");const s=yield this.find(),i={canceled:!1,total:s.length,processed:0};for(let o=0;o<s.length;o++){const c=yield s[o].get(n);if(i.processed++,!c.exists())continue;if((yield t(c))===!1){i.canceled=!0;break}}return i})}}class Mn extends Array{static from(e){const t=new Mn(e.length);return e.forEach((n,s)=>t[s]=n),t}getValues(){return this.map(e=>e.val())}}class Gr extends Array{static from(e){const t=new Gr(e.length);return e.forEach((n,s)=>t[s]=n),t}getPaths(){return this.map(e=>e.path)}}function cl(r,e){e=e.replace(/^\/|\/$/g,"");const t=T.getPathKeys(e),n=Object.keys(r).find(i=>{const o=T.getPathKeys(i);return o.length!==t.length?!1:o.every((a,c)=>a==="*"||typeof a=="string"&&a[0]==="$"?!0:a===t[c])});return r[n]}function ul(r,e){const t=T.get(e).parentPath;if(t!==null)return cl(r,t)}function ll(r,e){e=e.replace(/^\/|\/$/g,"");const n=T.get(e).parentPath,s=n?T.getPathKeys(n):[];return Object.keys(r).reduce((o,a)=>{const c=T.getPathKeys(a);if(c.length<s.length)return o;let u=!0;if(s.length===0&&n!==null?u=c.length===1&&(c[0]==="*"||typeof c[0]=="string"&&c[0][0]==="$"):c.every((l,f)=>f>=s.length?!1:l==="*"||typeof l=="string"&&l[0]==="$"||l===s[f]?!0:(u=!1,!1)),u){const l=r[a];o.push({path:a,type:l})}return o},[])}function Hs(r,e,t,n,s){if(n===null||typeof n!="object")return n;const i=T.getPathKeys(t),o=ll(e,t),a=[];return o.sort((c,u)=>T.getPathKeys(c.path).length>T.getPathKeys(u.path).length?-1:1),o.forEach(c=>{const u=T.getPathKeys(c.path);u.push("*");const l=u.slice(i.length);if(l.length===0){const y=T.extractVariables(c.path,t),p=new ze(r,t,y);if(s==="serialize")n=c.type.serialize(n,p);else if(s==="deserialize"){const d=new le(p,n);n=c.type.deserialize(d)}return}const f=(y,p,d)=>{if(n===null||typeof n!="object")return n;const h=d[0];let m=[];if(h==="*"||typeof h=="string"&&h[0]==="$")p instanceof Array?m=p.map((g,w)=>({key:w,val:g})):m=Object.keys(p).map(g=>({key:g,val:p[g]}));else{const g=p[h];typeof g=="object"&&m.push({key:h,val:g})}m.forEach(g=>{const w=T.getChildPath(y,g.key),x=T.extractVariables(c.path,w),S=new ze(r,w,x);if(d.length===1){if(s==="serialize")a.push({parent:p,key:g.key,original:p[g.key]}),p[g.key]=c.type.serialize(g.val,S);else if(s==="deserialize"){const O=new le(S,g.val);p[g.key]=c.type.deserialize(O)}}else f(w,g.val,d.slice(1))})};f(t,n,l)}),s==="serialize"&&(n=Ve(n),a.length>0&&a.forEach(c=>{c.parent[c.key]=c.original})),n}const At=Symbol("mappings");class ro{constructor(e){this.db=e,this[At]={}}get mappings(){return this[At]}map(e){return ul(this[At],e)}bind(e,t,n={}){if(typeof e!="string")throw new TypeError("path must be a string");if(typeof t!="function")throw new TypeError("constructor must be a function");if(typeof n.serializer!="undefined"){if(typeof n.serializer=="string")if(typeof t.prototype[n.serializer]=="function")n.serializer=t.prototype[n.serializer];else throw new TypeError(`${t.name}.prototype.${n.serializer} is not a function, cannot use it as serializer`);else if(typeof n.serializer!="function")throw new TypeError(`serializer for class ${t.name} must be a function, or the name of a prototype method`)}if(typeof n.creator=="undefined")typeof t.create=="function"&&(n.creator=t.create);else if(typeof n.creator=="string")if(typeof t[n.creator]=="function")n.creator=t[n.creator];else throw new TypeError(`${t.name}.${n.creator} is not a function, cannot use it as creator`);else if(typeof n.creator!="function")throw new TypeError(`creator for class ${t.name} must be a function, or the name of a static method`);e=e.replace(/^\/|\/$/g,""),this[At][e]={db:this.db,type:t,creator:n.creator,serializer:n.serializer,deserialize(s){let i;return this.creator?i=this.creator.call(this.type,s):i=new this.type(s),i},serialize(s,i){return this.serializer?s=this.serializer.call(s,i,s):s&&typeof s.serialize=="function"&&(s=s.serialize(i,s)),s}}}serialize(e,t){return Hs(this.db,this[At],e,t,"serialize")}deserialize(e,t){return Hs(this.db,this[At],e,t,"deserialize")}}const on=()=>{};class so{constructor(e="log",t=""){this.level=e,this.prefix=t,this.setLevel(e)}setLevel(e){const t=this.prefix?this.prefix+" %s":"";this.verbose=["verbose"].includes(e)?t?console.log.bind(console,t):console.log.bind(console):on,this.log=["verbose","log"].includes(e)?t?console.log.bind(console,t):console.log.bind(console):on,this.warn=["verbose","log","warn"].includes(e)?t?console.warn.bind(console,t):console.warn.bind(console):on,this.error=["verbose","log","warn","error"].includes(e)?t?console.error.bind(console,t):console.error.bind(console):on,this.write=n=>{const s=typeof Be!="undefined"&&Be.env&&typeof{}.RUNKIT_ENDPOINT_PATH=="string";n&&s?n.split(`
`).forEach(i=>console.log(i)):console.log(n)}}}const Js={bold:1,dim:2,italic:3,underline:4,inverse:7,hidden:8,strikethrough:94},qs={black:30,red:31,green:32,yellow:33,blue:34,magenta:35,cyan:36,white:37,grey:90,brightRed:91},Ys={bgBlack:40,bgRed:41,bgGreen:42,bgYellow:43,bgBlue:44,bgMagenta:45,bgCyan:46,bgWhite:47,bgGrey:100,bgBrightRed:101},an={all:0,color:39,background:49,bold:22,dim:22,italic:23,underline:24,inverse:27,hidden:28,strikethrough:29};var be;(function(r){r.reset="reset",r.bold="bold",r.dim="dim",r.italic="italic",r.underline="underline",r.inverse="inverse",r.hidden="hidden",r.strikethrough="strikethrough",r.black="black",r.red="red",r.green="green",r.yellow="yellow",r.blue="blue",r.magenta="magenta",r.cyan="cyan",r.grey="grey",r.bgBlack="bgBlack",r.bgRed="bgRed",r.bgGreen="bgGreen",r.bgYellow="bgYellow",r.bgBlue="bgBlue",r.bgMagenta="bgMagenta",r.bgCyan="bgCyan",r.bgWhite="bgWhite",r.bgGrey="bgGrey"})(be||(be={}));function io(){if(typeof Be=="undefined"||!Be.stdout||!Be.env||!Be.platform||Be.platform==="browser")return!1;if(Be.platform==="win32")return!0;const r=Be.env;return r.COLORTERM?!0:r.TERM==="dumb"?!1:r.CI||r.TEAMCITY_VERSION?!!r.TRAVIS:!!(["iTerm.app","HyperTerm","Hyper","MacTerm","Apple_Terminal","vscode"].includes(r.TERM_PROGRAM)||/^xterm-256|^screen|^xterm|^vt100|color|ansi|cygwin|linux/i.test(r.TERM))}let oo=io();function fl(r){oo=io()&&r}function hl(r,e){if(!oo)return r;const t=[],n=[],s=a=>{a===be.reset?t.push(an.all):a in Js?(t.push(Js[a]),n.push(an[a])):a in qs?(t.push(qs[a]),n.push(an.color)):a in Ys&&(t.push(Ys[a]),n.push(an.background))};e instanceof Array?e.forEach(s):s(e);const i=t.map(a=>"\x1B["+a+"m").join(""),o=n.map(a=>"\x1B["+a+"m").join("");return r.split(`
`).map(a=>i+a+o).join(`
`)}String.prototype.colorize=function(r){return hl(this,r)};class ao{constructor(e){this.logLevel="log",this.logColors=!0,this.info="realtime database",this.sponsor=!1,typeof e!="object"&&(e={}),typeof e.logLevel=="string"&&(this.logLevel=e.logLevel),typeof e.logColors=="boolean"&&(this.logColors=e.logColors),typeof e.info=="string"&&(this.info=e.info),typeof e.sponsor=="boolean"&&(this.sponsor=e.sponsor)}}class dl extends Rt{constructor(e,t={}){super(),this._ready=!1,t=new ao(t),this.name=e,this.debug=new so(t.logLevel,`[${e}]`),fl(t.logColors);const n=[be.magenta,be.bold],s=`     ___          ______                
    / _ \\         | ___ \\               
   / /_\\ \\ ___ ___| |_/ / __ _ ___  ___ 
   |  _  |/ __/ _ \\ ___ \\/ _\` / __|/ _ \\
   | | | | (_|  __/ |_/ / (_| \\__ \\  __/
   \\_| |_/\\___\\___\\____/ \\__,_|___/\\___|`,i=t.info?"".padStart(40-t.info.length," ")+t.info+`
`:"";t.sponsor||(this.debug.write(s.colorize(n)),i&&this.debug.write(i.colorize(be.magenta))),this.types=new ro(this),this.once("ready",()=>{this._ready=!0})}ready(e){return k(this,null,function*(){this._ready||(yield new Promise(t=>this.on("ready",t))),e==null||e()})}get isReady(){return this._ready}setObservable(e){sl(e)}ref(e){return new ze(this,e)}get root(){return this.ref("")}query(e){const t=new ze(this,e);return new no(t)}get indexes(){return{get:()=>this.api.getIndexes(),create:(e,t,n)=>this.api.createIndex(e,t,n),delete:e=>k(this,null,function*(){return this.api.deleteIndex(e)})}}get schema(){return{get:e=>this.api.getSchema(e),set:(e,t,n=!1)=>this.api.setSchema(e,t,n),all:()=>this.api.getSchemas(),check:(e,t,n)=>this.api.validateSchema(e,t,n)}}}class he extends Error{constructor(e){super(`${e} is not implemented`)}}class pl extends Rt{constructor(){super()}stats(e){throw new he("stats")}subscribe(e,t,n,s){throw new he("subscribe")}unsubscribe(e,t,n){throw new he("unsubscribe")}update(e,t,n){throw new he("update")}set(e,t,n){throw new he("set")}get(e,t){throw new he("get")}transaction(e,t,n){throw new he("transaction")}exists(e){throw new he("exists")}query(e,t,n){throw new he("query")}reflect(e,t,n){throw new he("reflect")}export(e,t,n){throw new he("export")}import(e,t,n){throw new he("import")}createIndex(e,t,n){throw new he("createIndex")}getIndexes(){throw new he("getIndexes")}deleteIndex(e){throw new he("deleteIndex")}setSchema(e,t,n){throw new he("setSchema")}getSchema(e){throw new he("getSchema")}getSchemas(){throw new he("getSchemas")}validateSchema(e,t,n){throw new he("validateSchema")}getMutations(e){throw new he("getMutations")}getChanges(e){throw new he("getChanges")}}function Gs(r,e,t){const n=[0,0,0,0,0];for(let s=0;s<e;s+=4){let i=((r[s]*256+r[s+1])*256+r[s+2])*256+r[s+3];if(!i)t.push("z");else{for(let o=0;o<5;n[o++]=i%85+33,i=Math.floor(i/85));t.push(String.fromCharCode(n[4],n[3],n[2],n[1],n[0]))}}}function yl(r){const e=r,t=[],n=e.length%4,s=e.length-n;if(Gs(e,s,t),n){const o=new Uint8Array(4);o.set(e.slice(s),0),Gs(o,4,t);let a=t.pop();a=="z"&&(a="!!!!!"),t.push(a.substr(0,n+1))}let i=t.join("");return i="<~"+i+"~>",i}const Xe={encode:function(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r,0,r.byteLength)),yl(r)},decode:function(r){if(!r.startsWith("<~")||!r.endsWith("~>"))throw new Error("Invalid input string");r=r.substr(2,r.length-4);const e=r.length,t=[],n=[0,0,0,0,0];let s,i,o,a;for(let u=0;u<e;++u){if(r.charAt(u)=="z"){t.push(0,0,0,0);continue}for(let l=0;l<5;++l)n[l]=r.charCodeAt(u+l)-33;if(a=e-u,a<5){for(let l=a;l<4;n[++l]=0);n[a]=85}s=(((n[0]*85+n[1])*85+n[2])*85+n[3])*85+n[4],i=s&255,s>>>=8,o=s&255,s>>>=8,t.push(s>>>8,s&255,o,i);for(let l=a;l<5;++l,t.pop());u+=4}const c=new Uint8Array(t);return c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength)}},ml=r=>{if(r.map===null||typeof r.map=="undefined"){if(typeof r.val=="undefined")throw new Error("serialized value must have a val property");return r.val}const e=(t,n)=>t==="date"?new Date(n):t==="binary"?Xe.decode(n):t==="reference"?new fe(n):t==="regexp"?new RegExp(n.pattern,n.flags):t==="array"?new Tn(n):t==="bigint"?BigInt(n):n;return typeof r.map=="string"?e(r.map,r.val):(Object.keys(r.map).forEach(t=>{const n=r.map[t],s=T.getPathKeys(t);let i=r,o="val",a=r.val;s.forEach(c=>{o=c,i=a,a=a[o]}),i[o]=e(n,a)}),r.val)},co=r=>{var s;if(r===null||typeof r!="object"||r instanceof Date||r instanceof ArrayBuffer||r instanceof fe||r instanceof RegExp){const i=co({value:r});return{map:(s=i.map)==null?void 0:s.value,val:i.val.value}}r=Ve(r);const e=(i,o,a)=>{i instanceof Tn&&(o[a]="array"),Object.keys(i).forEach(c=>{const u=i[c],l=a.length===0?c:`${a}/${c}`;typeof u=="bigint"?(i[c]=u.toString(),o[l]="bigint"):u instanceof Date?(i[c]=u.toISOString(),o[l]="date"):u instanceof ArrayBuffer?(i[c]=Xe.encode(u),o[l]="binary"):u instanceof fe?(i[c]=u.path,o[l]="reference"):u instanceof RegExp?(i[c]={pattern:u.source,flags:u.flags},o[l]="regexp"):typeof u=="object"&&u!==null&&e(u,o,l)})},t={};e(r,t,"");const n={val:r};return Object.keys(t).length>0&&(n.map=t),n},Qs=r=>r>0?Date.now()+r*1e3:1/0;class gl{get size(){return this.cache.size}constructor(e){var n;if(this.enabled=!0,typeof e=="number"&&(e={expirySeconds:e}),e.cloneValues=e.cloneValues!==!1,typeof e.expirySeconds!="number"&&typeof e.maxEntries!="number")throw new Error("Either expirySeconds or maxEntries must be specified");this.options=e,this.cache=new Map;const t=setInterval(()=>{this.cleanUp()},60*1e3);(n=t.unref)==null||n.call(t)}has(e){return this.enabled?this.cache.has(e):!1}get(e){if(!this.enabled)return null;const t=this.cache.get(e);return t?(t.expires=Qs(this.options.expirySeconds),t.accessed=Date.now(),this.options.cloneValues?Ve(t.value):t.value):null}set(e,t){if(this.options.maxEntries>0&&this.cache.size>=this.options.maxEntries&&!this.cache.has(e)){let n=null;const s=Date.now();for(const[i,o]of this.cache.entries()){if(o.expires<=s){this.cache.delete(i),n=null;break}(!n||o.accessed<n.accessed)&&(n={key:i,accessed:o.accessed})}n!==null&&this.cache.delete(n.key)}this.cache.set(e,{value:this.options.cloneValues?Ve(t):t,added:Date.now(),accessed:Date.now(),expires:Qs(this.options.expirySeconds)})}remove(e){this.cache.delete(e)}cleanUp(){const e=Date.now();this.cache.forEach((t,n)=>{t.expires<=e&&this.cache.delete(n)})}}function vl(r){let e=0;function t(){let a;for(;a=r[e],[" ","\r",`
`,"	"].includes(a);)e++}function n(a){if(r[e]!==a)throw new Error(`Unexpected character at position ${e}. Expected: '${a}', found '${r[e]}'`);e++}function s(){t();const a={name:"",optional:!1,wildcard:!1};let c;for(;c=r[e],c==="_"||c==="$"||c>="a"&&c<="z"||c>="A"&&c<="Z"||a.name.length>0&&c>="0"&&c<="9"||a.name.length===0&&c==="*";)a.name+=c,e++;if(a.name.length===0)throw new Error(`Property name expected at position ${e}, found: ${r.slice(e,e+10)}..`);return r[e]==="?"&&(a.optional=!0,e++),(a.name==="*"||a.name[0]==="$")&&(a.optional=!0,a.wildcard=!0),t(),n(":"),a}function i(){t();let a={typeOf:"any"},c,u="";for(;c=r[e],c>="a"&&c<="z"||c>="A"&&c<="Z";)u+=c,e++;if(u.length===0)if(r[e]==="*")n("*"),a.typeOf="any";else if(["'",'"',"`"].includes(r[e])){a.typeOf="string",a.value="";const l=r[e];for(n(l);c=r[e],c&&c!==l;)a.value+=c,e++;n(l)}else if(r[e]>="0"&&r[e]<="9"){a.typeOf="number";let l="";for(;c=r[e],c==="."||c==="n"||c>="0"&&c<="9";)l+=c,e++;l.endsWith("n")?a.value=BigInt(l):l.includes(".")?a.value=parseFloat(l):a.value=parseInt(l)}else if(r[e]==="{"){for(n("{"),a.typeOf="object",a.instanceOf=Object,a.children=[];;){const l=s(),f=o();if(a.children.push({name:l.name,optional:l.optional,wildcard:l.wildcard,types:f}),t(),(r[e]===";"||r[e]===",")&&(n(r[e]),t()),r[e]==="}")break}n("}")}else if(r[e]==="/"){n("/");let l="",f="";for(;c=r[e],c!=="/"||l.endsWith("\\");)l+=c,e++;for(n("/");c=r[e],["g","i","m","s","u","y","d"].includes(c);)f+=c,e++;a.typeOf="string",a.matches=new RegExp(l,f)}else throw new Error(`Expected a type definition at position ${e}, found character '${r[e]}'`);else if(["string","number","boolean","bigint","undefined","String","Number","Boolean","BigInt"].includes(u))a.typeOf=u.toLowerCase();else if(u==="Object"||u==="object")a.typeOf="object",a.instanceOf=Object;else if(u==="Date")a.typeOf="object",a.instanceOf=Date;else if(u==="Binary"||u==="binary")a.typeOf="object",a.instanceOf=ArrayBuffer;else if(u==="any")a.typeOf="any";else if(u==="null")a.typeOf="object",a.value=null;else if(u==="Array")n("<"),a.typeOf="object",a.instanceOf=Array,a.genericTypes=o(),n(">");else if(["true","false"].includes(u))a.typeOf="boolean",a.value=u==="true";else throw new Error(`Unknown type at position ${e}: "${a}"`);for(t();r[e]==="[";)n("["),n("]"),a={typeOf:"object",instanceOf:Array,genericTypes:[a]};return a}function o(){t();const a=[i()];for(;r[e]==="|";)n("|"),a.push(i()),t();return a}return i()}function wl(r,e,t,n){const s=e.find(f=>f.name==="*"||f.name[0]==="$")?[]:Object.keys(t).filter(f=>![null,void 0].includes(t[f])&&!e.find(y=>y.name===f));if(s.length>0)return{ok:!1,reason:`Object at path "${r}" cannot have propert${s.length===1?"y":"ies"} ${s.map(f=>`"${f}"`).join(", ")}`};function i(f){const y=![null,void 0].includes(t[f.name]);return!f.optional&&(n?t[f.name]===null:!y)?{ok:!1,reason:`Property at path "${r}/${f.name}" is not optional`}:y&&f.types.length===1?Mt(`${r}/${f.name}`,f.types[0],t[f.name],!1):y&&!f.types.some(p=>Mt(`${r}/${f.name}`,p,t[f.name],!1).ok)?{ok:!1,reason:`Property at path "${r}/${f.name}" does not match any of ${f.types.length} allowed types`}:{ok:!0}}const o=e.filter(f=>!f.wildcard),a=o.find(f=>!i(f).ok);if(a)return{ok:!1,reason:i(a).reason};const c=e.find(f=>f.wildcard);if(!c)return{ok:!0};const u=Object.keys(t).filter(f=>!o.find(y=>y.name===f));let l={ok:!0};for(let f=0;f<u.length&&l.ok;f++){const y=u[f];l=i({name:y,types:c.types,optional:!0,wildcard:!0})}return l}function Mt(r,e,t,n,s){const i={ok:!0};if(e.typeOf==="any")return i;if(s instanceof Array&&s.length>0){if(e.typeOf!=="object")return{ok:!1,reason:`path "${r}" must be typeof ${e.typeOf}`};if(!e.children)return i;const o=s[0];let a=e.children.find(u=>u.name===o);if(a||(a=e.children.find(u=>u.name==="*"||u.name[0]==="$")),!a)return{ok:!1,reason:`Object at path "${r}" cannot have property "${o}"`};if(a.optional&&t===null&&s.length===1)return i;let c;return a.types.some(u=>{const l=typeof o=="number"?`${r}[${o}]`:`${r}/${o}`;return c=Mt(l,u,t,n,s.slice(1)),c.ok}),c}return t===null?i:e.instanceOf===Object&&(typeof t!="object"||t instanceof Array||t instanceof Date)?{ok:!1,reason:`path "${r}" must be an object collection`}:e.instanceOf&&(typeof t!="object"||t.constructor!==e.instanceOf)?{ok:!1,reason:`path "${r}" must be an instance of ${e.instanceOf.name}`}:"value"in e&&t!==e.value?{ok:!1,reason:`path "${r}" must be value: ${e.value}`}:typeof t!==e.typeOf?{ok:!1,reason:`path "${r}" must be typeof ${e.typeOf}`}:e.instanceOf===Array&&e.genericTypes&&!t.every(o=>e.genericTypes.some(a=>Mt(r,a,o,!1).ok))?{ok:!1,reason:`every array value of path "${r}" must match one of the specified types`}:e.typeOf==="object"&&e.children?wl(r,e.children,t,n):e.matches&&!e.matches.test(t)?{ok:!1,reason:`path "${r}" must match regular expression /${e.matches.source}/${e.matches.flags}`}:i}function bl(r){switch(r){case String:return"string";case Number:return"number";case Boolean:return"boolean";case Date:return"Date";case BigInt:return"bigint";case Array:throw new Error("Schema error: Array cannot be used without a type. Use string[] or Array<string> instead");default:throw new Error(`Schema error: unknown type used: ${r.name}`)}}class xl{constructor(e,t={warnOnly:!1}){if(this.handling=t,this.source=e,typeof e=="object"){const n=s=>"{"+Object.keys(s).map(i=>{let o=s[i];if(o===void 0)o="undefined";else if(o instanceof RegExp)o=`/${o.source}/${o.flags}`;else if(typeof o=="object")o=n(o);else if(typeof o=="function")o=bl(o);else if(!["string","number","boolean","bigint"].includes(typeof o))throw new Error(`Type definition for key "${i}" must be a string, number, boolean, bigint, object, regular expression, or one of these classes: String, Number, Boolean, Date, BigInt`);return`${i}:${o}`}).join(",")+"}";this.text=n(e)}else if(typeof e=="string")this.text=e;else throw new Error("Type definiton must be a string or an object");this.type=vl(this.text)}check(e,t,n,s){const i=Mt(e,this.type,t,n,s);return!i.ok&&this.handling.warnOnly&&(i.warning=`${n?"Partial schema":"Schema"} check on path "${e}"${s?` for child "${s.join("/")}"`:""} failed: ${i.reason}`,i.ok=!0,this.handling.warnCallback(i.warning)),i}}class Pe{constructor(e="browser"){throw new Error(`This feature is not supported in ${e} context`)}}class cr extends Pe{}class Or extends Pe{}class Xs extends Pe{}class El extends Pe{}class Zs extends Pe{}class kl extends Pe{}const _l={OBJECT:1,ARRAY:2,NUMBER:3,BOOLEAN:4,STRING:5,BIGINT:7,DATETIME:6,BINARY:8,REFERENCE:9},F=_l;function Al(r){switch(r){case F.ARRAY:return"array";case F.BINARY:return"binary";case F.BOOLEAN:return"boolean";case F.DATETIME:return"date";case F.NUMBER:return"number";case F.OBJECT:return"object";case F.REFERENCE:return"reference";case F.STRING:return"string";case F.BIGINT:return"bigint"}}class uo{constructor(e){if(this.path=e.path,this.type=e.type,this.index=e.index,this.key=e.key,this.exists=e.exists,this.address=e.address,this.value=e.value,this.childCount=e.childCount,typeof this.path=="string"&&typeof this.key=="undefined"&&typeof this.index=="undefined"){const t=T.get(this.path);typeof t.key=="number"?this.index=t.key:this.key=t.key}typeof this.exists=="undefined"&&(this.exists=!0)}get valueType(){return this.type}get valueTypeName(){return Al(this.valueType)}toString(){return this.exists?this.address?`"${this.path}" is ${this.valueTypeName} stored at ${this.address.toString()}`:`"${this.path}" is ${this.valueTypeName} with value ${this.value}`:`"${this.path}" doesn't exist`}}function Te(r,e){if(!r)throw new Error(`Assertion failed: ${e!=null?e:"check your code"}`)}const Sl=120,Oe={PENDING:"pending",LOCKED:"locked",EXPIRED:"expired",DONE:"done"};class lo{constructor(e,t=Sl){this._locks=[],this._lastTid=0,this.debug=e,this.timeout=t*1e3}setTimeout(e){this.timeout=e*1e3}createTid(){return ke.generate()}_allowLock(e,t,n){const s=this._locks.find(i=>i.tid!==t&&i.state===Oe.LOCKED&&(n||i.forWriting));return{allow:!s,conflict:s}}quit(){return new Promise(e=>{if(this._locks.length===0)return e();this._quit=e})}_rejectLock(e,t){this._locks.splice(this._locks.indexOf(e),1),clearTimeout(e.timeout);try{e.reject(t)}catch(n){console.error("Unhandled promise rejection:",n)}}_processLockQueue(){if(this._quit){const t=new Error("Quitting");this._locks.filter(n=>n.state===Oe.PENDING).forEach(n=>this._rejectLock(n,t)),this._locks.length===0&&this._quit()}this._locks.filter(t=>t.state===Oe.PENDING).sort((t,n)=>t.priority&&!n.priority?-1:!t.priority&&n.priority?1:t.requested-n.requested).forEach(t=>{const n=this._allowLock(t.path,t.tid,t.forWriting);t.waitingFor=n.conflict||null,n.allow&&this.lock(t).then(t.resolve).catch(s=>this._rejectLock(t,s))})}lock(o,a){return k(this,arguments,function*(e,t,n=!0,s="",i={withPriority:!1,noTimeout:!1}){let c,u;if(e instanceof ur)c=e,u=!0;else{if(this._locks.findIndex(l=>l.tid===t&&l.state===Oe.EXPIRED)>=0)throw new Error(`lock on tid ${t} has expired, not allowed to continue`);if(this._quit&&!i.withPriority)throw new Error("Quitting");{c=new ur(this,e,t,n,i.withPriority===!0),c.comment=s,this._locks.push(c);const l=this._allowLock(e,t,n);c.waitingFor=l.conflict||null,u=l.allow}}if(u){if(c.state=Oe.LOCKED,typeof c.granted!="number"){if(c.granted=Date.now(),i.noTimeout!==!0){c.expires=Date.now()+this.timeout;let l=0;const f=()=>{if(c.state===Oe.LOCKED){if(l++,l<=3){this.debug.warn(`${c.forWriting?"write":"read"} lock on path "/${c.path}" by tid ${c.tid} (${c.comment}) is taking a long time to complete [${l}]`),c.timeout=setTimeout(f,this.timeout/4);return}this.debug.error(`lock :: ${c.forWriting?"write":"read"} lock on path "/${c.path}" by tid ${c.tid} (${c.comment}) took too long`),c.state=Oe.EXPIRED,this._processLockQueue()}};c.timeout=setTimeout(f,this.timeout/4)}}return c}else return Te(c.state===Oe.PENDING),new Promise((l,f)=>{c.resolve=l,c.reject=f})})}unlock(e,t,n=!0){let s,i;if(e instanceof ur)s=e,i=this._locks.indexOf(s);else{const o=e;i=this._locks.findIndex(a=>a.id===o),s=this._locks[i]}if(i<0){const o=`lock on "/${s.path}" for tid ${s.tid} wasn't found; ${t}`;throw new Error(o)}return s.state=Oe.DONE,clearTimeout(s.timeout),this._locks.splice(i,1),n&&this._processLockQueue(),s}list(){return this._locks||[]}isAllowed(e,t,n){return this._allowLock(e,t,n).allow}}let Tl=0;class ur{static get LOCK_STATE(){return Oe}constructor(e,t,n,s,i=!1){this.locker=e,this.path=t,this.tid=n,this.forWriting=s,this.priority=i,this.state=Oe.PENDING,this.requested=Date.now(),this.comment="",this.waitingFor=null,this.id=++Tl,this.history=[]}release(e){return k(this,null,function*(){return this.history.push({action:"release",path:this.path,forWriting:this.forWriting,comment:e}),this.locker.unlock(this,e||this.comment)})}moveToParent(){return k(this,null,function*(){const e=T.get(this.path).parentPath;if(this.locker.isAllowed(e,this.tid,this.forWriting))return this.history.push({path:this.path,forWriting:this.forWriting,action:"moving to parent"}),this.waitingFor=null,this.path=e,this;{this.locker.unlock(this,`moveLockToParent: ${this.comment}`,!1);const n=yield this.locker.lock(e,this.tid,this.forWriting,this.comment,{withPriority:!0});return n.history=this.history,n.history.push({path:this.path,forWriting:this.forWriting,action:"moving to parent through queue (priority)"}),n}})}}class Qr extends Error{}class Pr extends Error{}class Ol extends Error{constructor(e){super(`Exiting: ${e}`)}}class Pl extends Rt{get isMaster(){return this.masterPeerId===this.id}constructor(e,t,n=e.name){super(),this.storage=e,this.id=t,this.dbname=n,this.ipcType="ipc",this.ourSubscriptions=[],this.remoteSubscriptions=[],this.peers=[],this._exiting=!1,this._locks=[],this._requests=new Map,this._eventsEnabled=!0,this._nodeLocker=new lo(e.debug,e.settings.lockTimeout),e.on("subscribe",s=>{if(e.debug.verbose(`database subscription being added on peer ${this.id}`),this.remoteSubscriptions.find(c=>c.callback===s.callback))return;const o=this.ourSubscriptions.some(c=>c.event===s.event&&c.path===s.path);if(this.ourSubscriptions.push(s),o)return;const a={type:"subscribe",from:this.id,data:{path:s.path,event:s.event}};this.sendMessage(a)}),e.on("unsubscribe",s=>{const i=this.remoteSubscriptions.find(o=>o.callback===s.callback);if(i){this.remoteSubscriptions.splice(this.remoteSubscriptions.indexOf(i),1);return}this.ourSubscriptions.filter(o=>o.path===s.path&&(!s.event||o.event===s.event)&&(!s.callback||o.callback===s.callback)).forEach(o=>{this.ourSubscriptions.splice(this.ourSubscriptions.indexOf(o),1);const a={type:"unsubscribe",from:this.id,data:{path:o.path,event:o.event}};this.sendMessage(a)})})}exit(e=0){return k(this,null,function*(){if(this._exiting)return this.once("exit");this._exiting=!0,this.storage.debug.warn(`Received ${this.isMaster?"master":"worker "+this.id} process exit request`),this._locks.length>0&&(this.storage.debug.warn(`Waiting for ${this.isMaster?"master":"worker"} ${this.id} locks to clear`),yield this.once("locks-cleared")),this.sayGoodbye(this.id),this.storage.debug.warn(`${this.isMaster?"Master":"Worker "+this.id} will now exit`),this.emitOnce("exit",e)})}sayGoodbye(e){const t={type:"bye",from:e,data:void 0};this.sendMessage(t)}addPeer(e,t=!0){if(this._exiting)return;if(this.peers.find(s=>s.id===e)||this.peers.push({id:e,lastSeen:Date.now()}),t){const s={type:"hello",from:this.id,to:e,data:void 0};this.sendMessage(s),this.ourSubscriptions.forEach(i=>{const o={type:"subscribe",from:this.id,to:e,data:{path:i.path,event:i.event}};this.sendMessage(o)})}}removePeer(e,t=!1){if(this._exiting)return;const n=this.peers.find(i=>i.id===e);if(!n){if(!t)throw new Error("We are supposed to know this peer!");return}this.peers.splice(this.peers.indexOf(n),1),this.remoteSubscriptions.filter(i=>i.for===e).forEach(i=>{this.remoteSubscriptions.splice(this.remoteSubscriptions.indexOf(i),1),this.storage.subscriptions.remove(i.path,i.event,i.callback)})}addRemoteSubscription(e,t){if(this._exiting||this.remoteSubscriptions.some(s=>s.for===e&&s.event===t.event&&s.path===t.path))return;const n=(s,i,o,a,c)=>{const u={type:"event",from:this.id,to:e,path:t.path,event:t.event,data:{path:i,val:o,previous:a,context:c}};this.sendMessage(u)};this.remoteSubscriptions.push({for:e,event:t.event,path:t.path,callback:n}),this.storage.subscriptions.add(t.path,t.event,n)}cancelRemoteSubscription(e,t){const n=this.remoteSubscriptions.find(s=>s.for===e&&s.event===t.event&&s.path===t.event);!n||this.storage.subscriptions.remove(t.path,t.event,n.callback)}handleMessage(e){return k(this,null,function*(){switch(e.type){case"hello":return this.addPeer(e.from,e.to!==this.id);case"bye":return this.removePeer(e.from,!0);case"subscribe":return this.addRemoteSubscription(e.from,e.data);case"unsubscribe":return this.cancelRemoteSubscription(e.from,e.data);case"event":{if(!this._eventsEnabled)break;const t=e,n=t.data.context||{};n.acebase_ipc={type:this.ipcType,origin:t.from},this.ourSubscriptions.filter(i=>i.event===t.event&&i.path===t.path).forEach(i=>{i.callback(null,t.data.path,t.data.val,t.data.previous,n)});break}case"lock-request":{if(!this.isMaster)throw new Error("Workers are not supposed to receive lock requests!");const t=e,n={type:"lock-result",id:t.id,from:this.id,to:t.from,ok:!0,data:void 0};try{const s=yield this.lock(t.data);n.data={id:s.id,path:s.path,tid:s.tid,write:s.forWriting,expires:s.expires,comment:s.comment}}catch(s){n.ok=!1,n.reason=s.stack||s.message||s}return this.sendMessage(n)}case"lock-result":{if(this.isMaster)throw new Error("Masters are not supposed to receive results for lock requests!");const t=e,n=this._requests.get(t.id);if(typeof n!="object")throw new Error("The request must be known to us!");t.ok?n.resolve(t.data):n.reject(new Error(t.reason));return}case"unlock-request":{if(!this.isMaster)throw new Error("Workers are not supposed to receive unlock requests!");const t=e,n={type:"unlock-result",id:t.id,from:this.id,to:t.from,ok:!0,data:{id:t.data.id}};try{yield this._locks.find(i=>{var o;return((o=i.lock)==null?void 0:o.id)===t.data.id}).lock.release()}catch(s){n.ok=!1,n.reason=s.stack||s.message||s}return this.sendMessage(n)}case"unlock-result":{if(this.isMaster)throw new Error("Masters are not supposed to receive results for unlock requests!");const t=e,n=this._requests.get(t.id);if(typeof n!="object")throw new Error("The request must be known to us!");t.ok?n.resolve(t.data):n.reject(new Error(t.reason));return}case"move-lock-request":{if(!this.isMaster)throw new Error("Workers are not supposed to receive move lock requests!");const t=e,n={type:"lock-result",id:t.id,from:this.id,to:t.from,ok:!0,data:void 0};try{let s;const i=this._locks.find(o=>{var a;return((a=o.lock)==null?void 0:a.id)===t.data.id});if(t.data.move_to==="parent")s=yield i.lock.moveToParent();else throw new Error(`Unknown lock move_to "${t.data.move_to}"`);i.lock=s,n.data={id:s.id,path:s.path,tid:s.tid,write:s.forWriting,expires:s.expires,comment:s.comment}}catch(s){n.ok=!1,n.reason=s.stack||s.message||s}return this.sendMessage(n)}case"notification":return this.emit("notification",e);case"request":return this.emit("request",e);case"result":{const t=e,n=this._requests.get(t.id);if(typeof n!="object")throw new Error("Result of unknown request received");t.ok?n.resolve(t.data):n.reject(new Error(t.reason))}}})}lock(e){return k(this,null,function*(){if(this._exiting&&!this._locks.find(s=>s.tid===e.tid&&s.granted))throw new Ol("new transaction lock denied because the IPC peer is exiting");const t=n=>{this._locks.splice(this._locks.indexOf(n),1),this._locks.length===0&&this.emit("locks-cleared")};if(this.isMaster){const n={tid:e.tid,granted:!1,request:e,lock:null};this._locks.push(n);const s=yield this._nodeLocker.lock(e.path,e.tid,e.write,e.comment);n.tid=s.tid,n.granted=!0;const i=o=>({get id(){return o.id},get tid(){return o.tid},get path(){return o.path},get forWriting(){return o.forWriting},get expires(){return o.expires},get comment(){return o.comment},get state(){return o.state},release:()=>k(this,null,function*(){yield o.release(),t(n)}),moveToParent:()=>k(this,null,function*(){const a=yield o.moveToParent();return n.lock=i(a),n.lock})});return n.lock=i(s),n.lock}else{const n={tid:e.tid,granted:!1,request:e,lock:null};this._locks.push(n);const s=c=>(n.granted=!0,n.tid=c.tid,n.lock={id:c.id,tid:c.tid,path:c.path,forWriting:c.write,state:Oe.LOCKED,expires:c.expires,comment:c.comment,release:()=>k(this,null,function*(){const u={type:"unlock-request",id:ke.generate(),from:this.id,to:this.masterPeerId,data:{id:n.lock.id}};yield this.request(u),n.lock.state=Oe.DONE,this.storage.debug.verbose(`Worker ${this.id} released lock ${n.lock.id} (tid ${n.lock.tid}, ${n.lock.comment}, "/${n.lock.path}", ${n.lock.forWriting?"write":"read"})`),t(n)}),moveToParent:()=>k(this,null,function*(){const u={type:"move-lock-request",id:ke.generate(),from:this.id,to:this.masterPeerId,data:{id:n.lock.id,move_to:"parent"}};let l;try{l=yield this.request(u)}catch(f){throw n.lock.state=Oe.DONE,t(n),f}return n.lock=s(l),n.lock})},n.lock),i={type:"lock-request",id:ke.generate(),from:this.id,to:this.masterPeerId,data:e};let o,a;try{o=yield this.request(i)}catch(c){a=c,o=null}if(a)throw t(n),a;return s(o)}})}request(e){return k(this,null,function*(){let t,n;const s=new Promise((i,o)=>{t=a=>{this._requests.delete(e.id),i(a)},n=a=>{this._requests.delete(e.id),o(a)}});return this._requests.set(e.id,{resolve:t,reject:n,request:e}),this.sendMessage(e),s})}sendRequest(e){const t={type:"request",from:this.id,to:this.masterPeerId,id:ke.generate(),data:e};return this.request(t).catch(n=>{throw this.storage.debug.error(n),n})}replyRequest(e,t){const n={type:"result",id:e.id,ok:!0,from:this.id,to:e.from,data:t};this.sendMessage(n)}sendNotification(e){const t={type:"notification",from:this.id,data:e};this.sendMessage(t)}get eventsEnabled(){return this._eventsEnabled}set eventsEnabled(e){this.storage.debug.log(`ipc events ${e?"enabled":"disabled"}`),this._eventsEnabled=e}}class Il extends Pl{constructor(e){if(super(e,ke.generate()),this.masterPeerId=this.id,this.ipcType="browser.bcc",window.addEventListener("beforeunload",()=>{this.exit()}),typeof window.BroadcastChannel!="undefined")this.channel=new BroadcastChannel(`acebase:${e.name}`);else{const n=[null],s=()=>{throw new Error("Not implemented")};this.channel={name:`acebase:${e.name}`,postMessage:i=>{const o=ke.generate(),a=`acebase:${e.name}:${this.id}:${o}`,c=JSON.stringify(co(i));localStorage.setItem(a,c),setTimeout(()=>localStorage.removeItem(a),10)},set onmessage(i){n[0]=i},set onmessageerror(i){s()},close(){s()},addEventListener(i,o){i!=="message"&&s(),n.push(o)},removeEventListener(i,o){const a=n.indexOf(o);a>=1&&n.splice(a,1)},dispatchEvent(i){return n.forEach(o=>{try{o&&o(i)}catch(a){console.error(a)}}),!0}},window.addEventListener("storage",i=>{const[o,a,c,u]=i.key.split(":");if(o!=="acebase"||a!==e.name||c===this.id||i.newValue===null)return;const l=ml(JSON.parse(i.newValue));this.channel.dispatchEvent({data:l})})}this.channel.addEventListener("message",n=>k(this,null,function*(){const s=n.data;if(!(s.to&&s.to!==this.id)){if(e.debug.verbose("[BroadcastChannel] received: ",s),s.type==="hello"&&s.from<this.masterPeerId)this.masterPeerId=s.from,e.debug.log(`[BroadcastChannel] Tab ${this.masterPeerId} is the master.`);else if(s.type==="bye"&&s.from===this.masterPeerId){e.debug.log(`[BroadcastChannel] Master tab ${this.masterPeerId} is leaving`);const i=this.peers.map(a=>a.id).concat(this.id).filter(a=>a!==this.masterPeerId);this.masterPeerId=i.sort()[0],e.debug.log(`[BroadcastChannel] ${this.masterPeerId===this.id?"We are":`tab ${this.masterPeerId} is`} the new master. Requesting ${this._locks.length} locks (${this._locks.filter(a=>!a.granted).length} pending)`);const o=this._locks.splice(0);yield Promise.all(o.filter(a=>a.granted).map(a=>k(this,null,function*(){let c,u;a.lock.release=()=>new Promise(f=>c=f),a.lock.moveToParent=()=>new Promise(f=>u=f);const l=yield this.lock({path:a.lock.path,write:a.lock.forWriting,tid:a.lock.tid,comment:a.lock.comment});if(u){const f=yield l.moveToParent();u(f)}c&&(yield l.release(),c())}))),yield Promise.all(o.filter(a=>!a.granted).map(a=>k(this,null,function*(){yield this.lock(a.request)})))}return this.handleMessage(s)}}));const t={type:"hello",from:this.id,data:void 0};this.sendMessage(t)}sendMessage(e){this.storage.debug.verbose("[BroadcastChannel] sending: ",e),this.channel.postMessage(e)}}class St{static get hasFileSystem(){return!1}static get fs(){return null}}class Xr extends Pe{}class fo extends Pe{}class Rl extends Pe{}class Cl extends Pe{}function Nl(r,e,t,n){return k(this,null,function*(){if(!r.storage.indexes.supported)throw new Error("Indexes are not supported in current environment because it requires Node.js fs");const{ipc:s,debug:i,indexes:o,storage:a}=r,c=n&&n.rebuild===!0,u=n&&n.type||"normal";let l=n&&n.include||[];typeof l=="string"&&(l=[l]);const f=o.find(p=>p.path===e&&p.key===t&&p.type===u&&p.includeKeys.length===l.length&&p.includeKeys.every((d,h)=>l[h]===d));if(f&&n.config&&(f.config=n.config),f&&c!==!0)return i.log(`Index on "/${e}/*/${t}" already exists`.colorize(be.inverse)),f;if(!s.isMaster){const p=yield s.sendRequest({type:"index.create",path:e,key:t,options:n});if(p.ok)return a.indexes.add(p.fileName);throw new Error(p.reason)}yield St.mkdir(`${a.settings.path}/${a.name}.acebase`).catch(p=>{if(p.code!=="EEXIST")throw p});const y=f||(()=>{const{include:p,caseSensitive:d,textLocale:h,textLocaleKey:m}=n,g={include:p,caseSensitive:d,textLocale:h,textLocaleKey:m};switch(u){case"array":return new Cl(a,e,t,V({},g));case"fulltext":return new fo(a,e,t,we(V({},g),{config:n.config}));case"geo":return new Rl(a,e,t,V({},g));default:return new Xr(a,e,t,V({},g))}})();f||o.push(y);try{yield y.build()}catch(p){throw r.debug.error(`Index build on "/${e}/*/${t}" failed: ${p.message} (code: ${p.code})`.colorize(be.red)),f||o.splice(o.indexOf(y),1),p}return s.sendNotification({type:"index.created",fileName:y.fileName,path:e,key:t,options:n}),y})}const{compareValues:cn,getChildValues:ht,encodeString:ei,defer:$l}=Xi,Ir=["value","child_added","child_changed","child_removed","mutated","mutations"];Ir.push(...Ir.map(r=>`notify_${r}`));const jl=()=>{};class Bl extends Error{constructor(e){super(`Schema validation failed: ${e}`),this.reason=e}}class Zr{constructor(e={}){this.maxInlineValueSize=50,this.removeVoidProperties=!1,this.path=".",this.lockTimeout=120,this.type="data",this.readOnly=!1,typeof e.maxInlineValueSize=="number"&&(this.maxInlineValueSize=e.maxInlineValueSize),typeof e.removeVoidProperties=="boolean"&&(this.removeVoidProperties=e.removeVoidProperties),typeof e.path=="string"&&(this.path=e.path),this.path.endsWith("/")&&(this.path=this.path.slice(0,-1)),typeof e.lockTimeout=="number"&&(this.lockTimeout=e.lockTimeout),typeof e.type=="string"&&(this.type=e.type),typeof e.readOnly=="boolean"&&(this.readOnly=e.readOnly),["object","string"].includes(typeof e.ipc)&&(this.ipc=e.ipc)}}class Ll extends Rt{createTid(){return ke.generate()}constructor(e,t,n){super(),this.name=e,this.settings=t,this._schemas=[],this._indexes=[],this._annoucedIndexes=new Map,this.indexes={get supported(){return St==null?void 0:St.hasFileSystem},create:(i,o,a={rebuild:!1})=>{const c={storage:this,debug:this.debug,indexes:this._indexes,ipc:this.ipc};return Nl(c,i,o,a)},get:(i,o=null)=>{if(i.includes("$")){const a=T.getPathKeys(i).map(c=>typeof c=="string"&&c.startsWith("$")?"*":c);i=new T(a).path}return this._indexes.filter(a=>a.path===i&&(o===null||o===a.key))},getAll:(i,o={parentPaths:!0,childPaths:!0})=>{const a=T.getPathKeys(i);return this._indexes.filter(c=>{const u=T.getPathKeys(c.path+"/*");return o.parentPaths&&u.every((l,f)=>l==="*"||a[f]===l)&&[c.key].concat(...c.includeKeys).includes(a[u.length])?!0:u.length<a.length||!o.childPaths&&u.length!==a.length?!1:a.every((l,f)=>[l,"*"].includes(u[f]))})},list:()=>this._indexes.slice(),load:()=>k(this,null,function*(){if(this._indexes.splice(0),!St.hasFileSystem)return;let i=[];try{i=yield St.readdir(`${this.settings.path}/${this.name}.acebase`)}catch(a){a.code!=="ENOENT"&&this.debug.error(a)}const o=[];i.forEach(a=>{if(!a.endsWith(".idx"))return;const c=this.settings.type!=="data",u=/^\[[a-z]+\]-/.test(a);if(!c&&!u||c&&a.startsWith(`[${this.settings.type}]-`)){const l=this.indexes.add(a);o.push(l)}}),yield Promise.all(o)}),add:i=>k(this,null,function*(){const o=this._indexes.find(a=>a.fileName===i);if(o)return o;if(this._annoucedIndexes.has(i))return yield this._annoucedIndexes.get(i);try{const a=Xr.readFromFile(this,i);this._annoucedIndexes.set(i,a);const c=yield a;return this._indexes.push(c),this._annoucedIndexes.delete(i),c}catch(a){return this.debug.error(a),null}}),delete:i=>k(this,null,function*(){const o=yield this.indexes.remove(i);yield o.delete(),this.ipc.sendNotification({type:"index.deleted",fileName:o.fileName,path:o.path,keys:o.key})}),remove:i=>k(this,null,function*(){const o=this._indexes.find(a=>a.fileName===i);if(!o)throw new Error(`Index ${i} not found`);return this._indexes.splice(this._indexes.indexOf(o),1),o}),close:()=>k(this,null,function*(){const i=this.indexes.list().map(o=>o.close().catch(a=>this.debug.error(a)));yield Promise.all(i)})},this._eventSubscriptions={},this.subscriptions={add:(i,o,a)=>{if(Ir.indexOf(o)<0)throw new TypeError(`Invalid event type "${o}"`);let c=this._eventSubscriptions[i];c||(c=this._eventSubscriptions[i]=[]),c.push({created:Date.now(),type:o,callback:a}),this.emit("subscribe",{path:i,event:o,callback:a})},remove:(i,o,a)=>{const c=this._eventSubscriptions[i];if(!c)return;const u=()=>c.findIndex(f=>(o?f.type===o:!0)&&(a?f.callback===a:!0));let l;for(;(l=u())>=0;)c.splice(l,1);this.emit("unsubscribe",{path:i,event:o,callback:a})},hasValueSubscribersForPath(i){return!!this.getValueSubscribersForPath(i)},getValueSubscribersForPath:i=>{const o=new T(i),a=[];return Object.keys(this._eventSubscriptions).forEach(c=>{if(o.equals(c)||o.isDescendantOf(c)){const u=this._eventSubscriptions[c],l=T.fillVariables(c,i);u.filter(f=>!f.type.startsWith("notify_")).forEach(f=>{let y=null;if(f.type==="value")y=l;else if(["mutated","mutations"].includes(f.type)&&o.isDescendantOf(l))y=i;else if(f.type==="child_changed"&&i!==l){const p=T.getPathKeys(i.slice(l.length).replace(/^\//,""))[0];y=T.getChildPath(l,p)}else if(["child_added","child_removed"].includes(f.type)&&o.isChildOf(l)){const p=T.getPathKeys(i.slice(l.length).replace(/^\//,""))[0];y=T.getChildPath(l,p)}y!==null&&!a.some(p=>p.type===f.type&&p.eventPath===l)&&a.push({type:f.type,eventPath:l,dataPath:y,subscriptionPath:c})})}}),a},getAllSubscribersForPath:i=>{const o=T.get(i),a=[];return Object.keys(this._eventSubscriptions).forEach(c=>{if(o.isOnTrailOf(c)){const u=this._eventSubscriptions[c],l=T.fillVariables(c,i);u.forEach(f=>{let y=null;if(f.type==="value"||f.type==="notify_value")y=l;else if(["child_changed","notify_child_changed"].includes(f.type)){const p=i===l||o.isAncestorOf(l)?"*":T.getPathKeys(i.slice(l.length).replace(/^\//,""))[0];y=T.getChildPath(l,p)}else if(["mutated","mutations","notify_mutated","notify_mutations"].includes(f.type))y=i;else if(["child_added","child_removed","notify_child_added","notify_child_removed"].includes(f.type)&&(o.isChildOf(l)||i===l||o.isAncestorOf(l))){const p=i===l||o.isAncestorOf(l)?"*":T.getPathKeys(i.slice(l.length).replace(/^\//,""))[0];y=T.getChildPath(l,p)}y!==null&&!a.some(p=>p.type===f.type&&p.eventPath===l&&p.subscriptionPath===c)&&a.push({type:f.type,eventPath:l,dataPath:y,subscriptionPath:c})})}}),a},trigger:(i,o,a,c,u,l)=>{(this._eventSubscriptions[o]||[]).filter(y=>y.type===i).forEach(y=>{y.callback(null,a,u,c,l)})}},this.debug=new so(n.logLevel,`[${e}${typeof t.type=="string"&&t.type!=="data"?`:${t.type}`:""}]`);const s=e+(typeof t.type=="string"?`_${t.type}`:"");if(t.ipc==="socket"||t.ipc instanceof Pe){const i={ipcName:s,server:t.ipc instanceof Pe?t.ipc:null};this.ipc=new Pe(this,i)}else if(t.ipc){if(typeof t.ipc.port!="number")throw new Error("IPC port number must be a number");if(!["master","worker"].includes(t.ipc.role))throw new Error(`IPC client role must be either "master" or "worker", not "${t.ipc.role}"`);const i=Object.assign({dbname:s},t.ipc);this.ipc=new Pe(this,i)}else this.ipc=new Il(this,s);this.ipc.once("exit",i=>{this.indexes.supported&&this.indexes.close()}),this.nodeLocker={lock:(i,o,a,c)=>this.ipc.lock({path:i,tid:o,write:a,comment:c})},this._lastTid=0}close(){return k(this,null,function*(){yield this.ipc.exit()})}get path(){return`${this.settings.path}/${this.name}.acebase`}valueFitsInline(e){if(typeof e=="number"||typeof e=="boolean"||e instanceof Date)return!0;if(typeof e=="string")return e.length>this.settings.maxInlineValueSize?!1:ei(e).length<this.settings.maxInlineValueSize;if(e instanceof fe)return e.path.length>this.settings.maxInlineValueSize?!1:ei(e.path).length<this.settings.maxInlineValueSize;if(e instanceof ArrayBuffer)return e.byteLength<this.settings.maxInlineValueSize;if(e instanceof Array)return e.length===0;if(typeof e=="object")return Object.keys(e).length===0;throw new TypeError("What else is there?")}_writeNode(e,t,n){throw new Error("This method must be implemented by subclass")}getUpdateImpact(e,t){let n=e,s=!1;const i=t?[]:this.subscriptions.getAllSubscribersForPath(e),o=t?[]:this.subscriptions.getValueSubscribersForPath(e);o.length>0&&(s=!0,n=o.map(f=>({path:f.dataPath,keys:T.getPathKeys(f.dataPath)})).sort((f,y)=>f.keys.length<y.keys.length?-1:f.keys.length>y.keys.length?1:0)[0].path,o.filter(f=>f.dataPath===n).every(f=>f.type==="mutated"||f.type.startsWith("notify_"))&&(s=!1),n=T.fillVariables(n,e));const a=this.indexes.getAll(e,{childPaths:!0,parentPaths:!0}).map(u=>({index:u,keys:T.getPathKeys(u.path)})).sort((u,l)=>u.keys.length<l.keys.length?-1:u.keys.length>l.keys.length?1:0).map(u=>u.index),c=[];if(a.length>0){a.sort((f,y)=>(typeof f._pathKeys=="undefined"&&(f._pathKeys=T.getPathKeys(f.path)),typeof y._pathKeys=="undefined"&&(y._pathKeys=T.getPathKeys(y.path)),f._pathKeys.length<y._pathKeys.length?-1:f._pathKeys.length>y._pathKeys.length?1:0));const u=a[0],l=u.path===e?e:T.fillVariables(`${u.path}/*`,e);l.length<n.length&&(n=l,a.filter(f=>f.path===u.path).forEach(f=>{[f.key].concat(f.includeKeys).forEach(p=>!c.includes(p)&&c.push(p))}))}return{topEventPath:n,eventSubscriptions:i,valueSubscribers:o,hasValueSubscribers:s,indexes:a,keysFilter:c}}_writeNodeWithTracking(s,i){return k(this,arguments,function*(e,t,n={merge:!1,waitForIndexUpdates:!0,suppress_events:!1,context:null,impact:null}){if(n=n||{},!n.tid&&!n.transaction)throw new Error("_writeNodeWithTracking MUST be executed with a tid OR transaction!");n.merge=n.merge===!0;const o=this.validateSchema(e,t,{updates:n.merge});if(!o.ok)throw new Bl(o.reason);const a=n.tid,c=n.transaction;let u=null;const l=n.impact?n.impact:this.getUpdateImpact(e,n.suppress_events),{topEventPath:f,eventSubscriptions:y,hasValueSubscribers:p,indexes:d}=l;let{keysFilter:h}=l;const m=()=>{if(typeof n._customWriteFunction=="function")return n._customWriteFunction();if(u){const v=T.getPathKeys(e),_=T.getPathKeys(f),E=v.slice(_.length);let b=u;for(;E.length>0&&b!==null;){const A=E.shift();b=typeof b=="object"&&A in b?b[A]:null}n.currentValue=b}return this._writeNode(e,t,n)},g=this.settings.transactions&&this.settings.transactions.log===!0;if(y.length===0&&d.length===0&&!g)return m();if(!p&&n.merge===!0&&h.length===0&&(h=Object.keys(t),f!==e)){const v=e.slice(f.length);h=h.map(_=>`${v}/${_}`)}const w=yield this.getNodeInfo(f,{transaction:c,tid:a});let x=null;if(w.exists){const v={transaction:c,tid:a};h.length>0&&(v.include=h),f===""&&typeof v.include=="undefined"&&this.debug.warn('WARNING: One or more value event listeners on the root node are causing the entire database value to be read to facilitate change tracking. Using "value", "notify_value", "child_changed" and "notify_child_changed" events on the root node are a bad practice because of the significant performance impact. Use "mutated" or "mutations" events instead'),x=(yield this.getNode(f,v)).value}u=x;const S=(yield m())||{};let O,I;if(e===f)n.merge?u===null?O=t instanceof Array?[]:{}:(O=u instanceof Array?[]:{},Object.keys(u).forEach(v=>{O[v]=u[v]})):O=t,I=O;else{const v=e.slice(f.length).replace(/^\//,""),_=T.getPathKeys(v);for(u===null?O=typeof _[0]=="number"?[]:{}:(O=u instanceof Array?[]:{},Object.keys(u).forEach(E=>{O[E]=u[E]})),I=O;_.length>0;){const E=_.shift();if(!n.merge&&_.length===0)I[E]=t;else{const b=I[E],A=typeof E=="number"?[...b]:V({},b);I[E]=A}I=I[E]}}n.merge&&Object.keys(t).forEach(v=>{I[v]=t[v]});const W=cn(u,O);if(W==="identical")return S.mutations=[],S;function $(v){if(v===null||typeof v!="object")return v;Object.keys(v).forEach(_=>{const E=v[_];E===null&&(delete v[_],v instanceof Array&&v.length--),typeof E=="object"&&$(E)})}$(O);const Y=[];d.map(v=>({index:v,keys:T.getPathKeys(v.path)})).sort((v,_)=>v.keys.length<_.keys.length?1:v.keys.length>_.keys.length?-1:0).forEach(({index:v})=>{const _=T.getPathKeys(f),E=T.getPathKeys(v.path+"/*"),b=E.slice(_.length),A=u,N=O;if(b.length===0){Te(_.length===E.length,"check logic");const P=this.ipc.isMaster?v.handleRecordUpdate(f,A,N):this.ipc.sendRequest({type:"index.update",fileName:v.fileName,path:f,oldValue:A,newValue:N});Y.push(P);return}const B=(P,U,R)=>{if(U===null&&R===null)return[];const K=T.getPathKeys(P),H=T.getPathKeys(v.path+"/*"),te=H.slice(K.length);if(te.length===0)return Te(K.length===H.length,"check logic"),[{path:P,oldValue:U,newValue:R}];let X=[],Z="";for(;te.length>0;){const _e=te.shift();if(typeof _e=="string"&&(_e==="*"||_e.startsWith("$"))){const ae=U===null?[]:Object.keys(U);R!==null&&Object.keys(R).forEach(ce=>{ae.indexOf(ce)<0&&ae.push(ce)}),ae.forEach(ce=>{const me=T.getChildPath(Z,ce),oe=ht(ce,U,R),Se=T.getChildPath(P,me),ue=B(Se,oe.oldValue,oe.newValue);X=X.concat(ue)});break}else{const ae=ht(_e,U,R);if(U=ae.oldValue,R=ae.newValue,U===null&&R===null)break;Z=T.getChildPath(Z,_e)}}return X};B(f,A,N).forEach(P=>{const U=this.ipc.isMaster?v.handleRecordUpdate(P.path,P.oldValue,P.newValue):this.ipc.sendRequest({type:"index.update",fileName:v.fileName,path:P.path,oldValue:P.oldValue,newValue:P.newValue});Y.push(U)})});const j=(v,_,E,b=[])=>{let A=!0,N=v.type;if(N.startsWith("notify_")&&(N=N.slice(7)),N==="mutated"||(N==="child_changed"&&(_===null||E===null)?A=!1:N==="value"||N==="child_changed"?A=cn(_,E)!=="identical":N==="child_added"?A=_===null&&E!==null:N==="child_removed"&&(A=_!==null&&E===null),!A))return;const B=T.getPathKeys(v.dataPath);b.forEach(P=>{const U=B.indexOf(P.name);Te(U>=0,`Variable "${P.name}" not found in subscription dataPath "${v.dataPath}"`),B[U]=P.value});const D=B.reduce((P,U)=>T.getChildPath(P,U),"");this.subscriptions.trigger(v.type,v.subscriptionPath,D,_,E,n.context)},L=(v,_,E,b)=>{const A=[],N=b||cn(_,E);return N==="identical"||(typeof N=="string"?A.push({path:v,oldValue:_,newValue:E}):(N.changed.forEach(B=>{const D=T.getChildPath(v,B.key),P=ht(B.key,_,E),U=L(D,P.oldValue,P.newValue,B.change);A.push(...U)}),N.added.forEach(B=>{const D=T.getChildPath(v,B);A.push({path:D,oldValue:null,newValue:E[B]})}),_ instanceof Array&&E instanceof Array&&N.removed.sort((B,D)=>B<D?1:-1),N.removed.forEach(B=>{const D=T.getChildPath(v,B);A.push({path:D,oldValue:_[B],newValue:null})}))),A};g&&this.settings.type!=="transaction"&&(S.mutations=(()=>{const v=e.slice(f.length).replace(/^\//,""),_=T.getPathKeys(v);let E=u,b=O;for(;_.length>0;){const D=_.shift();({oldValue:E,newValue:b}=ht(D,E,b))}const A=cn(E,b);return L(e,E,b,A).map(D=>({target:T.getPathKeys(D.path.slice(e.length)),prev:D.oldValue,val:D.newValue}))})());const J=()=>{y.filter(_=>!["mutated","mutations","notify_mutated","notify_mutations"].includes(_.type)).map(_=>{const E=T.getPathKeys(_.dataPath);return{sub:_,keys:E}}).sort((_,E)=>_.keys.length<E.keys.length?1:_.keys.length>E.keys.length?-1:0).forEach(({sub:_})=>{const E=(b,A,N,B=[])=>{const D=_.dataPath.slice(b.length).replace(/^\//,""),P=T.getPathKeys(D);for(;P.length>0;){const U=P.shift();if(typeof U=="string"&&(U==="*"||U[0]==="$")){const R=A===null?[]:Object.keys(A).map(K=>A instanceof Array?parseInt(K):K);N!==null&&Object.keys(N).forEach(K=>{const H=N instanceof Array?parseInt(K):K;!R.includes(H)&&R.push(K)}),R.forEach(K=>{const H=ht(K,A,N),te=B.concat({name:U,value:K});P.length===0?j(_,H.oldValue,H.newValue,te):E(T.getChildPath(b,U),H.oldValue,H.newValue,te)});return}else{b=T.getChildPath(b,U);const R=ht(U,A,N);A=R.oldValue,N=R.newValue}}j(_,A,N,B)};if(_.type.startsWith("notify_")&&T.get(_.eventPath).isAncestorOf(f)){const b=T.get(_.eventPath).isParentOf(f);(_.type==="notify_value"||_.type==="notify_child_changed"&&(!b||!["added","removed"].includes(W))||_.type==="notify_child_removed"&&W==="removed"&&b||_.type==="notify_child_added"&&W==="added"&&b)&&this.subscriptions.trigger(_.type,_.subscriptionPath,_.dataPath,null,null,n.context)}else E(f,u,O)}),y.filter(_=>["mutated","mutations","notify_mutated","notify_mutations"].includes(_.type)).forEach(_=>{let E=f;const b=_.eventPath.slice(E.length).replace(/^\//,""),A=T.getPathKeys(b);let N=u,B=O;for(;A.length>0;){const U=A.shift();E=T.getChildPath(E,U);const R=ht(U,N,B);N=R.oldValue,B=R.newValue}const D=L(E,N,B);if(D.length===0)return;const P=_.type.startsWith("notify_");if(["mutated","notify_mutated"].includes(_.type))D.forEach((U,R)=>{const K=n.context,H=P?null:U.oldValue,te=P?null:U.newValue;this.subscriptions.trigger(_.type,_.subscriptionPath,U.path,H,te,K)});else if(["mutations","notify_mutations"].includes(_.type)){const U=P?null:D.map(R=>({target:T.getPathKeys(R.path.slice(_.subscriptionPath.length)),prev:R.oldValue,val:R.newValue}));this.subscriptions.trigger(_.type,_.subscriptionPath,_.subscriptionPath,null,U,n.context)}})};return n.waitForIndexUpdates===!1&&Y.splice(0),yield Promise.all(Y),$l(J),S})}getChildren(e,t){throw new Error("This method must be implemented by subclass")}getNodeValue(n){return k(this,arguments,function*(e,t={}){return(yield this.getNode(e,t)).value})}getNode(e,t){throw new Error("This method must be implemented by subclass")}getNodeInfo(e,t){throw new Error("This method must be implemented by subclass")}setNode(e,t,n){throw new Error("This method must be implemented by subclass")}updateNode(e,t,n){throw new Error("This method must be implemented by subclass")}transactNode(s,i){return k(this,arguments,function*(e,t,n={no_lock:!1,suppress_events:!1,context:null}){const o=n&&n.no_lock===!0,a=this.createTid(),c=o?{tid:a,release:jl}:yield this.nodeLocker.lock(e,a,!0,"transactNode");try{let u=!1;const l=()=>{u=!0};o&&this.subscriptions.add(e,"notify_value",l);const f=yield this.getNode(e,{tid:a}),y=f.revision;let p;try{p=t(f.value),p instanceof Promise&&(p=yield p.catch(h=>{this.debug.error(`Error in transaction callback: ${h.message}`)}))}catch(h){this.debug.error(`Error in transaction callback: ${h.message}`)}if(typeof p=="undefined")return;if(o&&this.subscriptions.remove(e,"notify_value",l),u)throw new Pr("Node changed");return yield this.setNode(e,p,{assert_revision:y,tid:c.tid,suppress_events:n.suppress_events,context:n.context})}catch(u){if(u instanceof Pr)return console.warn(`node value changed, running again. Error: ${u.message}`),this.transactNode(e,t,n);throw u}finally{c.release()}})}matchNode(e,t,n){return k(this,null,function*(){var a;const s=(a=n==null?void 0:n.tid)!=null?a:ke.generate(),i=(c,u)=>k(this,null,function*(){if(u.length===0)return Promise.resolve(!0);const l=u.reduce((d,h)=>{let m=h.key;return typeof m=="string"&&m.includes("/")&&(m=m.slice(0,m.indexOf("/"))),d.indexOf(m)<0&&d.push(m),d},[]),f=l.slice();let y=!0;const p=[];try{return yield this.getChildren(c,{tid:s,keyFilter:l}).next(d=>{var w;const h=(w=d.key)!=null?w:d.index;f.includes(h)&&f.splice(f.indexOf(d.key),1);const m=u.filter(x=>x.key===h).map(x=>({op:x.op,compare:x.compare})),g=m.length>0?o(d,m):{isMatch:!0,promises:[]};if(y=g.isMatch,y){p.push(...g.promises);const x=u.filter(S=>typeof S.key=="string"&&S.key.startsWith(`${typeof h=="number"?`[${h}]`:h}/`)).map(S=>({key:S.key.slice(S.key.indexOf("/")+1),op:S.op,compare:S.compare}));if(x.length>0){const S=T.getChildPath(c,d.key),O=i(S,x).then(I=>({isMatch:I}));p.push(O)}}if(!y||f.length===0)return!1}),y&&(y=(yield Promise.all(p)).every(h=>h.isMatch)),y?(y=f.every(d=>{const h=new uo(we(V(V({},typeof d=="number"&&{index:d}),typeof d=="string"&&{key:d}),{exists:!1})),m=u.filter(x=>typeof x.key=="string"&&x.key.startsWith(`${typeof d=="number"?`[${d}]`:d}/`)).map(x=>({op:x.op,compare:x.compare}));if(m.length>0&&!o(h,m).isMatch)return!1;const g=u.filter(x=>x.key===d).map(x=>({op:x.op,compare:x.compare}));return g.length===0?!0:o(h,g).isMatch}),y):!1}catch(d){throw this.debug.error(`Error matching on "${c}": `,d),d}}),o=(c,u)=>{const l=[];return{isMatch:u.every(y=>{let p=!0;if(y.op==="!exists"||y.op==="=="&&(typeof y.compare=="undefined"||y.compare===null))p=!c.exists;else if(y.op==="exists"||y.op==="!="&&(typeof y.compare=="undefined"||y.compare===null))p=c.exists;else if((y.op==="contains"||y.op==="!contains")&&y.compare instanceof Array&&y.compare.length===0)p=!0;else if(!c.exists)p=!1;else if(c.address)if(c.valueType===F.OBJECT&&["has","!has"].indexOf(y.op)>=0){const d=y.op==="has"?"exists":"!exists",h=i(c.path,[{key:y.compare,op:d}]).then(m=>({key:c.key,isMatch:m}));l.push(h),p=!0}else if(c.valueType===F.ARRAY&&["contains","!contains"].indexOf(y.op)>=0){const d=this.getNode(c.path,{tid:s}).then(({value:h})=>{const m=y.op==="contains"?y.compare instanceof Array?y.compare.every(g=>h.includes(g)):h.includes(y.compare):y.compare instanceof Array?!y.compare.some(g=>h.includes(g)):!h.includes(y.compare);return{key:c.key,isMatch:m}});l.push(d),p=!0}else if(c.valueType===F.STRING){const d=this.getNode(c.path,{tid:s}).then(h=>({key:c.key,isMatch:this.test(h.value,y.op,y.compare)}));l.push(d),p=!0}else p=!1;else if(c.type===F.OBJECT&&["has","!has"].indexOf(y.op)>=0){const d=y.compare in c.value;p=d&&y.op==="has"||!d&&y.op==="!has"}else if(c.type===F.ARRAY&&["contains","!contains"].indexOf(y.op)>=0){const d=c.value.indexOf(y.compare)>=0;p=d&&y.op==="contains"||!d&&y.op==="!contains"}else{let d=this.test(c.value,y.op,y.compare);d instanceof Promise&&(l.push(d),d=!0),p=d}return p}),promises:l}};return i(e,t)})}test(e,t,n){if(t==="<")return e<n;if(t==="<=")return e<=n;if(t==="==")return e===n;if(t==="!=")return e!==n;if(t===">")return e>n;if(t===">=")return e>=n;if(t==="in")return n.indexOf(e)>=0;if(t==="!in")return n.indexOf(e)<0;if(t==="like"||t==="!like"){const s="^"+n.replace(/[-[\]{}()+.,\\^$|#\s]/g,"\\$&").replace(/\?/g,".").replace(/\*/g,".*?")+"$",o=new RegExp(s,"i").test(e.toString());return t==="like"?o:!o}if(t==="matches")return n.test(e.toString());if(t==="!matches")return!n.test(e.toString());if(t==="between")return e>=n[0]&&e<=n[1];if(t==="!between")return e<n[0]||e>n[1];if(t==="has"||t==="!has"){const s=typeof e=="object"&&n in e;return t==="has"?s:!s}if(t==="contains"||t==="!contains"){const s=typeof e=="object"&&e instanceof Array&&e.includes(n);return t==="contains"?s:!s}return!1}exportNode(s,i){return k(this,arguments,function*(e,t,n={format:"json",type_safe:!0}){if((n==null?void 0:n.format)!=="json")throw new Error("Only json output is currently supported");const o=typeof t!="function"?t.write.bind(t):t,a=(d,h)=>{const m=g=>g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/[\u0000-\u001f]/g,w=>`\\u${w.charCodeAt(0).toString(16).padStart(4,"0")}`);return d===F.DATETIME?(h=`"${h.toISOString()}"`,n.type_safe&&(h=`{".type":"date",".val":${h}}`)):d===F.STRING?h=`"${m(h)}"`:d===F.ARRAY?h="[]":d===F.OBJECT?h="{}":d===F.BINARY?(h=`"${m(Xe.encode(h))}"`,n.type_safe&&(h=`{".type":"binary",".val":${h}}`)):d===F.REFERENCE?(h=`"${h.path}"`,n.type_safe&&(h=`{".type":"reference",".val":${h}}`)):d===F.BIGINT&&(h=`"${h}"`,n.type_safe&&(h=`{".type":"bigint",".val":${h}}`)),h};let c="",u="";const l=yield this.getNodeInfo(e);if(l.exists)if(l.type===F.OBJECT)c="{",u="}";else if(l.type===F.ARRAY)c="[",u="]";else{const d=yield this.getNode(e),h=a(l.type,d.value);return o(h)}else return o("null");if(c){const d=o(c);d instanceof Promise&&(yield d)}let f="",y=0;const p=[];if(yield this.getChildren(e).next(d=>{d.address?p.push(d):(y++>0&&(f+=","),typeof d.key=="string"&&(f+=`"${d.key}":`),f+=a(d.type,d.value))}),f){const d=o(f);d instanceof Promise&&(yield d)}for(;p.length>0;){const d=p.shift();let h=y++>0?",":"";const m=typeof d.index=="number"?d.index:d.key;if(typeof m=="string"&&(h+=`"${m}":`),h){const g=o(h);g instanceof Promise&&(yield g)}yield this.exportNode(T.getChildPath(e,m),o,n)}if(u){const d=o(u);d instanceof Promise&&(yield d)}})}importNode(s,i){return k(this,arguments,function*(e,t,n={format:"json",method:"set"}){const a={data:"",index:0,offset:0,queue:[],queueStartByte:0,timesFlushed:0,get processedBytes(){return this.offset+this.index}},c=(j=!1)=>k(this,null,function*(){let L=yield t(262144);if(L===null)throw a.data?new Error(`Unexpected EOF at index ${a.offset+a.data.length}`):new Error("Unable to read data from stream");typeof L=="object"&&(L=qi(L)),j?a.data+=L:(a.offset+=a.data.length,a.data=L,a.index=0)}),u=j=>k(this,null,function*(){let L="";return a.index+j>=a.data.length&&(L=a.data.slice(a.index),j-=L.length,yield c()),L+=a.data.slice(a.index,a.index+j),a.index+=j,L}),l=j=>k(this,null,function*(){if(a.index+j>a.data.length&&(yield c(!0)),a.index+j>a.data.length)throw new Error("Not enough data available from stream")}),f=j=>k(this,null,function*(){const L=yield u(j.length);if(L!==j)throw new Error(`Unexpected character "${L[0]}" at index ${a.offset+a.index}, expected "${j}"`)}),y=()=>k(this,null,function*(){const j=[" ","	","\r",`
`];for(;a.index>=a.data.length&&(yield c()),j.includes(a.data[a.index]);)a.index++}),p=j=>k(this,null,function*(){yield l(j);const L=a.index;return a.data.slice(L,L+j)}),d=()=>k(this,null,function*(){yield y();const j=yield p(1);switch(j){case'"':return"string";case"{":return"object";case"[":return"array";case"n":return"null";case"u":return"undefined";case"t":case"f":return"boolean";default:{if(j==="-"||j>="0"&&j<="9")return"number";throw new Error(`Unknown value at index ${a.offset+a.index}`)}}}),h=()=>k(this,null,function*(){yield f('"');let j="",L=a.index;for(;a.data[L]!=='"'||a.data[L-1]==="\\";)L++,L>=a.data.length&&(j+=a.data.slice(a.index),yield c(),L=0);return j+=a.data.slice(a.index,L),a.index=L+1,x(j)}),m=()=>k(this,null,function*(){throw a.data[a.index]==="t"?yield f("true"):a.data[a.index]==="f"&&(yield f("false")),new Error(`Expected true or false at index ${a.offset+a.index}`)}),g=()=>k(this,null,function*(){let j="",L=a.index;const J=["-","0","1","2","3","4","5","6","7","8","9",".","e","b","f","x","o","n"];for(;J.includes(a.data[L]);)L++,L>=a.data.length&&(j+=a.data.slice(a.index),yield c(),L=0);return j+=a.data.slice(a.index,L),a.index=L,j.endsWith("n")?BigInt(j.slice(0,-1)):j.includes(".")?parseFloat(j):parseInt(j)}),w=()=>k(this,null,function*(){yield y();const j=yield d(),L=yield(()=>{switch(j){case"string":return h();case"object":return{};case"array":return[];case"number":return g();case"null":return null;case"undefined":return;case"boolean":return m()}})();return{type:j,value:L}}),x=j=>j.replace(/\\n/g,`
`).replace(/\\"/g,'"'),S=(j,L)=>{const J=L[".type"];let v=L[".val"];switch(J){case"Date":case"date":{v=new Date(v);break}case"Buffer":case"binary":{if(v=x(v),v.startsWith("<~"))v=Xe.decode(v);else throw new Error(`Import error: Unexpected encoding for value for value at path "/${j}"`);break}case"PathReference":case"reference":{v=new fe(v);break}case"bigint":{v=BigInt(v);break}default:throw new Error(`Import error: Unsupported type "${J}" for value at path "/${j}"`)}return v},O={acebase_import_id:ke.generate()},I={suppress_events:n.suppress_events,context:O},W=j=>k(this,null,function*(){if(yield f("{"),yield y(),(yield p(1))==="}")return a.index++,this.setNode(j.path,{},I);let J=0,v={},_=!1;const E=()=>k(this,null,function*(){let N;_?Object.keys(v).length>0&&(N=this.updateNode(j.path,v,I)):(_=!0,N=this.setNode(j.path,v,I)),v={},N&&(yield N)}),b=[];for(;;){yield y();const N=yield h();yield y(),yield f(":"),yield y();const{value:B,type:D}=yield w();if(v[N]=B,J++,["object","array"].includes(D)&&(b.push(E()),D==="object"?yield W(j.child(N)):yield $(j.child(N))),yield y(),(yield p(1))==="}"){a.index++;break}yield f(",")}if(J===2&&".type"in v&&".val"in v){const N=S(j.path,v);return this.setNode(j.path,N,I)}b.push(E()),yield Promise.all(b)}),$=j=>k(this,null,function*(){if(yield f("["),yield y(),(yield p(1))==="]")return a.index++,this.setNode(j.path,[],I);let J=!1,v=[],_={};const E=()=>k(this,null,function*(){let B;J?Object.keys(_).length>0&&(B=this.updateNode(j.path,_,I),_={}):(J=!0,B=this.setNode(j.path,v,I),v=null),B&&(yield B)}),b=(B,D)=>{J?_[D]=B:v.push(B)},A=[];let N=0;for(;;){yield y();const{value:B,type:D}=yield w();if(b(B,N),["object","array"].includes(D)&&(A.push(E()),D==="object"?yield W(j.child(N)):yield $(j.child(N))),yield y(),(yield p(1))==="]"){a.index++;break}yield f(","),N++}A.push(E()),yield Promise.all(A)});return(()=>k(this,null,function*(){const{value:j,type:L}=yield w();if(["object","array"].includes(L)){const J=T.get(e);L==="object"?yield W(J):yield $(J)}else yield this.setNode(e,j,I)}))()})}setSchema(e,t,n=!1){if(typeof t=="undefined")throw new TypeError("schema argument must be given");if(t===null){const o=this._schemas.findIndex(a=>a.path===e);o>=0&&this._schemas.splice(o,1);return}const s=new xl(t,{warnOnly:n,warnCallback:o=>this.debug.warn(o)}),i=this._schemas.find(o=>o.path===e);i?i.schema=s:(this._schemas.push({path:e,schema:s}),this._schemas.sort((o,a)=>{const c=T.getPathKeys(o.path),u=T.getPathKeys(a.path);return c.length===u.length?0:c.length<u.length?-1:1}))}getSchema(e){const t=this._schemas.find(n=>n.path===e);return t?{path:e,schema:t.schema.source,text:t.schema.text}:null}getSchemas(){return this._schemas.map(e=>({path:e.path,schema:e.schema.source,text:e.schema.text}))}validateSchema(e,t,n={updates:!1}){let s={ok:!0};const i=T.get(e);return this._schemas.filter(o=>i.isOnTrailOf(o.path)).every(o=>{if(i.isDescendantOf(o.path)){const l=T.fillVariables(o.path,e),f=i.keys.slice(T.getPathKeys(o.path).length);return s=o.schema.check(l,t,n.updates,f),s.ok}const a=T.getPathKeys(o.path).slice(i.keys.length);if(n.updates===!0&&a.length>0&&!(a[0]in t))return s.ok;const c=n.updates===!0&&a.length===0,u=(l,f,y)=>{if(y.length===0)return o.schema.check(l,f,c);if(f===null)return{ok:!0};const p=y[0];if(typeof p=="string"&&(p==="*"||p[0]==="$")){if(f===null||typeof f!="object")return{ok:!0};let d;return Object.keys(f).every(h=>{const m=T.getChildPath(l,h),g=f[h];return d=u(m,g,y.slice(1)),d.ok}),d}else{const d=T.getChildPath(l,p),h=f[p];return u(d,h,y.slice(1))}};return s=u(e,t,a),s.ok}),s}}class Kt{static ChildPathsSql(e,t="path"){return e===""?`${t} <> '' AND ${t} NOT LIKE '%/%'`:`(${t} LIKE '${e}/%' OR ${t} LIKE '${e}[%') AND ${t} NOT LIKE '${e}/%/%' AND ${t} NOT LIKE '${e}[%]/%' AND ${t} NOT LIKE '${e}[%][%'`}static ChildPathsRegex(e){return new RegExp(`^${e}(?:/[^/[]+|\\[[0-9]+\\])$`)}static DescendantPathsSql(e,t="path"){return e===""?`${t} <> ''`:`${t} LIKE '${e}/%' OR ${t} LIKE '${e}[%'`}static DescendantPathsRegex(e){return new RegExp(`^${e}(?:/[^/[]+|\\[[0-9]+\\])`)}static get PathInfo(){return T}}class ti{constructor(e){this.path=e}toString(){return`"/${this.path}"`}equals(e){return this.path===e.path}}const{compareValues:Dl}=Xi;class es{constructor(e){this.production=!1,this.target={get originalPath(){return e.path},path:e.path,get write(){return e.write}},this.id=ke.generate()}getChildCount(e){return k(this,null,function*(){let t=0;return yield this.childrenOf(e,{metadata:!1,value:!1},()=>(t++,!1)),t})}getMultiple(e){return k(this,null,function*(){const t=new Map;return yield Promise.all(e.map(n=>this.get(n).then(s=>t.set(n,s)))),t})}setMultiple(e){return k(this,null,function*(){yield Promise.all(e.map(({path:t,node:n})=>this.set(t,n)))})}removeMultiple(e){return k(this,null,function*(){yield Promise.all(e.map(t=>this.remove(t)))})}commit(){return k(this,null,function*(){throw new Error("CustomStorageTransaction.rollback must be overridden by subclass")})}moveToParentPath(e){return k(this,null,function*(){const t=this._lock&&this._lock.path||this.target.path;if(t===e)return e;if(Kt.PathInfo.get(e).isParentOf(t))this._lock&&(this._lock=yield this._lock.moveToParent());else throw new Error(`Locking issue. Locked path "${this._lock.path}" is not a child/descendant of "${e}"`);return this.target.path=e,e})}}class Vt extends Zr{constructor(e){if(super(e),this.locking=!0,typeof e!="object")throw new Error("settings missing");if(typeof e.ready!="function")throw new Error("ready must be a function");if(typeof e.getTransaction!="function")throw new Error("getTransaction must be a function");this.name=e.name,this.locking=e.locking!==!1,this.locking&&(this.lockTimeout=typeof e.lockTimeout=="number"?e.lockTimeout:120),this.ready=e.ready;const t=this.locking,n=t?new lo(console,this.lockTimeout):null;this.getTransaction=o=>k(this,[o],function*({path:s,write:i}){const a=yield e.getTransaction({path:s,write:i});Te(typeof a.id=="string","transaction id not set");const c=a.rollback,u=a.commit;return a.commit=()=>k(this,null,function*(){const l=yield u.call(a);return t&&(yield a._lock.release("commit")),l}),a.rollback=l=>k(this,null,function*(){const f=yield c.call(a,l);return t&&(yield a._lock.release("rollback")),f}),t&&(a._lock=yield n.lock(s,a.id,i,`${this.name}::getTransaction`)),a})}}class lr extends uo{constructor(e){super(e),this.revision=e.revision,this.revision_nr=e.revision_nr,this.created=e.created,this.modified=e.modified}}class Ul extends Ll{constructor(e,t,n){super(e,t,n),this._customImplementation=t,this._init()}_init(){return k(this,null,function*(){this.debug.log(`Database "${this.name}" details:`.colorize(be.dim)),this.debug.log("- Type: CustomStorage".colorize(be.dim)),this.debug.log(`- Path: ${this.settings.path}`.colorize(be.dim)),this.debug.log(`- Max inline value size: ${this.settings.maxInlineValueSize}`.colorize(be.dim)),this.debug.log(`- Autoremove undefined props: ${this.settings.removeVoidProperties}`.colorize(be.dim)),yield this._customImplementation.ready();const e=yield this._customImplementation.getTransaction({path:"",write:!0});(yield this.getNodeInfo("",{transaction:e})).exists||(yield this._writeNode("",{},{transaction:e})),yield e.commit(),this.indexes.supported&&(yield this.indexes.load()),this.emit("ready")})}throwImplementationError(e){throw new Error(`CustomStorage "${this._customImplementation.name}" ${e}`)}_storeNode(e,t,n){const s=o=>{if(o===null)throw new Error("Not allowed to store null values. remove the property");if(["string","number","boolean"].includes(typeof o))return o;if(o instanceof Date)return{type:F.DATETIME,value:o.getTime()};if(o instanceof fe)return{type:F.REFERENCE,value:o.path};if(o instanceof ArrayBuffer)return{type:F.BINARY,value:Xe.encode(o)};if(typeof o=="object")return Te(Object.keys(o).length===0,"child object stored in parent can only be empty"),o},i="Caller should have pre-processed the value by converting it to a string";if(t.type===F.ARRAY&&t.value instanceof Array){console.warn(`Unprocessed array. ${i}`);const o={};for(let a=0;a<t.value.length;a++)o[a]=t.value[a];t.value=o}if(t.type===F.BINARY&&typeof t.value!="string"&&(console.warn(`Unprocessed binary value. ${i}`),t.value=Xe.encode(t.value)),t.type===F.REFERENCE&&t.value instanceof fe&&(console.warn(`Unprocessed path reference. ${i}`),t.value=t.value.path),[F.OBJECT,F.ARRAY].includes(t.type)){const o=t.value;t.value={},Object.keys(o).forEach(a=>{t.value[a]=s(o[a])})}return n.transaction.set(e,t)}_processReadNodeValue(e){const t=n=>{if(n.type===F.BINARY)return Xe.decode(n.value);if(n.type===F.DATETIME)return new Date(n.value);if(n.type===F.REFERENCE)return new fe(n.value);throw new Error(`Unhandled child value type ${n.type}`)};switch(e.type){case F.ARRAY:case F.OBJECT:{const n=e.value;Object.keys(n).forEach(s=>{const i=n[s];typeof i=="object"&&"type"in i&&(n[s]=t(i))}),e.value=n;break}case F.BINARY:{e.value=Xe.decode(e.value);break}case F.REFERENCE:{e.value=new fe(e.value);break}case F.STRING:break;default:throw new Error("Invalid standalone record value type")}}_readNode(e,t){return k(this,null,function*(){const n=yield t.transaction.get(e);return n===null?null:(typeof n!="object"&&this.throwImplementationError("transaction.get must return an ICustomStorageNode object. Use JSON.parse if your set function stored it as a string"),this._processReadNodeValue(n),n)})}_getTypeFromStoredValue(e){let t;if(typeof e=="string")t=F.STRING;else if(typeof e=="number")t=F.NUMBER;else if(typeof e=="boolean")t=F.BOOLEAN;else if(e instanceof Array)t=F.ARRAY;else if(typeof e=="object")if("type"in e){const n=e;t=n.type,e=n.value,t===F.DATETIME?e=new Date(e):t===F.REFERENCE&&(e=new fe(e))}else t=F.OBJECT;else throw new Error("Unknown value type");return{type:t,value:e}}_writeNode(e,t,n){return k(this,null,function*(){if(!n.merge&&this.valueFitsInline(t)&&e!=="")throw new Error("invalid value to store in its own node");if(e===""&&(typeof t!="object"||t instanceof Array))throw new Error("Invalid root node value. Must be an object");if(typeof n.diff=="undefined"&&typeof n.currentValue!="undefined"){const d=Dl(n.currentValue,t);n.merge&&typeof d=="object"&&(d.removed=d.removed.filter(h=>t[h]===null)),n.diff=d}if(n.diff==="identical")return;const s=n.transaction,i=n.currentValue===null?null:yield this._readNode(e,{transaction:s});if(n.merge&&i){if(i.type===F.ARRAY&&!(t instanceof Array)&&typeof t=="object"&&Object.keys(t).some(d=>isNaN(parseInt(d))))throw new Error(`Cannot merge existing array of path "${e}" with an object`);if(t instanceof Array&&i.type!==F.ARRAY)throw new Error(`Cannot merge existing object of path "${e}" with an array`)}const o=n.revision||ke.generate(),a={type:i&&i.type===F.ARRAY?F.ARRAY:F.OBJECT,value:{}},c={};if(t instanceof Array){a.type=F.ARRAY;const d={};for(let h=0;h<t.length;h++)d[h]=t[h];t=d}else t instanceof fe?(a.type=F.REFERENCE,a.value=t.path):t instanceof ArrayBuffer?(a.type=F.BINARY,a.value=Xe.encode(t)):typeof t=="string"&&(a.type=F.STRING,a.value=t);const u=i?[F.OBJECT,F.ARRAY].includes(i.type):!1,l=[F.OBJECT,F.ARRAY].includes(a.type),f={current:[],new:[]};let y=null;u&&(y=i.value,f.current=Object.keys(y),l&&(a.value=y)),l&&(n.merge||Object.keys(a.value).forEach(d=>{d in t||(t[d]=null)}),Object.keys(t).forEach(d=>{const h=t[d];if(delete a.value[d],h!==null){if(typeof h=="undefined")if(this.settings.removeVoidProperties===!0){delete t[d];return}else throw new Error(`Property "${d}" has invalid value. Cannot store undefined values. Set removeVoidProperties option to true to automatically remove undefined properties`);this.valueFitsInline(h)?a.value[d]=h:c[d]=h}}));const p=a.type===F.ARRAY;if(i){if(this.debug.log(`Node "/${e}" is being ${n.merge?"updated":"overwritten"}`.colorize(be.cyan)),u||l){const h=T.get(e),m=[];let g=!1;const w=j=>(g=!0,!s.production&&!h.isParentOf(j)&&this.throwImplementationError(`"${j}" is not a child of "${e}" - childrenOf must only check and return paths that are children`),!0),x=j=>{g||this.throwImplementationError("childrenOf did not call checkCallback before addCallback");const L=T.get(j).key;return m.push(L.toString()),!0};yield s.childrenOf(e,{metadata:!1,value:!1},w,x),f.current=f.current.concat(m),l&&(n&&n.merge&&(f.new=f.current.slice()),Object.keys(t).forEach(j=>{f.new.includes(j)||f.new.push(j)}));const S={insert:f.new.filter(j=>!f.current.includes(j)),update:[],delete:n&&n.merge?Object.keys(t).filter(j=>t[j]===null):f.current.filter(j=>!f.new.includes(j))};if(S.update=f.new.filter(j=>f.current.includes(j)&&!S.delete.includes(j)),p&&n.merge&&(S.insert.length>0||S.delete.length>0)&&!S.update.concat(S.insert).every((J,v,_)=>_.includes(v.toString())))throw new Error(`Elements cannot be inserted beyond, or removed before the end of an array. Rewrite the whole array at path "${e}" or change your schema to use an object collection instead`);const O=Object.keys(c).map(j=>{const L=p?parseInt(j):j,J=typeof n.diff=="object"?n.diff.forChild(L):void 0;if(J==="identical")return;const v=h.childPath(L),_=c[L],E=typeof n.currentValue=="undefined"?void 0:n.currentValue!==null&&typeof n.currentValue=="object"&&L in n.currentValue?n.currentValue[L]:null;return this._writeNode(v,_,{transaction:s,revision:o,merge:!1,currentValue:E,diff:J})}),I=l?m.filter(j=>j in a.value):[],$=S.delete.concat(I).map(j=>{const L=p?parseInt(j):j,J=h.childPath(L);return this._deleteNode(J,{transaction:s})}),Y=O.concat($);yield Promise.all(Y)}const d=this._storeNode(e,{type:a.type,value:a.value,revision:i.revision,revision_nr:i.revision_nr+1,created:i.created,modified:Date.now()},{transaction:s});if(d instanceof Promise)return yield d}else{if(this.debug.log(`Node "/${e}" is being created`.colorize(be.cyan)),p&&!Object.keys(a.value).concat(Object.keys(c)).every((w,x,S)=>S.includes(x.toString())))throw new Error("Cannot store arrays with missing entries");const d=Object.keys(c).map(m=>{const g=p?parseInt(m):m,w=T.getChildPath(e,g),x=c[g];return this._writeNode(w,x,{transaction:s,revision:o,merge:!1,currentValue:null})}),h=this._storeNode(e,{type:a.type,value:a.value,revision:o,revision_nr:1,created:Date.now(),modified:Date.now()},{transaction:s});h instanceof Promise&&d.push(h),yield Promise.all(d)}})}_deleteNode(e,t){return k(this,null,function*(){const n=T.get(e);this.debug.log(`Node "/${e}" is being deleted`.colorize(be.cyan));const s=[e];let i=!1;const o=u=>(i=!0,!c.production&&!n.isAncestorOf(u)&&this.throwImplementationError(`"${u}" is not a descendant of "${e}" - descendantsOf must only check and return paths that are descendants`),!0),a=u=>(i||this.throwImplementationError("descendantsOf did not call checkCallback before addCallback"),s.push(u),!0),c=t.transaction;return yield c.descendantsOf(e,{metadata:!1,value:!1},o,a),this.debug.log(`Nodes ${s.map(u=>`"/${u}"`).join(",")} are being deleted`.colorize(be.cyan)),c.removeMultiple(s)})}getChildren(e,t={}){let n;const s={next(o){return n=o,i()}},i=()=>k(this,null,function*(){const o=t.transaction||(yield this._customImplementation.getTransaction({path:e,write:!1}));try{let a=!1;return yield(()=>k(this,null,function*(){const c=yield this._readNode(e,{transaction:o});if(!c)throw new Qr(`Node "/${e}" does not exist`);if(![F.OBJECT,F.ARRAY].includes(c.type))return;const u=c.type===F.ARRAY,l=c.value;let f=Object.keys(l).map(m=>u?parseInt(m):m);t.keyFilter&&(f=f.filter(m=>t.keyFilter.includes(m)));const y=T.get(e);if(f.length>0&&f.every(m=>{const g=this._getTypeFromStoredValue(l[m]),w=new lr({path:y.childPath(m),key:u?null:m,index:u?m:null,type:g.type,address:null,exists:!0,value:g.value,revision:c.revision,revision_nr:c.revision_nr,created:new Date(c.created),modified:new Date(c.modified)});return a=n(w)===!1,!a}),a)return;let p=!1;const d=m=>{if(p=!0,!o.production&&!y.isParentOf(m)&&this.throwImplementationError(`"${m}" is not a child of "${e}" - childrenOf must only check and return paths that are children`),t.keyFilter){const g=T.get(m).key;return t.keyFilter.includes(g)}return!0},h=(m,g)=>{p||this.throwImplementationError("childrenOf did not call checkCallback before addCallback");const w=T.get(m).key,x=new lr({path:m,type:g.type,key:u?null:w,index:u?w:null,address:new ti(m),exists:!0,value:null,revision:g.revision,revision_nr:g.revision_nr,created:new Date(g.created),modified:new Date(g.modified)});return a=n(x)===!1,!a};yield o.childrenOf(e,{metadata:!0,value:!1},d,h)}))(),t.transaction||(yield o.commit()),a}catch(a){throw t.transaction||(yield o.rollback(a)),a}});return s}getNode(e,t){return k(this,null,function*(){t=t||{};const n=t.transaction||(yield this._customImplementation.getTransaction({path:e,write:!1}));try{const s=yield(()=>k(this,null,function*(){const i=t.include&&t.include.length>0||t.exclude&&t.exclude.length>0||t.child_objects===!1,o=T.get(e),a=yield this._readNode(e,{transaction:n});if(!a){if(e==="")return{value:null};const x=yield n.moveToParentPath(o.parentPath);Te(x===o.parentPath,`transaction.moveToParentPath() did not move to the right parent path of "${e}"`);const S=yield this._readNode(o.parentPath,{transaction:n});if(S&&[F.OBJECT,F.ARRAY].includes(S.type)&&o.key in S.value){const O=this._getTypeFromStoredValue(S.value[o.key]);return{revision:S.revision,revision_nr:S.revision_nr,created:S.created,modified:S.modified,type:O.type,value:O.value}}return{value:null}}const c=a.type===F.ARRAY,u=x=>{const S=O=>/^[0-9]+$/.test(O);return x.map(O=>T.get(c&&S(O)?`[${O}]`:O))},l=t.include?u(t.include):[],f=t.exclude?u(t.exclude):[],y=(x,S)=>{if([F.OBJECT,F.ARRAY].includes(S.type)&&l.length>0){const O=T.getPathKeys(x).slice(o.keys.length),I=new T(O),W=[],$=l.filter(L=>L.isDescendantOf(I));if($.length>0){const L=S.type===F.ARRAY;W.push(...Object.keys(S.value).map(J=>L?+J:J));for(const J of $){const v=J.keys[O.length];if(typeof v=="string"&&(v==="*"||v.startsWith("$"))){W.splice(0);break}const _=W.indexOf(v);_>=0&&W.splice(_,1)}}const Y=l.some(L=>L.isChildOf(I));if(f.some(L=>L.isChildOf(I))&&!Y){const L=f.filter(J=>J.isChildOf(I));for(let J=0;J<W.length;J++)L.find(v=>v.equals(W[J]))||(W.splice(J,1),J--)}for(const L of W)delete S.value[L]}};y(e,a);let p=!1;const d=(x,S)=>{if(p=!0,!n.production&&!o.isAncestorOf(x)&&this.throwImplementationError(`"${x}" is not a descendant of "${e}" - descendantsOf must only check and return paths that are descendants`),!i)return!0;const I=T.getPathKeys(x).slice(o.keys.length),W=new T(I);let $=(l.length>0?l.some(Y=>W.isOnTrailOf(Y)):!0)&&(f.length>0?!f.some(Y=>Y.equals(W)||Y.isAncestorOf(W)):!0);return $&&t.child_objects===!1&&(o.isParentOf(x)&&[F.OBJECT,F.ARRAY].includes(S?S.type:-1)||T.getPathKeys(x).length>o.pathKeys.length+1)&&($=!1),$},h=[],m=(x,S)=>{if(p||this.throwImplementationError("descendantsOf did not call checkCallback before addCallback"),t.child_objects===!1&&[F.OBJECT,F.ARRAY].includes(S.type))return!0;y(x,S),this._processReadNodeValue(S);const O=S;return O.path=x,h.push(O),!0};yield n.descendantsOf(e,{metadata:!0,value:!0},d,m),this.debug.log(`Read node "/${e}" and ${i?"(filtered) ":""}descendants from ${h.length+1} records`.colorize(be.magenta));const g=a,w=x=>{const S=[];return Object.keys(x).forEach(O=>{const I=parseInt(O);S[I]=x[I]}),S};if(a.type===F.ARRAY&&(g.value=w(g.value)),a.type===F.OBJECT||a.type===F.ARRAY){const x=T.getPathKeys(e),S=a.value;for(let O=0;O<h.length;O++){const I=h[O],$=T.getPathKeys(I.path).slice(x.length);let Y=S;for(let j=0;j<$.length;j++){Te(typeof Y=="object","parent must be an object/array to have children!!");const L=$[j],J=j===$.length-1,v=J?I.type:typeof $[j+1]=="number"?F.ARRAY:F.OBJECT;let _;J?(_=I.value,v===F.ARRAY&&(_=w(_))):_=v===F.OBJECT?{}:[],L in Y?typeof Y[L]==typeof _&&[F.OBJECT,F.ARRAY].includes(v)?Object.keys(_).forEach(b=>{b in Y[L]&&this.throwImplementationError(`Custom storage merge error: child key "${b}" is in parent value already! Make sure the get/childrenOf/descendantsOf methods of the custom storage class return values that can be modified by AceBase without affecting the stored source`),Y[L][b]=_[b]}):this.debug.error(`The value stored in node "${I.path}" cannot be merged with the parent node, value will be ignored. This error should disappear once the target node value is updated. See issue #20 for more information`,{path:e,parent:Y,key:L,nodeType:v,nodeValue:_}):Y[L]=_,Y=Y[L]}}}else h.length>0&&this.throwImplementationError("multiple records found for non-object value!");if(t.child_objects===!1&&Object.keys(g.value).forEach(x=>{typeof g.value[x]=="object"&&g.value[x].constructor===Object&&(Te(Object.keys(g.value[x]).length===0),delete g.value[x])}),t.include,t.exclude){const x=(S,O)=>{if(typeof S!="object")return;const I=O[0];I==="*"?Object.keys(S).forEach(W=>{x(S[W],O.slice(1))}):O.length>1?I in S&&x(S[I],O.slice(1)):delete S[I]};t.exclude.forEach(S=>{const O=T.getPathKeys(S);x(g.value,O)})}return g}))();return t.transaction||(yield n.commit()),s}catch(s){throw t.transaction||(yield n.rollback(s)),s}})}getNodeInfo(n){return k(this,arguments,function*(e,t={}){t=t||{};const s=T.get(e),i=t.transaction||(yield this._customImplementation.getTransaction({path:e,write:!1}));try{const o=yield this._readNode(e,{transaction:i}),a=new lr({path:e,key:typeof s.key=="string"?s.key:null,index:typeof s.key=="number"?s.key:null,type:o?o.type:0,exists:o!==null,address:o?new ti(e):null,created:o?new Date(o.created):null,modified:o?new Date(o.modified):null,revision:o?o.revision:null,revision_nr:o?o.revision_nr:null});if(!o&&e!==""){const c=yield i.moveToParentPath(s.parentPath);Te(c===s.parentPath,`transaction.moveToParentPath() did not move to the right parent path of "${e}"`);const u=yield this._readNode(s.parentPath,{transaction:i});u&&[F.OBJECT,F.ARRAY].includes(u.type)&&s.key in u.value?(a.exists=!0,a.value=u.value[s.key],a.address=null,a.type=u.type,a.created=new Date(u.created),a.modified=new Date(u.modified),a.revision=u.revision,a.revision_nr=u.revision_nr):a.address=null}return t.include_child_count&&(a.childCount=0,[F.OBJECT,F.ARRAY].includes(a.valueType)&&a.address&&(a.childCount=o.value?Object.keys(o.value).length:0,a.childCount+=yield i.getChildCount(e))),t.transaction||(yield i.commit()),a}catch(o){throw t.transaction||(yield i.rollback(o)),o}})}setNode(s,i){return k(this,arguments,function*(e,t,n={suppress_events:!1,context:null}){if(this.settings.readOnly)throw new Error("Database is opened in read-only mode");const o=T.get(e),a=n.transaction||(yield this._customImplementation.getTransaction({path:e,write:!0}));try{if(e===""){if(t===null||typeof t!="object"||t instanceof Array||t instanceof ArrayBuffer||"buffer"in t&&t.buffer instanceof ArrayBuffer)throw new Error(`Invalid value for root node: ${t}`);yield this._writeNodeWithTracking("",t,{merge:!1,transaction:a,suppress_events:n.suppress_events,context:n.context})}else if(typeof n.assert_revision!="undefined"){const c=yield this.getNodeInfo(e,{transaction:a});if(c.revision!==n.assert_revision)throw new Pr(`revision '${c.revision}' does not match requested revision '${n.assert_revision}'`);if(c.address&&c.address.path===e&&t!==null&&!this.valueFitsInline(t))yield this._writeNodeWithTracking(e,t,{merge:!1,transaction:a,suppress_events:n.suppress_events,context:n.context});else{const u=yield a.moveToParentPath(o.parentPath);Te(u===o.parentPath,`transaction.moveToParentPath() did not move to the right parent path of "${e}"`),yield this._writeNodeWithTracking(o.parentPath,{[o.key]:t},{merge:!0,transaction:a,suppress_events:n.suppress_events,context:n.context})}}else{const c=yield a.moveToParentPath(o.parentPath);Te(c===o.parentPath,`transaction.moveToParentPath() did not move to the right parent path of "${e}"`),yield this.updateNode(o.parentPath,{[o.key]:t},{transaction:a,suppress_events:n.suppress_events,context:n.context})}n.transaction||(yield a.commit())}catch(c){throw n.transaction||(yield a.rollback(c)),c}})}updateNode(s,i){return k(this,arguments,function*(e,t,n={suppress_events:!1,context:null}){if(this.settings.readOnly)throw new Error("Database is opened in read-only mode");if(typeof t!="object")throw new Error("invalid updates argument");if(Object.keys(t).length===0)return;const o=n.transaction||(yield this._customImplementation.getTransaction({path:e,write:!0}));try{const a=yield this.getNodeInfo(e,{transaction:o}),c=T.get(e);if(a.exists&&a.address&&a.address.path===e)yield this._writeNodeWithTracking(e,t,{transaction:o,merge:!0,suppress_events:n.suppress_events,context:n.context});else if(a.exists){const u=T.get(e),l=yield o.moveToParentPath(u.parentPath);Te(l===u.parentPath,`transaction.moveToParentPath() did not move to the right parent path of "${e}"`),yield this._writeNodeWithTracking(u.parentPath,{[u.key]:t},{transaction:o,merge:!0,suppress_events:n.suppress_events,context:n.context})}else{const u=yield o.moveToParentPath(c.parentPath);Te(u===c.parentPath,`transaction.moveToParentPath() did not move to the right parent path of "${e}"`),yield this.updateNode(c.parentPath,{[c.key]:t},{transaction:o,suppress_events:n.suppress_events,context:n.context})}n.transaction||(yield o.commit())}catch(a){throw n.transaction||(yield o.rollback(a)),a}})}}class Fl{constructor(e=1e3,t){this.limit=e,this.options=t,this.added=0,this.scheduled=[],this.running=0,this.results=[],this.done=!1}execute(e,t){return k(this,null,function*(){var n,s;try{this.running++;const i=yield e();if(this.results[t]=i,this.running--,this.running===0&&this.scheduled.length===0)this.done=!0,(n=this.doneCallback)==null||n.call(this,this.results);else if(this.scheduled.length>0){const o=this.scheduled.shift();this.execute(o.task,o.index)}}catch(i){this.done=!0,(s=this.errorCallback)==null||s.call(this,i)}})}add(e){var n;if(this.done)throw new Error("Cannot add to a batch that has already finished. Use wait option and start batch processing manually if you are adding tasks in an async loop");const t=this.added++;((n=this.options)==null?void 0:n.wait)!==!0&&this.running<this.limit?this.execute(e,t):this.scheduled.push({task:e,index:t})}start(){for(;this.running<this.limit;){const e=this.scheduled.shift();this.execute(e.task,e.index)}}finish(){return k(this,null,function*(){return this.running===0&&this.scheduled.length===0?this.results:(yield new Promise((e,t)=>{this.doneCallback=e,this.errorCallback=t}),this.results)})}}const Ml=()=>{};function ho(s,i,o){return k(this,arguments,function*(r,e,t,n={snapshots:!1,include:void 0,exclude:void 0,child_objects:void 0,eventHandler:Ml}){var W,$,Y,j,L,J;typeof n!="object"&&(n={}),typeof n.snapshots=="undefined"&&(n.snapshots=!1);const a={};(W=r.storage.settings.transactions)!=null&&W.log&&(a.acebase_cursor=ke.generate());const c=t.filters.map(v=>V({},v)),u=t.order.map(v=>V({},v)),l=v=>{v.sort((_,E)=>{const b=A=>{const N=u[A],B=T.getPathKeys(typeof N.key=="number"?`[${N.key}]`:N.key),D=B.reduce((U,R)=>U!==null&&typeof U=="object"&&R in U?U[R]:null,_.val),P=B.reduce((U,R)=>U!==null&&typeof U=="object"&&R in U?U[R]:null,E.val);return D===null?P===null?0:N.ascending?-1:1:P===null?N.ascending?1:-1:D==P?A<u.length-1?b(A+1):_.path<E.path?-1:1:D<P?N.ascending?-1:1:N.ascending?1:-1};return b(0)})},f=(v,_)=>k(this,null,function*(){if(v.length===0)return[];const E=50,b=new Fl(E),A=[];return v.forEach(({path:N},B)=>b.add(()=>k(this,null,function*(){const P=(yield r.storage.getNode(N,_)).value;if(P===null){r.storage.debug.warn(`Indexed result "/${N}" does not have a record!`);return}const U={path:N,val:P};I.sorted?A[B]=U:(A.push(U),!I.skipped&&A.length>t.skip+Math.abs(t.take)&&(l(A),A.pop()))}))),yield b.finish(),A}),y=T.get(e),p=y.keys.some(v=>v==="*"||v.toString().startsWith("$")),d=r.storage.indexes.get(e),h=[];let m=()=>k(this,null,function*(){});if(p){const v=y.keys.filter(b=>typeof b=="string"&&b.startsWith("$")),_=v.length>0&&v.every(b=>t.filters.some(A=>A.key===b&&["==","in"].includes(A.op))),E=typeof n.monitor=="object"&&[($=n.monitor)==null?void 0:$.add,(Y=n.monitor)==null?void 0:Y.change,(j=n.monitor)==null?void 0:j.remove].some(b=>b===!0);if(_&&!E){const b=[];for(const R of v){const H=t.filters.filter(X=>X.key===R).reduce((X,Z)=>{if(Z.op==="=="&&X.push(Z.compare),Z.op==="in"){if(!(Z.compare instanceof Array))throw new Error("compare argument for 'in' operator must be an Array");X.push(...Z.compare)}return X},[]),te=b.splice(0);H.forEach(X=>{te.length===0?b.push({[R]:X}):b.push(...te.map(Z=>we(V({},Z),{[R]:X})))})}const A=t.filters.filter(R=>!v.includes(R.key)),N=b.map(R=>T.get(T.getPathKeys(e).map(K=>{var H;return(H=R[K])!=null?H:K})).path),B=t.order.length>0,D=N.map(R=>{var K;return ho(r,R,{filters:A,take:0,skip:0,order:[]},{snapshots:B,cache_mode:n.cache_mode,include:[...(K=n.include)!=null?K:[],...t.order.map(H=>H.key)],exclude:n.exclude})});let U=(yield Promise.all(D)).reduce((R,K)=>(R.push(...K.results),R),[]);if(B&&l(U),t.skip>0&&U.splice(0,t.skip),t.take>0&&U.splice(t.take),n.snapshots&&(!B||((L=n.include)==null?void 0:L.length)>0||((J=n.exclude)==null?void 0:J.length)>0||!n.child_objects)){const{include:R,exclude:K,child_objects:H}=n;U=yield f(U,{include:R,exclude:K,child_objects:H})}return{results:U,context:null,stop:m}}else if(d.length===0){const b=new Error(`Query on wildcard path "/${e}" requires an index`);return Promise.reject(b)}if(c.length===0){const b=d.filter(A=>A.type==="normal")[0];c.push({key:b.key,op:"!=",compare:null})}}c.forEach(v=>{if(v.index)return;const _=d.filter(E=>E.key===v.key).filter(E=>E.validOperators.includes(v.op));if(_.length>=1){const E=c.filter(B=>B!==v).map(B=>B.key),b=u.map(B=>B.key).filter(B=>B!==v.key),A=_.map(B=>{const D=B.includeKeys.concat(B.key),P=D.filter(H=>E.includes(H)),U=D.filter(H=>b.includes(H)),R=P.concat(U.filter(H=>!P.includes(H))),K={filters:P.length,sorting:U.length*(t.take!==0?U.length:1),both:R.length*R.length,get total(){return this.filters+this.sorting+this.both}};return{index:B,points:K.total,filterKeys:P,sortKeys:U}});A.sort((B,D)=>B.points>D.points?-1:1);const N=A[0];v.index=N.index,N.filterKeys.forEach(B=>{c.filter(D=>D!==v&&D.key===B).forEach(D=>{!Xr.validOperators.includes(D.op)||(D.indexUsage="filter",D.index=N.index)})}),N.sortKeys.forEach(B=>{u.filter(D=>D.key===B).forEach(D=>{D.index=N.index})})}v.index&&h.push({index:v.index,description:v.index.description})}),u.length>0&&t.take!==0&&c.length===0&&u.forEach(v=>{v.index||(v.index=d.filter(_=>_.key===v.key).find(_=>_.type==="normal"))});const g=h.map(v=>v.description).join(", ");h.length>0&&r.storage.debug.log(`Using indexes for query: ${g}`);const w=c.filter(v=>!v.index),x=/^[a-z]+:/i;if(w.some(v=>x.test(v.op))){const v=w.find(E=>x.test(E.op)),_=new Error(`query contains operator "${v.op}" which requires a special index that was not found on path "${e}", key "${v.key}"`);return Promise.reject(_)}const S=["<","<=","==","!=",">=",">","like","!like","in","!in","matches","!matches","between","!between","has","!has","contains","!contains","exists","!exists"];for(let v=0;v<w.length;v++){const _=w[v];if(!S.includes(_.op))return Promise.reject(new Error(`query contains unknown filter operator "${_.op}" on path "${e}", key "${_.key}"`))}if(p&&w.length>0){const v=w.reduce((E,b)=>(E.indexOf(b.key)<0&&E.push(b.key),E),[]).map(E=>`"${E}"`),_=new Error(`This wildcard path query on "/${e}" requires index(es) on key(s): ${v.join(", ")}. Create the index(es) and retry`);return Promise.reject(_)}const O=[];c.forEach(v=>{if(v.index&&v.indexUsage!=="filter"){let _=v.index.query(v.op,v.compare).then(b=>(n.eventHandler&&n.eventHandler({name:"stats",type:"index_query",source:v.index.description,stats:b.stats}),b.hints.length>0&&n.eventHandler&&n.eventHandler({name:"hints",type:"index_query",source:v.index.description,hints:b.hints}),b));const E=c.filter(b=>b.index===v.index&&b.indexUsage==="filter");E.length>0&&(_=_.then(b=>(E.forEach(A=>{const{key:N,op:B,index:D}=A;let{compare:P}=A;typeof P=="string"&&!D.caseSensitive&&(P=P.toLocaleLowerCase(D.textLocale)),b=b.filterMetadata(N,B,P)}),b))),O.push(_)}});const I={filtered:c.length===0,skipped:t.skip===0,taken:t.take===0,sorted:u.length===0,preDataLoaded:!1,dataLoaded:!1};if(c.length===0&&t.take===0&&(r.storage.debug.warn(`Filterless queries must use .take to limit the results. Defaulting to 100 for query on path "${e}"`),t.take=100),u.length>0&&u[0].index){const v=u[0].index,_=t.take<0?!u[0].ascending:u[0].ascending;if(c.length===0&&u.slice(1).every(E=>v.allMetadataKeys.includes(E.key))){r.storage.debug.log(`Using index for sorting: ${v.description}`);const E=u.slice(1).map(A=>(A.index=v,{key:A.key,ascending:A.ascending})),b=v.take(t.skip,Math.abs(t.take),{ascending:_,metadataSort:E}).then(A=>(n.eventHandler&&n.eventHandler({name:"stats",type:"sort_index_take",source:v.description,stats:A.stats}),A.hints.length>0&&n.eventHandler&&n.eventHandler({name:"hints",type:"sort_index_take",source:v.description,hints:A.hints}),A));O.push(b),I.skipped=!0,I.taken=!0,I.sorted=!0}}return Promise.all(O).then(v=>k(this,null,function*(){let _=[];if(v.length===1){const P=v[0];_=P.map(U=>{const R={key:U.key,path:U.path,val:{[P.filterKey]:U.value}};return U.metadata&&Object.assign(R.val,U.metadata),R}),I.filtered=!0}else if(v.length>1){v.sort((R,K)=>R.length<K.length?-1:1);const P=v[0],U=v.slice(1);_=P.reduce((R,K)=>{const H={key:K.key,path:K.path,val:{[P.filterKey]:K.value}};return U.every(X=>X.findIndex(Z=>Z.path===K.path)>=0)&&(K.metadata&&Object.assign(H.val,K.metadata),U.forEach(X=>{const Z=X.find(_e=>_e.path===H.path);H.val[X.filterKey]=Z.value,Z.metadata&&Object.assign(H.val,Z.metadata)}),R.push(H)),R},[]),I.filtered=!0}if(p||O.length>0&&w.length===0){if(u.length===0||u.every(P=>P.index)){if(I.preDataLoaded=!0,!I.sorted&&u.length>0&&l(_),I.sorted=!0,!I.skipped&&t.skip>0&&(_=t.take<0?_.slice(0,-t.skip):_.slice(t.skip)),!I.taken&&t.take!==0&&(_=t.take<0?_.slice(t.take):_.slice(0,t.take)),I.skipped=!0,I.taken=!0,!n.snapshots)return _;const P={include:n.include,exclude:n.exclude,child_objects:n.child_objects};return f(_,P).then(U=>(I.dataLoaded=!0,U))}if(n.snapshots||!I.sorted){const P=u.length>0,U=P?{include:u.map(R=>R.key)}:{include:n.include,exclude:n.exclude,child_objects:n.child_objects};return f(_,U).then(R=>(u.length>0&&l(R),I.sorted=!0,t.skip>0&&(R=t.take<0?R.slice(0,-t.skip):R.slice(t.skip)),t.take!==0&&(R=t.take<0?R.slice(t.take):R.slice(0,t.take)),I.skipped=!0,I.taken=!0,n.snapshots&&P?f(R,{include:n.include,exclude:n.exclude,child_objects:n.child_objects}):R))}else return _}let E;_.length>0&&(E=_.map(P=>P.key));let b=[],A=!1;const N=u.length>0,B=N?{include:u.map(P=>P.key)}:{include:n.include,exclude:n.exclude,child_objects:n.child_objects},D={promises:[],add(P){if(this.promises.push(P),this.promises.length>=1e3)return Promise.all(this.promises.splice(0)).then(U=>{})}};try{yield r.storage.getChildren(e,{keyFilter:E,async:!0}).next(P=>{if(P.type!==F.OBJECT||!P.address)return;if(A)return!1;const U=()=>k(this,null,function*(){if(!(yield r.storage.matchNode(P.address.path,w)))return;const H=P.address.path;let te;if(n.snapshots||u.length>0){const X=yield r.storage.getNode(H,B);te={path:H,val:X.value}}else te={path:H};b.push(te),t.take!==0&&b.length>Math.abs(t.take)+t.skip&&(u.length>0?l(b):t.take>0&&(A=!0),b.pop())}),R=D.add(U());if(R instanceof Promise)return R})}catch(P){return P instanceof Qr||r.storage.debug.warn(`Error getting child stream: ${P}`),[]}return yield Promise.all(D.promises),I.preDataLoaded=N,I.dataLoaded=!N,u.length>0&&l(b),I.sorted=!0,t.skip>0&&(b=t.take<0?b.slice(0,-t.skip):b.slice(t.skip)),I.skipped=!0,t.take!==0&&(b=t.take<0?b.slice(t.take):b.slice(0,t.take)),I.taken=!0,I.dataLoaded||(b=yield f(b,{include:n.include,exclude:n.exclude,child_objects:n.child_objects}),I.dataLoaded=!0),b})).then(v=>{if(!I.sorted&&u.length>0&&l(v),n.snapshots||(v=v.map(_=>_.path)),!I.skipped&&t.skip>0&&(v=t.take<0?v.slice(0,-t.skip):v.slice(t.skip)),!I.taken&&t.take!==0&&(v=t.take<0?v.slice(t.take):v.slice(0,t.take)),n.monitor===!0&&(n.monitor={add:!0,change:!0,remove:!0}),typeof n.monitor=="object"&&(n.monitor.add||n.monitor.change||n.monitor.remove)){const _=n.monitor,E=n.snapshots?v.map(R=>R.path):v.slice(),b=r.db.ref(e),A=R=>{const K=E.indexOf(R);K<0||E.splice(K,1)},N=R=>{E.includes(R)||E.push(R)},B=()=>{r.unsubscribe(b.path,"child_changed",D),r.unsubscribe(b.path,"child_added",P),r.unsubscribe(b.path,"notify_child_removed",U)};m=()=>k(this,null,function*(){B()});const D=(R,K,H,te)=>k(this,null,function*(){const X=E.includes(K);let Z=!0;const _e=[];c.forEach(oe=>!_e.includes(oe.key)&&_e.push(oe.key));const ae=[];typeof te=="object"&&Object.keys(te).forEach(oe=>!ae.includes(oe)&&ae.push(oe)),typeof H=="object"&&Object.keys(H).forEach(oe=>!ae.includes(oe)&&ae.push(oe));const ce=[];let me=ae.every(oe=>_e.includes(oe)?c.filter(ue=>ue.key===oe).every(ue=>{var je;return((je=ue.index)==null?void 0:je.textLocaleKey)&&!ae.includes(ue.index.textLocaleKey)?(ce.push(ue.index.textLocaleKey),!0):S.includes(ue.op)?r.storage.test(H[oe],ue.op,ue.compare):ue.index.test(H,ue.op,ue.compare)}):!0);if(me&&(ce.push(..._e.filter(oe=>!ae.includes(oe))),!X&&ce.length>0)){const oe=c.filter(je=>ce.includes(je.key)),Se=oe.filter(je=>S.includes(je.op)),ue=oe.filter(je=>!S.includes(je.op));if(Se.length>0&&(me=yield r.storage.matchNode(K,Se)),me&&ue.length>0){const je=ue.reduce((Qe,kt)=>(Qe.includes(kt.key)||Qe.push(kt.key),kt.index instanceof fo&&kt.index.config.localeKey&&!Qe.includes(kt.index.config.localeKey)&&Qe.push(kt.index.config.localeKey),Qe),[]),Ae=yield r.storage.getNode(K,{include:je});if(Ae.value===null)return!1;me=ue.every(Qe=>Qe.index.test(Ae.value,Qe.op,Qe.compare))}}if(me){if(X||N(K),n.snapshots){const oe={include:n.include,exclude:n.exclude,child_objects:n.child_objects};H=(yield r.storage.getNode(K,oe)).value}X&&_.change?Z=n.eventHandler({name:"change",path:K,value:H})!==!1:!X&&_.add&&(Z=n.eventHandler({name:"add",path:K,value:H})!==!1)}else X&&(A(K),_.remove&&(Z=n.eventHandler({name:"remove",path:K,value:te})!==!1));Z===!1&&B()}),P=(R,K,H)=>{const te=c.every(Z=>S.includes(Z.op)?r.storage.test(H[Z.key],Z.op,Z.compare):Z.index.test(H,Z.op,Z.compare));let X=!0;te&&(N(K),_.add&&(X=n.eventHandler({name:"add",path:K,value:n.snapshots?H:null})!==!1)),X===!1&&B()},U=(R,K,H,te)=>{let X=!0;A(K),_.remove&&(X=n.eventHandler({name:"remove",path:K,value:n.snapshots?te:null})!==!1),X===!1&&B()};(n.monitor.add||n.monitor.change||n.monitor.remove)&&r.subscribe(b.path,"child_changed",D),n.monitor.remove&&r.subscribe(b.path,"notify_child_removed",U),n.monitor.add&&r.subscribe(b.path,"child_added",P)}return{results:v,context:a,stop:m}})})}class Kl extends pl{constructor(e="default",t,n){super(),this.db=t.db;const s={logLevel:t.settings.logLevel};if(typeof t.settings.storage=="object")if(Xs&&t.settings.storage instanceof Xs)this.storage=new El(e,t.settings.storage,s);else if(Zs&&t.settings.storage instanceof Zs)this.storage=new kl(e,t.settings.storage,s);else if(Vt&&t.settings.storage instanceof Vt)this.storage=new Ul(e,t.settings.storage,s);else{const i=t.settings.storage instanceof cr?t.settings.storage:new cr(t.settings.storage);this.storage=new Or(e,i,s)}else this.storage=new Or(e,new cr,s);this.storage.on("ready",n)}stats(e){return k(this,null,function*(){return this.storage.stats})}subscribe(e,t,n){this.storage.subscriptions.add(e,t,n)}unsubscribe(e,t,n){this.storage.subscriptions.remove(e,t,n)}set(s,i){return k(this,arguments,function*(e,t,n={suppress_events:!1,context:null}){const o=yield this.storage.setNode(e,t,{suppress_events:n.suppress_events,context:n.context});return V({},o&&{cursor:o})})}update(s,i){return k(this,arguments,function*(e,t,n={suppress_events:!1,context:null}){const o=yield this.storage.updateNode(e,t,{suppress_events:n.suppress_events,context:n.context});return V({},o&&{cursor:o})})}get transactionLoggingEnabled(){return this.storage.settings.transactions&&this.storage.settings.transactions.log===!0}get(e,t){return k(this,null,function*(){if(t||(t={}),typeof t.include!="undefined"&&!(t.include instanceof Array))throw new TypeError("options.include must be an array of key names");if(typeof t.exclude!="undefined"&&!(t.exclude instanceof Array))throw new TypeError("options.exclude must be an array of key names");if(["undefined","boolean"].indexOf(typeof t.child_objects)<0)throw new TypeError("options.child_objects must be a boolean");const n=yield this.storage.getNode(e,t);return{value:n.value,context:{acebase_cursor:n.cursor},cursor:n.cursor}})}transaction(s,i){return k(this,arguments,function*(e,t,n={suppress_events:!1,context:null}){const o=yield this.storage.transactNode(e,t,{suppress_events:n.suppress_events,context:n.context});return V({},o&&{cursor:o})})}exists(e){return k(this,null,function*(){return(yield this.storage.getNodeInfo(e)).exists})}query(s,i){return k(this,arguments,function*(e,t,n={snapshots:!1}){return yield ho(this,e,t,n)})}createIndex(e,t,n){return this.storage.indexes.create(e,t,n)}getIndexes(){return k(this,null,function*(){return this.storage.indexes.list()})}deleteIndex(e){return k(this,null,function*(){return this.storage.indexes.delete(e)})}reflect(e,t,n){return k(this,null,function*(){n=n||{};const s=(i,o=50,a=0,c=null)=>k(this,null,function*(){typeof o=="string"&&(o=parseInt(o)),typeof a=="string"&&(a=parseInt(a)),["null","undefined"].includes(c)&&(c=null);const u=[];let l=0,f=!1,y=!1;return yield this.storage.getChildren(i).next(p=>{if(f)return y=!0,!1;l++,(c!==null?p.key>c:a===0||l>a)&&u.push(V({key:typeof p.key=="string"?p.key:p.index,type:p.valueTypeName,value:p.value},typeof p.address=="object"&&"pageNr"in p.address&&{address:{pageNr:p.address.pageNr,recordNr:p.address.recordNr}})),f=o>0&&u.length===o}).catch(p=>{if(!(p instanceof Qr))throw p}),{more:y,list:u}});switch(t){case"children":return yield s(e,n.limit,n.skip,n.from);case"info":{const i={key:"",exists:!1,type:"unknown",value:void 0,address:void 0,children:{count:0,more:!1,list:[]}},o=yield this.storage.getNodeInfo(e,{include_child_count:n.child_count===!0});i.key=typeof o.key!="undefined"?o.key:o.index,i.exists=o.exists,i.type=o.exists?o.valueTypeName:void 0,i.value=o.value,i.address=typeof o.address=="object"&&"pageNr"in o.address?{pageNr:o.address.pageNr,recordNr:o.address.recordNr}:void 0;const a=o.exists&&o.address&&[F.OBJECT,F.ARRAY].includes(o.type);return n.child_count===!0?i.children={count:a?o.childCount:0}:typeof n.child_limit=="number"&&n.child_limit>0&&a&&(i.children=yield s(e,n.child_limit,n.child_skip,n.child_from)),i}}})}export(e,t,n={format:"json",type_safe:!0}){return this.storage.exportNode(e,t,n)}import(e,t,n={format:"json",suppress_events:!1,method:"set"}){return this.storage.importNode(e,t,n)}setSchema(e,t,n=!1){return k(this,null,function*(){return this.storage.setSchema(e,t,n)})}getSchema(e){return k(this,null,function*(){return this.storage.getSchema(e)})}getSchemas(){return k(this,null,function*(){return this.storage.getSchemas()})}validateSchema(e,t,n){return k(this,null,function*(){return this.storage.validateSchema(e,t,{updates:n})})}getMutations(e){return k(this,null,function*(){if(typeof this.storage.getMutations!="function")throw new Error("Used storage type does not support getMutations");if(typeof e!="object")throw new Error("No filter specified");if(typeof e.cursor!="string"&&typeof e.timestamp!="number")throw new Error("No cursor or timestamp given");return this.storage.getMutations(e)})}getChanges(e){return k(this,null,function*(){if(typeof this.storage.getChanges!="function")throw new Error("Used storage type does not support getChanges");if(typeof e!="object")throw new Error("No filter specified");if(typeof e.cursor!="string"&&typeof e.timestamp!="number")throw new Error("No cursor or timestamp given");return this.storage.getChanges(e)})}}class Vl extends Zr{constructor(e){super(e),this.temp=!1,this.multipleTabs=!1,typeof e.temp=="boolean"&&(this.temp=e.temp),typeof e.provider=="object"&&(this.provider=e.provider),typeof e.multipleTabs=="boolean"&&(this.multipleTabs=e.multipleTabs),typeof e.logLevel=="string"&&(this.logLevel=e.logLevel),typeof e.sponsor=="boolean"&&(this.sponsor=e.sponsor),["type","ipc","path"].forEach(t=>{t in e&&console.warn(`${t} setting is not supported for AceBase LocalStorage`)})}}class zl extends es{constructor(e,t){super(t),this.context=e,this._storageKeysPrefix=`${this.context.dbname}.acebase::`}commit(){return k(this,null,function*(){})}rollback(e){return k(this,null,function*(){})}get(e){return k(this,null,function*(){const t=this.context.localStorage.getItem(this.getStorageKeyForPath(e));return JSON.parse(t)})}set(e,t){return k(this,null,function*(){const n=JSON.stringify(t);this.context.localStorage.setItem(this.getStorageKeyForPath(e),n)})}remove(e){return k(this,null,function*(){this.context.localStorage.removeItem(this.getStorageKeyForPath(e))})}childrenOf(e,t,n,s){return k(this,null,function*(){const i=Kt.PathInfo.get(e);for(let o=0;o<this.context.localStorage.length;o++){const a=this.context.localStorage.key(o);if(!a.startsWith(this._storageKeysPrefix))continue;const c=this.getPathFromStorageKey(a);if(i.isParentOf(c)&&n(c)){let u;if(t.metadata||t.value){const f=this.context.localStorage.getItem(a);u=JSON.parse(f)}if(!s(c,u))break}}})}descendantsOf(e,t,n,s){return k(this,null,function*(){const i=Kt.PathInfo.get(e);for(let o=0;o<this.context.localStorage.length;o++){const a=this.context.localStorage.key(o);if(!a.startsWith(this._storageKeysPrefix))continue;const c=this.getPathFromStorageKey(a);if(i.isAncestorOf(c)&&n(c)){let u;if(t.metadata||t.value){const f=this.context.localStorage.getItem(a);u=JSON.parse(f)}if(!s(c,u))break}}})}getPathFromStorageKey(e){return e.slice(this._storageKeysPrefix.length)}getStorageKeyForPath(e){return`${this._storageKeysPrefix}${e}`}}function Wl(r,e={}){const t=new Vl(e),n=t.provider?t.provider:t.temp?window.localStorage:window.sessionStorage,s=new Vt({name:"LocalStorage",locking:!0,removeVoidProperties:t.removeVoidProperties,maxInlineValueSize:t.maxInlineValueSize,ready(){return k(this,null,function*(){})},getTransaction(a){return k(this,null,function*(){const c={debug:!0,dbname:r,localStorage:n};return new zl(c,a)})}}),i=new Gt(r,{logLevel:t.logLevel,storage:s,sponsor:t.sponsor});return i.settings.ipcEvents=t.multipleTabs===!0,i}class Hl extends Zr{constructor(e){super(e),this.multipleTabs=!1,this.cacheSeconds=60,this.sponsor=!1,typeof e.logLevel=="string"&&(this.logLevel=e.logLevel),typeof e.multipleTabs=="boolean"&&(this.multipleTabs=e.multipleTabs),typeof e.cacheSeconds=="number"&&(this.cacheSeconds=e.cacheSeconds),typeof e.sponsor=="boolean"&&(this.sponsor=e.sponsor),["type","ipc","path"].forEach(t=>{t in e&&console.warn(`${t} setting is not supported for AceBase IndexedDBStorage`)})}}class po extends ao{constructor(e={}){super(e),e.storage&&(this.storage=e.storage,e.ipc&&(this.storage.ipc=e.ipc),e.transactions&&(this.storage.transactions=e.transactions))}}class Jl extends dl{constructor(e,t={}){const n=new po(t);super(e,n),this.recovery={repairNode:(i,o)=>k(this,null,function*(){if(yield this.ready(),this.api.storage instanceof Or)yield this.api.storage.repairNode(i,o);else if(!this.api.storage.repairNode)throw new Error("repairNode is not supported with chosen storage engine")}),repairNodeTree:i=>k(this,null,function*(){yield this.ready(),yield this.api.storage.repairNodeTree(i)})};const s={db:this,settings:n};this.api=new Kl(e,s,()=>{this.emit("ready")})}close(){return k(this,null,function*(){yield this.api.storage.close()})}get settings(){const e=this.api.storage.ipc,t=this.debug;return{get logLevel(){return t.level},set logLevel(n){t.setLevel(n)},get ipcEvents(){return e.eventsEnabled},set ipcEvents(n){e.eventsEnabled=n}}}static WithLocalStorage(e,t={}){return Wl(e,t)}static WithIndexedDB(e,t={}){throw new Error("IndexedDB storage can only be used in browser contexts")}}function ni(r){return new Promise((e,t)=>{r.onsuccess=n=>e(r.result||null),r.onerror=t})}class ql extends es{constructor(e,t){super(t),this.context=e,this.production=!0,this._pending=[]}_createTransaction(e=!1){return this.context.db.transaction(["nodes","content"],e?"readwrite":"readonly")}_splitMetadata(e){const t=e.value,n=V({},e);return delete n.value,{metadata:n,value:t}}commit(){return k(this,null,function*(){if(this._pending.length===0)return;const e=this._pending.splice(0);this.context.ipc.sendNotification({action:"cache.invalidate",paths:e.map(n=>n.path)});const t=this._createTransaction(!0);try{yield new Promise((n,s)=>{let i=!1,o=0;const a=u=>{i=!0,s(u)},c=()=>{++o===e.length&&n()};e.forEach((u,l)=>{if(i)return;let f,y;const p=u.path;if(u.action==="set"){const{metadata:h,value:m}=this._splitMetadata(u.node),g={path:p,metadata:h};f=t.objectStore("nodes").put(g),y=t.objectStore("content").put(m,p),this.context.cache.set(p,u.node)}else u.action==="remove"?(f=t.objectStore("content").delete(p),y=t.objectStore("nodes").delete(p),this.context.cache.set(p,null)):a(new Error(`Unknown pending operation "${u.action}" on path "${p}" `));let d=0;f.onsuccess=y.onsuccess=()=>{++d===2&&c()},f.onerror=y.onerror=a})}),t.commit&&t.commit()}catch(n){throw console.error(n),t.abort&&t.abort(),n}})}rollback(e){return k(this,null,function*(){this._pending=[]})}get(e){return k(this,null,function*(){if(this.context.cache.has(e))return this.context.cache.get(e);const t=this._createTransaction(!1),n=ni(t.objectStore("nodes").get(e)),s=ni(t.objectStore("content").get(e));try{const i=yield Promise.all([n,s]);t.commit&&t.commit();const o=i[0];if(!o)return this.context.cache.set(e,null),null;const a=o.metadata;return a.value=i[1],this.context.cache.set(e,a),a}catch(i){throw console.error("IndexedDB get error",i),t.abort&&t.abort(),i}})}set(e,t){this._pending.push({action:"set",path:e,node:t})}remove(e){this._pending.push({action:"remove",path:e})}removeMultiple(e){return k(this,null,function*(){e.forEach(t=>{this._pending.push({action:"remove",path:t})})})}childrenOf(e,t,n,s){return this._getChildrenOf(e,we(V({},t),{descendants:!1}),n,s)}descendantsOf(e,t,n,s){return this._getChildrenOf(e,we(V({},t),{descendants:!0}),n,s)}_getChildrenOf(e,t,n,s){return new Promise((i,o)=>{const a=Kt.PathInfo.get(e),c=this._createTransaction(!1),u=c.objectStore("nodes"),l=IDBKeyRange.lowerBound(e,!0),f=t.metadata?u.openCursor(l):u.openKeyCursor(l);f.onerror=y=>{var p;(p=c.abort)==null||p.call(c),o(y)},f.onsuccess=y=>k(this,null,function*(){var h,m,g;const p=(m=(h=f.result)==null?void 0:h.key)!=null?m:null;let d=!0;if(p===null)d=!1;else if(!a.isAncestorOf(p))d=!1;else if(t.descendants||a.isParentOf(p)){let w;if(t.metadata&&(w=f.result.value.metadata),n(p,w)){if(t.value)if(this.context.cache.has(p)){const S=this.context.cache.get(p);w.value=S.value}else{const S=c.objectStore("content").get(p);w.value=yield new Promise((O,I)=>{S.onerror=W=>{O(null)},S.onsuccess=W=>{O(S.result)}}),this.context.cache.set(p,w.value===null?null:w)}d=s(p,w)}}if(d)try{f.result.continue()}catch(w){d=!1}d||((g=c.commit)==null||g.call(c),i())})})}}function Yl(r,e={}){const t=new Hl(e),s=(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB).open(`${r}.acebase`,1);s.onupgradeneeded=y=>{const p=s.result;p.createObjectStore("nodes",{keyPath:"path"}),p.createObjectStore("content")};let i;const o=new Promise((y,p)=>{s.onsuccess=d=>{i=s.result,y()},s.onerror=d=>{p(d)}}),a=new gl(typeof t.cacheSeconds=="number"?t.cacheSeconds:60),c=new Vt({name:"IndexedDB",locking:!0,removeVoidProperties:t.removeVoidProperties,maxInlineValueSize:t.maxInlineValueSize,lockTimeout:t.lockTimeout,ready(){return o},getTransaction(y){return k(this,null,function*(){yield o;const p={debug:!1,db:i,cache:a,ipc:l};return new ql(p,y)})}}),u=new Gt(r,{logLevel:t.logLevel,storage:c,sponsor:t.sponsor}),l=u.api.storage.ipc;return u.settings.ipcEvents=t.multipleTabs===!0,l.on("notification",y=>k(this,null,function*(){const p=y.data;if(typeof p=="object"&&p.action==="cache.invalidate")for(const d of p.paths)a.remove(d)})),u}const Gl=`Using AceBase constructor in the browser to use localStorage is deprecated!
Switch to:
IndexedDB implementation (FASTER, MORE RELIABLE):
    let db = AceBase.WithIndexedDB(name, settings)
Or, new LocalStorage implementation:
    let db = AceBase.WithLocalStorage(name, settings)
Or, write your own CustomStorage adapter:
    let myCustomStorage = new CustomStorageSettings({ ... });
    let db = new AceBase(name, { storage: myCustomStorage })`;class Gt extends Jl{constructor(e,t){if(typeof t!="object"||typeof t.storage!="object")throw new Error(Gl);super(e,t),this.settings.ipcEvents=t.multipleTabs===!0}static WithIndexedDB(e,t={}){return Yl(e,t)}}const Ql={AceBase:Gt,AceBaseLocalSettings:po,DataReference:ze,DataSnapshot:le,EventSubscription:Hi,PathReference:fe,TypeMappings:ro,CustomStorageSettings:Vt,CustomStorageTransaction:es,CustomStorageHelpers:Kt,ID:ke,proxyAccess:bn,DataSnapshotsArray:Mn};window.acebase=Ql;window.AceBase=Gt;let Xl=()=>Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),fr=(()=>"/ps"+Xl()+"/pe")();const un={create:"/create",find:"/find",get:"/get",query:"/get",update:"/update",delete:"/delete",req:"/custom",upload:"/upload",send:"/send",user:{base:"/user",example:"/user/device-connected",join:"",status:"/user/status",device:{connected:"/user/device-connected",removed:"/user/device-removed",disconnected:"/user/device-disconnected"}}},ln={user:{base:"/user",device:{remove:"/user/device-remove",list:"/user/device-list"}},users:{base:"/users",device:{list:"/users/device-list"}}},Me={base:"/auth",login:"/login/get-one",verify_token_code:"/verify-token-code/get-one",verify_pass_code:"/verify-pass-code/get-one",verify_email_code:"/verify-email-code/get-one",req:"/custom",user:"/user/"+fr+"/get-one",register:"/register/get-one",forgotPassword:"/forgot-password/get-one"+fr+"/get-one",deleteAccount:"/delete-account/get-one",refreshToken:"/refresh-token"+fr+"/get-one",users:{base:"/users"}};var Ot,Jt,Nn,yt,Pt;class Zl{constructor(e={}){_t(this,Ot,!0);_t(this,Jt,void 0);_t(this,Nn,void 0);_t(this,yt,void 0);_t(this,Pt,void 0);bs(this,"init",e=>{var p;let{ENV:t,HOST_SERVER:n,API_VERSION:s}=Fe(this,yt);const i=(d={})=>{let h={};return d&&Object.keys(d).length>0&&(h.data=d),h};let o=(d,h)=>k(this,null,function*(){var m,g,w,x,S,O,I,W;if(((m=d==null?void 0:d.error)==null?void 0:m.token)&&Fe(this,Ot)){if(tn(this,Ot,!1),localStorage.getItem("refreshToken")){t==="dev"&&console.log("Token expired or not found: ",(g=d.error)==null?void 0:g.token," Trying to request a new refresh token");let $=yield(x=(w=this==null?void 0:this.init(e))==null?void 0:w.auth())==null?void 0:x.req(Me.refreshToken,{token:localStorage.getItem("refreshToken")}).val();if($!=null&&$.error)return t==="dev"&&console.log("Refresh token expired or not found: ",$),Fe(this,Jt)&&(window.top.location.href=Fe(this,Jt)),$;if($!=null&&$.data&&(t==="dev"&&console.log("We got a new refresh token ,",$==null?void 0:$.data),(S=$==null?void 0:$.data)!=null&&S.token&&localStorage.setItem("accessToken",(O=$==null?void 0:$.data)==null?void 0:O.token),(I=$==null?void 0:$.data)!=null&&I.refreshToken&&localStorage.setItem("refreshToken",(W=$==null?void 0:$.data)==null?void 0:W.refreshToken),t==="dev"&&console.log("Trying to restart your request..."),typeof h=="function"))return yield h()}}else return d}),a=Ms.init(Fe(this,yt)),c=(d="",h={},m={},g={},w)=>{d=d.trim(),d.charAt(d.length-1)==="/"&&(d=d.slice(0,-1));let S=(()=>k(this,null,function*(){let O=()=>k(this,null,function*(){return yield a("post",n.AUTH+s.AUTH+Me.base+d,i(h))}),I=yield O();return Fe(this,Ot)&&(I=yield o(I,()=>k(this,null,function*(){return yield O()}))),typeof w=="function"&&w(we(V({},g),{value:I})),I}))();return we(V({},g),{val:()=>S})},u=()=>Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),l=({value:d,node:h},m)=>{var w,x,S,O;let g=d;if((w=g==null?void 0:g.data)!=null&&w.data){let I=(x=g==null?void 0:g.data)==null?void 0:x.data,W=(S=g==null?void 0:g.data)==null?void 0:S.refreshToken,$=(O=g==null?void 0:g.data)==null?void 0:O.token;$&&localStorage.setItem("accessToken",$),W&&localStorage.setItem("refreshToken",W),I&&localStorage.setItem("userInfo",JSON.stringify(I))}typeof m=="function"&&m(we(V({},h),{value:g}))},f=(d,h)=>{typeof d=="function"&&(h==null||h.on("connect",d))},y=(d,h)=>{var w;let m="%"+d,g=(w=this.init(e))==null?void 0:w.auth();return{$connected:Fe(this,Nn),private:(x=u())=>g.event(d+x),child:x=>g.event(d+x),push:(x,S)=>{let O=g.event(d);return h==null||h.emit(m,x),typeof S=="function"&&(O==null||O.onValue(S)),V(V({},O),g)},onValue:x=>{let S=g.event(d);return h==null||h.on(m,O=>{typeof x=="function"&&x(we(V(V({},S),g),{value:O}))}),V(V({},S),g)},onAnyValue:x=>(h==null||h.onAny((S,O)=>{let I=g.event(S);typeof x=="function"&&x(S,V(V({value:O},I),g))}),V({},g))}};return{activity:()=>{let d=this.init(e);return{onStart:h=>(typeof h=="function"&&document.addEventListener("DOMContentLoaded",h),V(V({},d),d.activity())),onCreate:h=>(typeof h=="function"&&(window.onload=h),V(V({},d),d.activity())),onPause:h=>(window.addEventListener("beforeunload",function(m){typeof h=="function"&&h(),m.returnValue="onbeforeunload"}),V(V({},d),d.activity())),onResume:()=>V(V({},d),d.activity()),onLeave:h=>(typeof h=="function"&&(window.onunload=h),V(V({},d),d.activity()))}},socket:{auth:(p=e==null?void 0:e.socket)==null?void 0:p.auth},$randomUID:()=>Bu(),$randomId:()=>u(),$axios:Ms,$online:navigator==null?void 0:navigator.onLine,auth:()=>{var d;return{$io:(d=e==null?void 0:e.socket)==null?void 0:d.auth,connected:()=>{var h,m;return(m=(h=e==null?void 0:e.socket)==null?void 0:h.auth)==null?void 0:m.connected},event:h=>{var m;return y(h,(m=e==null?void 0:e.socket)==null?void 0:m.auth)},ready:h=>{var m;return f(h,(m=e==null?void 0:e.socket)==null?void 0:m.auth)},$currentUserId:(()=>{let h=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");return h.uid?h.uid:!1})(),$status:(()=>{let h=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");if(h.status)return h.status})(),status:(...h)=>{var S,O,I,W;let m,g,w=this.init(e);if(delete w.auth().login,delete w.auth().register,h.length===1)typeof h[0]=="string"?m=h[0]:typeof h[0]=="function"&&(g=h[0]);else if(h.length>=2){const[$,Y]=h;typeof $=="string"&&(m=$),g=Y}let x=(O=(S=e==null?void 0:e.socket)==null?void 0:S.auth)==null?void 0:O.id;if(x){if(!m){let $=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");$.uid&&(m=$.uid)}m&&x&&((W=(I=e==null?void 0:e.socket)==null?void 0:I.auth)==null||W.on((s==null?void 0:s.AUTH)+un.user.status,$=>{t==="dev"&&console.log("The user with id: ",m," is disconnected/connected: ",$==null?void 0:$.value),typeof g=="function"&&g(V({value:$},w))}))}return V({},w)},device:{connected:(...h)=>{var S,O,I,W;let m=this.init(e);delete m.auth().login,delete m.auth().register;let g,w;if(h.length===1)typeof h[0]=="string"?g=h[0]:typeof h[0]=="function"&&(w=h[0]);else if(h.length>=2){const[$,Y]=h;typeof $=="string"&&(g=$),w=Y}let x=(O=(S=e==null?void 0:e.socket)==null?void 0:S.auth)==null?void 0:O.id;if(x){if(!g){let $=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");$.uid&&(g=$.uid)}g&&x&&((W=(I=e==null?void 0:e.socket)==null?void 0:I.auth)==null||W.on((s==null?void 0:s.AUTH)+un.user.device.connected,$=>{t==="dev"&&console.log("The user with id: ",g," has this device connected: ",$==null?void 0:$.value),typeof w=="function"&&w(we(V(V({},m.auth().device),m),{value:$}))}))}return V(V({},m.auth().device),m)},disconnected:(...h)=>{var S,O,I,W;let m=this.init(e);delete m.auth().login,delete m.auth().register;let g,w;if(h.length===1)typeof h[0]=="string"?g=h[0]:typeof h[0]=="function"&&(w=h[0]);else if(h.length>=2){const[$,Y]=h;typeof $=="string"&&(g=$),w=Y}let x=(O=(S=e==null?void 0:e.socket)==null?void 0:S.auth)==null?void 0:O.id;if(x){if(!g){let $=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");$.uid&&(g=$.uid)}g&&x&&((W=(I=e==null?void 0:e.socket)==null?void 0:I.auth)==null||W.on((s==null?void 0:s.AUTH)+un.user.device.disconnected,$=>{t==="dev"&&console.log("The user with id: ",g," has this device connected: ",$==null?void 0:$.value),typeof w=="function"&&w(we(V(V({},m.auth().device),m),{value:$}))}))}return V(V({},m.auth().device),m)},remove:(...h)=>{var O,I,W,$,Y,j;let m=this.init(e);delete m.auth().login,delete m.auth().register;let g,w;if(h.length===1)typeof h[0]=="string"?g=h[0]:typeof h[0]=="function"&&(w=h[0]);else if(h.length>=2){const[L,J]=h;(typeof L=="string"||Array.isArray(L))&&(g=L),w=J}let x=(I=(O=e==null?void 0:e.socket)==null?void 0:O.auth)==null?void 0:I.id,S=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");return g&&S.uid&&x&&(($=(W=e==null?void 0:e.socket)==null?void 0:W.auth)==null||$.emit((s==null?void 0:s.AUTH)+ln.user.device.remove,{socketId:x,userId:g,currentUserId:S.uid}),(j=(Y=e==null?void 0:e.socket)==null?void 0:Y.auth)==null||j.on((s==null?void 0:s.AUTH)+un.user.device.removed,L=>{t==="dev"&&console.log("The user with id: ",g," has this device connected: ",L==null?void 0:L.value),typeof w=="function"&&w(we(V(V({},m.auth().device),m),{value:L}))})),V(V({},m.auth().device),m)},list:(...h)=>{var I,W,$,Y;let m=this.init(e);delete m.auth().login,delete m.auth().register;let g=ln.users.device.list,w,x;if(h.length===1)typeof h[0]=="string"?w=h[0]:typeof h[0]=="function"&&(x=h[0]);else if(h.length>=2){const[j,L]=h;typeof j=="string"&&(w=j,g=ln.user.device.list),x=L}let S=(W=(I=e==null?void 0:e.socket)==null?void 0:I.auth)==null?void 0:W.id,O=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");return S&&O.uid&&(w||(g=ln.user.device.list,w=O.uid),w&&S&&(($=e==null?void 0:e.socket.auth)==null||$.emit((s==null?void 0:s.AUTH)+g,{socketId:S,userId:w,currenUserId:O.uid}),(Y=e==null?void 0:e.socket.auth)==null||Y.on((s==null?void 0:s.AUTH)+g+"/",j=>{t==="dev"&&console.log("The user with id: ",w," has these devices connected: ",res==null?void 0:res.value),typeof x=="function"&&x(we(V(V({},m.auth().device),m),{value:j}))}))),V(V({},m.auth().device),m)}},req:(h,m,g)=>{let w=this.init(e);delete w.auth().login,delete w.auth().register;let x=V(V({},w),w.auth());return c(h+Me.req,m,null,x,g)},$user:(()=>{let h=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}");if(h.uid)return h})(),user:(...h)=>{let m,g;h.length>1?(typeof h[0]=="string"&&(m=h[0]),typeof h[1]=="function"&&(g=h[1])):h.length===1&&(typeof h[0]=="string"&&(m=h[0]),typeof h[0]=="function"&&(g=h[0]));let w=this.init(e);delete w.auth().login,delete w.auth().register;let x=V(V({},w),w.auth());if(!m||typeof m!="string"){let S=JSON.parse(localStorage.getItem("userInfo")?localStorage.getItem("userInfo"):"{}"),O=localStorage.getItem("accessToken"),I=(()=>{var W;try{let $=pc(O);return(Date==null?void 0:Date.parse((W=new Date(($==null?void 0:$.exp)*1e3))==null?void 0:W.toString()))>Date.now()}catch($){return!1}})();return S.uid&&I?(typeof g=="function"&&g(we(V({},x),{value:S})),we(V({},x),{val:()=>S})):c(Me.user,{},null,null,({value:W})=>{var Y;let $=W;$!=null&&$.data&&($={data:(Y=$==null?void 0:$.data)==null?void 0:Y.data},$.data&&localStorage.setItem("userInfo",JSON.stringify($.data))),typeof g=="function"&&g(we(V({},x),{value:$}))})}else return c(Me.user,{uid:m},null,null,({value:S})=>{var I;let O=S;O!=null&&O.data&&(O={data:(I=O==null?void 0:O.data)==null?void 0:I.data}),typeof g=="function"&&g(we(V({},x),{value:O}))})},verifyEmailCode:(h,m)=>{let g=this.init(e);return delete g.auth().login,delete g.auth().register,c(Me.verify_email_code,h,null,null,({value:w})=>{l({value:w,node:g},m)})},verifyTokenCode:(h,m)=>{let g=this.init(e);return delete g.auth().login,delete g.auth().register,c(Me.verify_token_code,h,null,null,({value:w})=>{l({value:w,node:g},m)})},verifyPassCode:(h,m)=>{let g=this.init(e);return delete g.auth().login,delete g.auth().register,c(Me.verify_pass_code,h,null,null,({value:w})=>{l({value:w,node:g},m)})},login:(h,m)=>{let g=this.init(e);return delete g.auth().login,delete g.auth().register,c(Me.login,h,null,null,({value:w})=>{l({value:w,node:g},m)})},loginWithToken:(h,m)=>{let g=this.init(e);return delete g.auth().login,delete g.auth().register,localStorage.setItem("userInfo","{}"),localStorage.setItem("accessToken",""),localStorage.setItem("refreshToken",h),this.init(e).auth.user(null,m)},logout:h=>{let m=this.init(e);return localStorage.removeItem("refreshToken"),localStorage.removeItem("userInfo"),localStorage.removeItem("accessToken"),(()=>k(this,null,function*(){var w,x,S,O,I,W;yield(S=(x=(w=Fe(this,Pt))==null?void 0:w.ref("/database"))==null?void 0:x.remove())==null?void 0:S.catch($=>{}),yield(W=(I=(O=Fe(this,Pt))==null?void 0:O.ref("/transaction"))==null?void 0:I.remove())==null?void 0:W.catch($=>{})}))().then(w=>{}).catch(w=>{}),typeof h=="function"&&h(V(V({},m),m.auth())),V(V({},m),m.auth())},register:(h,m)=>{let g=this.init(e);return delete g.auth().login,delete g.auth().register,c(Me.register,h,null,null,({value:w})=>{l({value:w,node:g},m)})},forgotPassword:(h,m)=>c(Me.forgotPassword,h,null,null,m),users:()=>{let h=this.init(e);return delete h.auth().login,delete h.auth().register,h.ref("/users")},tokens:()=>{let h=this.init(e);return delete h.auth().login,delete h.auth().register,h.ref("/tokens")}}}}});tn(this,yt,e);let{OFFLINE_DB_NAME:t}=Fe(this,yt);tn(this,Pt,Gt.WithIndexedDB((t==null?void 0:t.AUTH)||"swyger_auth"))}}Ot=new WeakMap,Jt=new WeakMap,Nn=new WeakMap,yt=new WeakMap,Pt=new WeakMap;const ef={init:r=>{try{return(e={})=>new Zl(r).init(e)}catch(e){return{}}}};let tf={init:r=>{var e,t,n;return{OFFLINE_DB_NAME:{AUTH:((e=r==null?void 0:r.OFFLINE_DB_NAME)==null?void 0:e.AUTH)||"swyger_auth"},ENV:(r==null?void 0:r.ENV)||"prod",HOST_SERVER:{AUTH:((t=r==null?void 0:r.HOST_SERVER)==null?void 0:t.AUTH)||"http://localhost:4100"},API_VERSION:{AUTH:((n=r==null?void 0:r.API_VERSION)==null?void 0:n.AUTH)||"/api/v1"},AUTO_REFRESH_TOKEN_TIMEOUT:(r==null?void 0:r.AUTO_REFRESH_TOKEN_TIMEOUT)||15e5,API_KEY:(r==null?void 0:r.API_KEY)||"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzd3lnZXIuY29tIiwiaWF0IjoxNjUzNDQwOTkxLCJleHAiOjE2ODQ5NzY5OTEsImF1ZCI6ImRheW52ZXIuY29tIiwic3ViIjoidGVhbUBzd3lnZXIuY29tIiwiR2l2ZW5OYW1lIjoiSXZhbiBKb2VsIiwiU3VybmFtZSI6IlNvYmd1aSIsIkVtYWlsIjoidGVhbUBhZ2dsb215LmNvbSIsIlJvbGUiOlsiQWRtaW4iLCJQcm9qZWN0IEFkbWluaXN0cmF0b3IiXX0.UvlcjBahR9G8dKxIeENJ7k4I87t3_oNJQ16eyPsRcSE"}}};const rp={init:r=>{let e=tf.init(r);const t=hc.init(e),n={socket:{auth:t==null?void 0:t.auth,database:t==null?void 0:t.database,storage:t==null?void 0:t.storage}};return ef.init(e)(n)}};var Rr=function(r,e){return Rr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])},Rr(r,e)};function ye(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Rr(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function nf(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(l){try{u(n.next(l))}catch(f){o(f)}}function c(l){try{u(n.throw(l))}catch(f){o(f)}}function u(l){l.done?i(l.value):s(l.value).then(a,c)}u((n=n.apply(r,e||[])).next())})}function ts(r,e){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,s,i,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(u){return function(l){return c([u,l])}}function c(u){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(t=0)),t;)try{if(n=1,s&&(i=u[0]&2?s.return:u[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,u[1])).done)return i;switch(s=0,i&&(u=[u[0]&2,i.value]),u[0]){case 0:case 1:i=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,s=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!i||u[1]>i[0]&&u[1]<i[3])){t.label=u[1];break}if(u[0]===6&&t.label<i[1]){t.label=i[1],i=u;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(u);break}i[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(r,t)}catch(l){u=[6,l],s=0}finally{n=i=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function Ie(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function se(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),s,i=[],o;try{for(;(e===void 0||e-- >0)&&!(s=n.next()).done;)i.push(s.value)}catch(a){o={error:a}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return i}function ie(r,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,i;n<s;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))}function Tt(r){return this instanceof Tt?(this.v=r,this):new Tt(r)}function rf(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(r,e||[]),s,i=[];return s={},o("next"),o("throw"),o("return"),s[Symbol.asyncIterator]=function(){return this},s;function o(y){n[y]&&(s[y]=function(p){return new Promise(function(d,h){i.push([y,p,d,h])>1||a(y,p)})})}function a(y,p){try{c(n[y](p))}catch(d){f(i[0][3],d)}}function c(y){y.value instanceof Tt?Promise.resolve(y.value.v).then(u,l):f(i[0][2],y)}function u(y){a("next",y)}function l(y){a("throw",y)}function f(y,p){y(p),i.shift(),i.length&&a(i[0][0],i[0][1])}}function sf(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=r[Symbol.asyncIterator],t;return e?e.call(r):(r=typeof Ie=="function"?Ie(r):r[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(i){t[i]=r[i]&&function(o){return new Promise(function(a,c){o=r[i](o),s(a,c,o.done,o.value)})}}function s(i,o,a,c){Promise.resolve(c).then(function(u){i({value:u,done:a})},o)}}function Q(r){return typeof r=="function"}function vt(r){var e=function(n){Error.call(n),n.stack=new Error().stack},t=r(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var xn=vt(function(r){return function(t){r(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(n,s){return s+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t}});function et(r,e){if(r){var t=r.indexOf(e);0<=t&&r.splice(t,1)}}var Ce=function(){function r(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return r.prototype.unsubscribe=function(){var e,t,n,s,i;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var a=Ie(o),c=a.next();!c.done;c=a.next()){var u=c.value;u.remove(this)}}catch(h){e={error:h}}finally{try{c&&!c.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}else o.remove(this);var l=this.initialTeardown;if(Q(l))try{l()}catch(h){i=h instanceof xn?h.errors:[h]}var f=this._finalizers;if(f){this._finalizers=null;try{for(var y=Ie(f),p=y.next();!p.done;p=y.next()){var d=p.value;try{ri(d)}catch(h){i=i!=null?i:[],h instanceof xn?i=ie(ie([],se(i)),se(h.errors)):i.push(h)}}}catch(h){n={error:h}}finally{try{p&&!p.done&&(s=y.return)&&s.call(y)}finally{if(n)throw n.error}}}if(i)throw new xn(i)}},r.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)ri(e);else{if(e instanceof r){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},r.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},r.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},r.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&et(t,e)},r.prototype.remove=function(e){var t=this._finalizers;t&&et(t,e),e instanceof r&&e._removeParent(this)},r.EMPTY=function(){var e=new r;return e.closed=!0,e}(),r}(),yo=Ce.EMPTY;function mo(r){return r instanceof Ce||r&&"closed"in r&&Q(r.remove)&&Q(r.add)&&Q(r.unsubscribe)}function ri(r){Q(r)?r():r.unsubscribe()}var ft={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},Pn={setTimeout:function(r,e){for(var t=[],n=2;n<arguments.length;n++)t[n-2]=arguments[n];var s=Pn.delegate;return s!=null&&s.setTimeout?s.setTimeout.apply(s,ie([r,e],se(t))):setTimeout.apply(void 0,ie([r,e],se(t)))},clearTimeout:function(r){var e=Pn.delegate;return((e==null?void 0:e.clearTimeout)||clearTimeout)(r)},delegate:void 0};function go(r){Pn.setTimeout(function(){var e=ft.onUnhandledError;if(e)e(r);else throw r})}function pe(){}var of=function(){return ns("C",void 0,void 0)}();function af(r){return ns("E",void 0,r)}function cf(r){return ns("N",r,void 0)}function ns(r,e,t){return{kind:r,value:e,error:t}}var pt=null;function En(r){if(ft.useDeprecatedSynchronousErrorHandling){var e=!pt;if(e&&(pt={errorThrown:!1,error:null}),r(),e){var t=pt,n=t.errorThrown,s=t.error;if(pt=null,n)throw s}}else r()}function uf(r){ft.useDeprecatedSynchronousErrorHandling&&pt&&(pt.errorThrown=!0,pt.error=r)}var Kn=function(r){ye(e,r);function e(t){var n=r.call(this)||this;return n.isStopped=!1,t?(n.destination=t,mo(t)&&t.add(n)):n.destination=df,n}return e.create=function(t,n,s){return new Ct(t,n,s)},e.prototype.next=function(t){this.isStopped?dr(cf(t),this):this._next(t)},e.prototype.error=function(t){this.isStopped?dr(af(t),this):(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped?dr(of,this):(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,r.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(Ce),lf=Function.prototype.bind;function hr(r,e){return lf.call(r,e)}var ff=function(){function r(e){this.partialObserver=e}return r.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(n){fn(n)}},r.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(n){fn(n)}else fn(e)},r.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){fn(t)}},r}(),Ct=function(r){ye(e,r);function e(t,n,s){var i=r.call(this)||this,o;if(Q(t)||!t)o={next:t!=null?t:void 0,error:n!=null?n:void 0,complete:s!=null?s:void 0};else{var a;i&&ft.useDeprecatedNextContext?(a=Object.create(t),a.unsubscribe=function(){return i.unsubscribe()},o={next:t.next&&hr(t.next,a),error:t.error&&hr(t.error,a),complete:t.complete&&hr(t.complete,a)}):o=t}return i.destination=new ff(o),i}return e}(Kn);function fn(r){ft.useDeprecatedSynchronousErrorHandling?uf(r):go(r)}function hf(r){throw r}function dr(r,e){var t=ft.onStoppedNotification;t&&Pn.setTimeout(function(){return t(r,e)})}var df={closed:!0,next:pe,error:hf,complete:pe},Vn=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function xe(r){return r}function rs(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return vo(r)}function vo(r){return r.length===0?xe:r.length===1?r[0]:function(t){return r.reduce(function(n,s){return s(n)},t)}}var ne=function(){function r(e){e&&(this._subscribe=e)}return r.prototype.lift=function(e){var t=new r;return t.source=this,t.operator=e,t},r.prototype.subscribe=function(e,t,n){var s=this,i=yf(e)?e:new Ct(e,t,n);return En(function(){var o=s,a=o.operator,c=o.source;i.add(a?a.call(i,c):c?s._subscribe(i):s._trySubscribe(i))}),i},r.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},r.prototype.forEach=function(e,t){var n=this;return t=si(t),new t(function(s,i){var o=new Ct({next:function(a){try{e(a)}catch(c){i(c),o.unsubscribe()}},error:i,complete:s});n.subscribe(o)})},r.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},r.prototype[Vn]=function(){return this},r.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return vo(e)(this)},r.prototype.toPromise=function(e){var t=this;return e=si(e),new e(function(n,s){var i;t.subscribe(function(o){return i=o},function(o){return s(o)},function(){return n(i)})})},r.create=function(e){return new r(e)},r}();function si(r){var e;return(e=r!=null?r:ft.Promise)!==null&&e!==void 0?e:Promise}function pf(r){return r&&Q(r.next)&&Q(r.error)&&Q(r.complete)}function yf(r){return r&&r instanceof Kn||pf(r)&&mo(r)}function wo(r){return Q(r==null?void 0:r.lift)}function z(r){return function(e){if(wo(e))return e.lift(function(t){try{return r(t,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}function M(r,e,t,n,s){return new ss(r,e,t,n,s)}var ss=function(r){ye(e,r);function e(t,n,s,i,o,a){var c=r.call(this,t)||this;return c.onFinalize=o,c.shouldUnsubscribe=a,c._next=n?function(u){try{n(u)}catch(l){t.error(l)}}:r.prototype._next,c._error=i?function(u){try{i(u)}catch(l){t.error(l)}finally{this.unsubscribe()}}:r.prototype._error,c._complete=s?function(){try{s()}catch(u){t.error(u)}finally{this.unsubscribe()}}:r.prototype._complete,c}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;r.prototype.unsubscribe.call(this),!n&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e}(Kn);function bo(){return z(function(r,e){var t=null;r._refCount++;var n=M(e,void 0,void 0,void 0,function(){if(!r||r._refCount<=0||0<--r._refCount){t=null;return}var s=r._connection,i=t;t=null,s&&(!i||s===i)&&s.unsubscribe(),e.unsubscribe()});r.subscribe(n),n.closed||(t=r.connect())})}var zn=function(r){ye(e,r);function e(t,n){var s=r.call(this)||this;return s.source=t,s.subjectFactory=n,s._subject=null,s._refCount=0,s._connection=null,wo(t)&&(s.lift=t.lift),s}return e.prototype._subscribe=function(t){return this.getSubject().subscribe(t)},e.prototype.getSubject=function(){var t=this._subject;return(!t||t.isStopped)&&(this._subject=this.subjectFactory()),this._subject},e.prototype._teardown=function(){this._refCount=0;var t=this._connection;this._subject=this._connection=null,t==null||t.unsubscribe()},e.prototype.connect=function(){var t=this,n=this._connection;if(!n){n=this._connection=new Ce;var s=this.getSubject();n.add(this.source.subscribe(M(s,void 0,function(){t._teardown(),s.complete()},function(i){t._teardown(),s.error(i)},function(){return t._teardown()}))),n.closed&&(this._connection=null,n=Ce.EMPTY)}return n},e.prototype.refCount=function(){return bo()(this)},e}(ne),xo={now:function(){return(xo.delegate||performance).now()},delegate:void 0},mt={schedule:function(r){var e=requestAnimationFrame,t=cancelAnimationFrame,n=mt.delegate;n&&(e=n.requestAnimationFrame,t=n.cancelAnimationFrame);var s=e(function(i){t=void 0,r(i)});return new Ce(function(){return t==null?void 0:t(s)})},requestAnimationFrame:function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=mt.delegate;return((t==null?void 0:t.requestAnimationFrame)||requestAnimationFrame).apply(void 0,ie([],se(r)))},cancelAnimationFrame:function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=mt.delegate;return((t==null?void 0:t.cancelAnimationFrame)||cancelAnimationFrame).apply(void 0,ie([],se(r)))},delegate:void 0};function mf(r){return r?Eo(r):gf}function Eo(r){return new ne(function(e){var t=r||xo,n=t.now(),s=0,i=function(){e.closed||(s=mt.requestAnimationFrame(function(o){s=0;var a=t.now();e.next({timestamp:r?a:o,elapsed:a-n}),i()}))};return i(),function(){s&&mt.cancelAnimationFrame(s)}})}var gf=Eo(),ko=vt(function(r){return function(){r(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),ve=function(r){ye(e,r);function e(){var t=r.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var n=new ii(this,this);return n.operator=t,n},e.prototype._throwIfClosed=function(){if(this.closed)throw new ko},e.prototype.next=function(t){var n=this;En(function(){var s,i;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var o=Ie(n.currentObservers),a=o.next();!a.done;a=o.next()){var c=a.value;c.next(t)}}catch(u){s={error:u}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(s)throw s.error}}}})},e.prototype.error=function(t){var n=this;En(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=t;for(var s=n.observers;s.length;)s.shift().error(t)}})},e.prototype.complete=function(){var t=this;En(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var n=t.observers;n.length;)n.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),r.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var n=this,s=this,i=s.hasError,o=s.isStopped,a=s.observers;return i||o?yo:(this.currentObservers=null,a.push(t),new Ce(function(){n.currentObservers=null,et(a,t)}))},e.prototype._checkFinalizedStatuses=function(t){var n=this,s=n.hasError,i=n.thrownError,o=n.isStopped;s?t.error(i):o&&t.complete()},e.prototype.asObservable=function(){var t=new ne;return t.source=this,t},e.create=function(t,n){return new ii(t,n)},e}(ne),ii=function(r){ye(e,r);function e(t,n){var s=r.call(this)||this;return s.destination=t,s.source=n,s}return e.prototype.next=function(t){var n,s;(s=(n=this.destination)===null||n===void 0?void 0:n.next)===null||s===void 0||s.call(n,t)},e.prototype.error=function(t){var n,s;(s=(n=this.destination)===null||n===void 0?void 0:n.error)===null||s===void 0||s.call(n,t)},e.prototype.complete=function(){var t,n;(n=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||n===void 0||n.call(t)},e.prototype._subscribe=function(t){var n,s;return(s=(n=this.source)===null||n===void 0?void 0:n.subscribe(t))!==null&&s!==void 0?s:yo},e}(ve),_o=function(r){ye(e,r);function e(t){var n=r.call(this)||this;return n._value=t,n}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var n=r.prototype._subscribe.call(this,t);return!n.closed&&t.next(this._value),n},e.prototype.getValue=function(){var t=this,n=t.hasError,s=t.thrownError,i=t._value;if(n)throw s;return this._throwIfClosed(),i},e.prototype.next=function(t){r.prototype.next.call(this,this._value=t)},e}(ve),Wn={now:function(){return(Wn.delegate||Date).now()},delegate:void 0},is=function(r){ye(e,r);function e(t,n,s){t===void 0&&(t=1/0),n===void 0&&(n=1/0),s===void 0&&(s=Wn);var i=r.call(this)||this;return i._bufferSize=t,i._windowTime=n,i._timestampProvider=s,i._buffer=[],i._infiniteTimeWindow=!0,i._infiniteTimeWindow=n===1/0,i._bufferSize=Math.max(1,t),i._windowTime=Math.max(1,n),i}return e.prototype.next=function(t){var n=this,s=n.isStopped,i=n._buffer,o=n._infiniteTimeWindow,a=n._timestampProvider,c=n._windowTime;s||(i.push(t),!o&&i.push(a.now()+c)),this._trimBuffer(),r.prototype.next.call(this,t)},e.prototype._subscribe=function(t){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(t),s=this,i=s._infiniteTimeWindow,o=s._buffer,a=o.slice(),c=0;c<a.length&&!t.closed;c+=i?1:2)t.next(a[c]);return this._checkFinalizedStatuses(t),n},e.prototype._trimBuffer=function(){var t=this,n=t._bufferSize,s=t._timestampProvider,i=t._buffer,o=t._infiniteTimeWindow,a=(o?1:2)*n;if(n<1/0&&a<i.length&&i.splice(0,i.length-a),!o){for(var c=s.now(),u=0,l=1;l<i.length&&i[l]<=c;l+=2)u=l;u&&i.splice(0,u+1)}},e}(ve),os=function(r){ye(e,r);function e(){var t=r!==null&&r.apply(this,arguments)||this;return t._value=null,t._hasValue=!1,t._isComplete=!1,t}return e.prototype._checkFinalizedStatuses=function(t){var n=this,s=n.hasError,i=n._hasValue,o=n._value,a=n.thrownError,c=n.isStopped,u=n._isComplete;s?t.error(a):(c||u)&&(i&&t.next(o),t.complete())},e.prototype.next=function(t){this.isStopped||(this._value=t,this._hasValue=!0)},e.prototype.complete=function(){var t=this,n=t._hasValue,s=t._value,i=t._isComplete;i||(this._isComplete=!0,n&&r.prototype.next.call(this,s),r.prototype.complete.call(this))},e}(ve),vf=function(r){ye(e,r);function e(t,n){return r.call(this)||this}return e.prototype.schedule=function(t,n){return this},e}(Ce),In={setInterval:function(r,e){for(var t=[],n=2;n<arguments.length;n++)t[n-2]=arguments[n];var s=In.delegate;return s!=null&&s.setInterval?s.setInterval.apply(s,ie([r,e],se(t))):setInterval.apply(void 0,ie([r,e],se(t)))},clearInterval:function(r){var e=In.delegate;return((e==null?void 0:e.clearInterval)||clearInterval)(r)},delegate:void 0},Qt=function(r){ye(e,r);function e(t,n){var s=r.call(this,t,n)||this;return s.scheduler=t,s.work=n,s.pending=!1,s}return e.prototype.schedule=function(t,n){var s;if(n===void 0&&(n=0),this.closed)return this;this.state=t;var i=this.id,o=this.scheduler;return i!=null&&(this.id=this.recycleAsyncId(o,i,n)),this.pending=!0,this.delay=n,this.id=(s=this.id)!==null&&s!==void 0?s:this.requestAsyncId(o,this.id,n),this},e.prototype.requestAsyncId=function(t,n,s){return s===void 0&&(s=0),In.setInterval(t.flush.bind(t,this),s)},e.prototype.recycleAsyncId=function(t,n,s){if(s===void 0&&(s=0),s!=null&&this.delay===s&&this.pending===!1)return n;n!=null&&In.clearInterval(n)},e.prototype.execute=function(t,n){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var s=this._execute(t,n);if(s)return s;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,n){var s=!1,i;try{this.work(t)}catch(o){s=!0,i=o||new Error("Scheduled action threw falsy error")}if(s)return this.unsubscribe(),i},e.prototype.unsubscribe=function(){if(!this.closed){var t=this,n=t.id,s=t.scheduler,i=s.actions;this.work=this.state=this.scheduler=null,this.pending=!1,et(i,this),n!=null&&(this.id=this.recycleAsyncId(s,n,null)),this.delay=null,r.prototype.unsubscribe.call(this)}},e}(vf),wf=1,pr,Cr={};function oi(r){return r in Cr?(delete Cr[r],!0):!1}var Ao={setImmediate:function(r){var e=wf++;return Cr[e]=!0,pr||(pr=Promise.resolve()),pr.then(function(){return oi(e)&&r()}),e},clearImmediate:function(r){oi(r)}},bf=Ao.setImmediate,xf=Ao.clearImmediate,Rn={setImmediate:function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=Rn.delegate;return((t==null?void 0:t.setImmediate)||bf).apply(void 0,ie([],se(r)))},clearImmediate:function(r){var e=Rn.delegate;return((e==null?void 0:e.clearImmediate)||xf)(r)},delegate:void 0},Ef=function(r){ye(e,r);function e(t,n){var s=r.call(this,t,n)||this;return s.scheduler=t,s.work=n,s}return e.prototype.requestAsyncId=function(t,n,s){return s===void 0&&(s=0),s!==null&&s>0?r.prototype.requestAsyncId.call(this,t,n,s):(t.actions.push(this),t._scheduled||(t._scheduled=Rn.setImmediate(t.flush.bind(t,void 0))))},e.prototype.recycleAsyncId=function(t,n,s){var i;if(s===void 0&&(s=0),s!=null?s>0:this.delay>0)return r.prototype.recycleAsyncId.call(this,t,n,s);var o=t.actions;n!=null&&((i=o[o.length-1])===null||i===void 0?void 0:i.id)!==n&&(Rn.clearImmediate(n),t._scheduled===n&&(t._scheduled=void 0))},e}(Qt),Nr=function(){function r(e,t){t===void 0&&(t=r.now),this.schedulerActionCtor=e,this.now=t}return r.prototype.schedule=function(e,t,n){return t===void 0&&(t=0),new this.schedulerActionCtor(this,e).schedule(n,t)},r.now=Wn.now,r}(),Xt=function(r){ye(e,r);function e(t,n){n===void 0&&(n=Nr.now);var s=r.call(this,t,n)||this;return s.actions=[],s._active=!1,s}return e.prototype.flush=function(t){var n=this.actions;if(this._active){n.push(t);return}var s;this._active=!0;do if(s=t.execute(t.state,t.delay))break;while(t=n.shift());if(this._active=!1,s){for(;t=n.shift();)t.unsubscribe();throw s}},e}(Nr),kf=function(r){ye(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.flush=function(t){this._active=!0;var n=this._scheduled;this._scheduled=void 0;var s=this.actions,i;t=t||s.shift();do if(i=t.execute(t.state,t.delay))break;while((t=s[0])&&t.id===n&&s.shift());if(this._active=!1,i){for(;(t=s[0])&&t.id===n&&s.shift();)t.unsubscribe();throw i}},e}(Xt),So=new kf(Ef),_f=So,Ue=new Xt(Qt),as=Ue,Af=function(r){ye(e,r);function e(t,n){var s=r.call(this,t,n)||this;return s.scheduler=t,s.work=n,s}return e.prototype.schedule=function(t,n){return n===void 0&&(n=0),n>0?r.prototype.schedule.call(this,t,n):(this.delay=n,this.state=t,this.scheduler.flush(this),this)},e.prototype.execute=function(t,n){return n>0||this.closed?r.prototype.execute.call(this,t,n):this._execute(t,n)},e.prototype.requestAsyncId=function(t,n,s){return s===void 0&&(s=0),s!=null&&s>0||s==null&&this.delay>0?r.prototype.requestAsyncId.call(this,t,n,s):(t.flush(this),0)},e}(Qt),Sf=function(r){ye(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(Xt),To=new Sf(Af),Tf=To,Of=function(r){ye(e,r);function e(t,n){var s=r.call(this,t,n)||this;return s.scheduler=t,s.work=n,s}return e.prototype.requestAsyncId=function(t,n,s){return s===void 0&&(s=0),s!==null&&s>0?r.prototype.requestAsyncId.call(this,t,n,s):(t.actions.push(this),t._scheduled||(t._scheduled=mt.requestAnimationFrame(function(){return t.flush(void 0)})))},e.prototype.recycleAsyncId=function(t,n,s){var i;if(s===void 0&&(s=0),s!=null?s>0:this.delay>0)return r.prototype.recycleAsyncId.call(this,t,n,s);var o=t.actions;n!=null&&((i=o[o.length-1])===null||i===void 0?void 0:i.id)!==n&&(mt.cancelAnimationFrame(n),t._scheduled=void 0)},e}(Qt),Pf=function(r){ye(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.flush=function(t){this._active=!0;var n=this._scheduled;this._scheduled=void 0;var s=this.actions,i;t=t||s.shift();do if(i=t.execute(t.state,t.delay))break;while((t=s[0])&&t.id===n&&s.shift());if(this._active=!1,i){for(;(t=s[0])&&t.id===n&&s.shift();)t.unsubscribe();throw i}},e}(Xt),Oo=new Pf(Of),If=Oo,Rf=function(r){ye(e,r);function e(t,n){t===void 0&&(t=Po),n===void 0&&(n=1/0);var s=r.call(this,t,function(){return s.frame})||this;return s.maxFrames=n,s.frame=0,s.index=-1,s}return e.prototype.flush=function(){for(var t=this,n=t.actions,s=t.maxFrames,i,o;(o=n[0])&&o.delay<=s&&(n.shift(),this.frame=o.delay,!(i=o.execute(o.state,o.delay))););if(i){for(;o=n.shift();)o.unsubscribe();throw i}},e.frameTimeFactor=10,e}(Xt),Po=function(r){ye(e,r);function e(t,n,s){s===void 0&&(s=t.index+=1);var i=r.call(this,t,n)||this;return i.scheduler=t,i.work=n,i.index=s,i.active=!0,i.index=t.index=s,i}return e.prototype.schedule=function(t,n){if(n===void 0&&(n=0),Number.isFinite(n)){if(!this.id)return r.prototype.schedule.call(this,t,n);this.active=!1;var s=new e(this.scheduler,this.work);return this.add(s),s.schedule(t,n)}else return Ce.EMPTY},e.prototype.requestAsyncId=function(t,n,s){s===void 0&&(s=0),this.delay=t.frame+s;var i=t.actions;return i.push(this),i.sort(e.sortActions),1},e.prototype.recycleAsyncId=function(t,n,s){},e.prototype._execute=function(t,n){if(this.active===!0)return r.prototype._execute.call(this,t,n)},e.sortActions=function(t,n){return t.delay===n.delay?t.index===n.index?0:t.index>n.index?1:-1:t.delay>n.delay?1:-1},e}(Qt),Ge=new ne(function(r){return r.complete()});function Cf(r){return r?Nf(r):Ge}function Nf(r){return new ne(function(e){return r.schedule(function(){return e.complete()})})}function Hn(r){return r&&Q(r.schedule)}function cs(r){return r[r.length-1]}function Zt(r){return Q(cs(r))?r.pop():void 0}function tt(r){return Hn(cs(r))?r.pop():void 0}function Io(r,e){return typeof cs(r)=="number"?r.pop():e}var us=function(r){return r&&typeof r.length=="number"&&typeof r!="function"};function Ro(r){return Q(r==null?void 0:r.then)}function Co(r){return Q(r[Vn])}function No(r){return Symbol.asyncIterator&&Q(r==null?void 0:r[Symbol.asyncIterator])}function $o(r){return new TypeError("You provided "+(r!==null&&typeof r=="object"?"an invalid object":"'"+r+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function $f(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var jo=$f();function Bo(r){return Q(r==null?void 0:r[jo])}function Lo(r){return rf(this,arguments,function(){var t,n,s,i;return ts(this,function(o){switch(o.label){case 0:t=r.getReader(),o.label=1;case 1:o.trys.push([1,,9,10]),o.label=2;case 2:return[4,Tt(t.read())];case 3:return n=o.sent(),s=n.value,i=n.done,i?[4,Tt(void 0)]:[3,5];case 4:return[2,o.sent()];case 5:return[4,Tt(s)];case 6:return[4,o.sent()];case 7:return o.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function Do(r){return Q(r==null?void 0:r.getReader)}function q(r){if(r instanceof ne)return r;if(r!=null){if(Co(r))return jf(r);if(us(r))return Bf(r);if(Ro(r))return Lf(r);if(No(r))return Uo(r);if(Bo(r))return Df(r);if(Do(r))return Uf(r)}throw $o(r)}function jf(r){return new ne(function(e){var t=r[Vn]();if(Q(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Bf(r){return new ne(function(e){for(var t=0;t<r.length&&!e.closed;t++)e.next(r[t]);e.complete()})}function Lf(r){return new ne(function(e){r.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,go)})}function Df(r){return new ne(function(e){var t,n;try{for(var s=Ie(r),i=s.next();!i.done;i=s.next()){var o=i.value;if(e.next(o),e.closed)return}}catch(a){t={error:a}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}e.complete()})}function Uo(r){return new ne(function(e){Ff(r,e).catch(function(t){return e.error(t)})})}function Uf(r){return Uo(Lo(r))}function Ff(r,e){var t,n,s,i;return nf(this,void 0,void 0,function(){var o,a;return ts(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),t=sf(r),c.label=1;case 1:return[4,t.next()];case 2:if(n=c.sent(),!!n.done)return[3,4];if(o=n.value,e.next(o),e.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),s={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),n&&!n.done&&(i=t.return)?[4,i.call(t)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function Re(r,e,t,n,s){n===void 0&&(n=0),s===void 0&&(s=!1);var i=e.schedule(function(){t(),s?r.add(this.schedule(null,n)):this.unsubscribe()},n);if(r.add(i),!s)return i}function Jn(r,e){return e===void 0&&(e=0),z(function(t,n){t.subscribe(M(n,function(s){return Re(n,r,function(){return n.next(s)},e)},function(){return Re(n,r,function(){return n.complete()},e)},function(s){return Re(n,r,function(){return n.error(s)},e)}))})}function qn(r,e){return e===void 0&&(e=0),z(function(t,n){n.add(r.schedule(function(){return t.subscribe(n)},e))})}function Mf(r,e){return q(r).pipe(qn(e),Jn(e))}function Kf(r,e){return q(r).pipe(qn(e),Jn(e))}function Vf(r,e){return new ne(function(t){var n=0;return e.schedule(function(){n===r.length?t.complete():(t.next(r[n++]),t.closed||this.schedule())})})}function Fo(r,e){return new ne(function(t){var n;return Re(t,e,function(){n=r[jo](),Re(t,e,function(){var s,i,o;try{s=n.next(),i=s.value,o=s.done}catch(a){t.error(a);return}o?t.complete():t.next(i)},0,!0)}),function(){return Q(n==null?void 0:n.return)&&n.return()}})}function Mo(r,e){if(!r)throw new Error("Iterable cannot be null");return new ne(function(t){Re(t,e,function(){var n=r[Symbol.asyncIterator]();Re(t,e,function(){n.next().then(function(s){s.done?t.complete():t.next(s.value)})},0,!0)})})}function zf(r,e){return Mo(Lo(r),e)}function Ko(r,e){if(r!=null){if(Co(r))return Mf(r,e);if(us(r))return Vf(r,e);if(Ro(r))return Kf(r,e);if(No(r))return Mo(r,e);if(Bo(r))return Fo(r,e);if(Do(r))return zf(r,e)}throw $o(r)}function nt(r,e){return e?Ko(r,e):q(r)}function ls(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=tt(r);return nt(r,t)}function Vo(r,e){var t=Q(r)?r:function(){return r},n=function(s){return s.error(t())};return new ne(e?function(s){return e.schedule(n,0,s)}:n)}var $r;(function(r){r.NEXT="N",r.ERROR="E",r.COMPLETE="C"})($r||($r={}));var kn=function(){function r(e,t,n){this.kind=e,this.value=t,this.error=n,this.hasValue=e==="N"}return r.prototype.observe=function(e){return zo(this,e)},r.prototype.do=function(e,t,n){var s=this,i=s.kind,o=s.value,a=s.error;return i==="N"?e==null?void 0:e(o):i==="E"?t==null?void 0:t(a):n==null?void 0:n()},r.prototype.accept=function(e,t,n){var s;return Q((s=e)===null||s===void 0?void 0:s.next)?this.observe(e):this.do(e,t,n)},r.prototype.toObservable=function(){var e=this,t=e.kind,n=e.value,s=e.error,i=t==="N"?ls(n):t==="E"?Vo(function(){return s}):t==="C"?Ge:0;if(!i)throw new TypeError("Unexpected notification kind "+t);return i},r.createNext=function(e){return new r("N",e)},r.createError=function(e){return new r("E",void 0,e)},r.createComplete=function(){return r.completeNotification},r.completeNotification=new r("C"),r}();function zo(r,e){var t,n,s,i=r,o=i.kind,a=i.value,c=i.error;if(typeof o!="string")throw new TypeError('Invalid notification, missing "kind"');o==="N"?(t=e.next)===null||t===void 0||t.call(e,a):o==="E"?(n=e.error)===null||n===void 0||n.call(e,c):(s=e.complete)===null||s===void 0||s.call(e)}function Wf(r){return!!r&&(r instanceof ne||Q(r.lift)&&Q(r.subscribe))}var wt=vt(function(r){return function(){r(this),this.name="EmptyError",this.message="no elements in sequence"}});function Hf(r,e){var t=typeof e=="object";return new Promise(function(n,s){var i=!1,o;r.subscribe({next:function(a){o=a,i=!0},error:s,complete:function(){i?n(o):t?n(e.defaultValue):s(new wt)}})})}function Jf(r,e){var t=typeof e=="object";return new Promise(function(n,s){var i=new Ct({next:function(o){n(o),i.unsubscribe()},error:s,complete:function(){t?n(e.defaultValue):s(new wt)}});r.subscribe(i)})}var jr=vt(function(r){return function(){r(this),this.name="ArgumentOutOfRangeError",this.message="argument out of range"}}),Wo=vt(function(r){return function(t){r(this),this.name="NotFoundError",this.message=t}}),Ho=vt(function(r){return function(t){r(this),this.name="SequenceError",this.message=t}});function fs(r){return r instanceof Date&&!isNaN(r)}var Jo=vt(function(r){return function(t){t===void 0&&(t=null),r(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=t}});function qo(r,e){var t=fs(r)?{first:r}:typeof r=="number"?{each:r}:r,n=t.first,s=t.each,i=t.with,o=i===void 0?qf:i,a=t.scheduler,c=a===void 0?e!=null?e:Ue:a,u=t.meta,l=u===void 0?null:u;if(n==null&&s==null)throw new TypeError("No timeout provided.");return z(function(f,y){var p,d,h=null,m=0,g=function(w){d=Re(y,c,function(){try{p.unsubscribe(),q(o({meta:l,lastValue:h,seen:m})).subscribe(y)}catch(x){y.error(x)}},w)};p=f.subscribe(M(y,function(w){d==null||d.unsubscribe(),m++,y.next(h=w),s>0&&g(s)},void 0,void 0,function(){d!=null&&d.closed||d==null||d.unsubscribe(),h=null})),!m&&g(n!=null?typeof n=="number"?n:+n-c.now():s)})}function qf(r){throw new Jo(r)}function bt(r,e){return z(function(t,n){var s=0;t.subscribe(M(n,function(i){n.next(r.call(e,i,s++))}))})}var Yf=Array.isArray;function Gf(r,e){return Yf(e)?r.apply(void 0,ie([],se(e))):r(e)}function xt(r){return bt(function(e){return Gf(r,e)})}function Cn(r,e,t,n){if(t)if(Hn(t))n=t;else return function(){for(var s=[],i=0;i<arguments.length;i++)s[i]=arguments[i];return Cn(r,e,n).apply(this,s).pipe(xt(t))};return n?function(){for(var s=[],i=0;i<arguments.length;i++)s[i]=arguments[i];return Cn(r,e).apply(this,s).pipe(qn(n),Jn(n))}:function(){for(var s=this,i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];var a=new os,c=!0;return new ne(function(u){var l=a.subscribe(u);if(c){c=!1;var f=!1,y=!1;e.apply(s,ie(ie([],se(i)),[function(){for(var p=[],d=0;d<arguments.length;d++)p[d]=arguments[d];if(r){var h=p.shift();if(h!=null){a.error(h);return}}a.next(1<p.length?p:p[0]),y=!0,f&&a.complete()}])),y&&a.complete(),f=!0}return l})}}function Qf(r,e,t){return Cn(!1,r,e,t)}function Xf(r,e,t){return Cn(!0,r,e,t)}var Zf=Array.isArray,eh=Object.getPrototypeOf,th=Object.prototype,nh=Object.keys;function Yo(r){if(r.length===1){var e=r[0];if(Zf(e))return{args:e,keys:null};if(rh(e)){var t=nh(e);return{args:t.map(function(n){return e[n]}),keys:t}}}return{args:r,keys:null}}function rh(r){return r&&typeof r=="object"&&eh(r)===th}function Go(r,e){return r.reduce(function(t,n,s){return t[n]=e[s],t},{})}function Qo(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=tt(r),n=Zt(r),s=Yo(r),i=s.args,o=s.keys;if(i.length===0)return nt([],t);var a=new ne(Xo(i,t,o?function(c){return Go(o,c)}:xe));return n?a.pipe(xt(n)):a}function Xo(r,e,t){return t===void 0&&(t=xe),function(n){ai(e,function(){for(var s=r.length,i=new Array(s),o=s,a=s,c=function(l){ai(e,function(){var f=nt(r[l],e),y=!1;f.subscribe(M(n,function(p){i[l]=p,y||(y=!0,a--),a||n.next(t(i.slice()))},function(){--o||n.complete()}))},n)},u=0;u<s;u++)c(u)},n)}}function ai(r,e,t){r?Re(t,r,e):e()}function hs(r,e,t,n,s,i,o,a){var c=[],u=0,l=0,f=!1,y=function(){f&&!c.length&&!u&&e.complete()},p=function(h){return u<n?d(h):c.push(h)},d=function(h){i&&e.next(h),u++;var m=!1;q(t(h,l++)).subscribe(M(e,function(g){s==null||s(g),i?p(g):e.next(g)},function(){m=!0},void 0,function(){if(m)try{u--;for(var g=function(){var w=c.shift();o?Re(e,o,function(){return d(w)}):d(w)};c.length&&u<n;)g();y()}catch(w){e.error(w)}}))};return r.subscribe(M(e,p,function(){f=!0,y()})),function(){a==null||a()}}function We(r,e,t){return t===void 0&&(t=1/0),Q(e)?We(function(n,s){return bt(function(i,o){return e(n,i,s,o)})(q(r(n,s)))},t):(typeof e=="number"&&(t=e),z(function(n,s){return hs(n,s,r,t)}))}function Yn(r){return r===void 0&&(r=1/0),We(xe,r)}function ds(){return Yn(1)}function zt(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return ds()(nt(r,tt(r)))}function Gn(r){return new ne(function(e){q(r()).subscribe(e)})}var sh={connector:function(){return new ve},resetOnDisconnect:!0};function ih(r,e){e===void 0&&(e=sh);var t=null,n=e.connector,s=e.resetOnDisconnect,i=s===void 0?!0:s,o=n(),a=new ne(function(c){return o.subscribe(c)});return a.connect=function(){return(!t||t.closed)&&(t=Gn(function(){return r}).subscribe(o),i&&t.add(function(){return o=n()})),t},a}function oh(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=Zt(r),n=Yo(r),s=n.args,i=n.keys,o=new ne(function(a){var c=s.length;if(!c){a.complete();return}for(var u=new Array(c),l=c,f=c,y=function(d){var h=!1;q(s[d]).subscribe(M(a,function(m){h||(h=!0,f--),u[d]=m},function(){return l--},void 0,function(){(!l||!h)&&(f||a.next(i?Go(i,u):u),a.complete())}))},p=0;p<c;p++)y(p)});return t?o.pipe(xt(t)):o}var ah=["addListener","removeListener"],ch=["addEventListener","removeEventListener"],uh=["on","off"];function Br(r,e,t,n){if(Q(t)&&(n=t,t=void 0),n)return Br(r,e,t).pipe(xt(n));var s=se(hh(r)?ch.map(function(a){return function(c){return r[a](e,c,t)}}):lh(r)?ah.map(ci(r,e)):fh(r)?uh.map(ci(r,e)):[],2),i=s[0],o=s[1];if(!i&&us(r))return We(function(a){return Br(a,e,t)})(q(r));if(!i)throw new TypeError("Invalid event target");return new ne(function(a){var c=function(){for(var u=[],l=0;l<arguments.length;l++)u[l]=arguments[l];return a.next(1<u.length?u:u[0])};return i(c),function(){return o(c)}})}function ci(r,e){return function(t){return function(n){return r[t](e,n)}}}function lh(r){return Q(r.addListener)&&Q(r.removeListener)}function fh(r){return Q(r.on)&&Q(r.off)}function hh(r){return Q(r.addEventListener)&&Q(r.removeEventListener)}function Zo(r,e,t){return t?Zo(r,e).pipe(xt(t)):new ne(function(n){var s=function(){for(var o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];return n.next(o.length===1?o[0]:o)},i=r(s);return Q(e)?function(){return e(s,i)}:void 0})}function dh(r,e,t,n,s){var i,o,a,c;arguments.length===1?(i=r,c=i.initialState,e=i.condition,t=i.iterate,o=i.resultSelector,a=o===void 0?xe:o,s=i.scheduler):(c=r,!n||Hn(n)?(a=xe,s=n):a=n);function u(){var l;return ts(this,function(f){switch(f.label){case 0:l=c,f.label=1;case 1:return!e||e(l)?[4,a(l)]:[3,4];case 2:f.sent(),f.label=3;case 3:return l=t(l),[3,1];case 4:return[2]}})}return Gn(s?function(){return Fo(u(),s)}:u)}function ph(r,e,t){return Gn(function(){return r()?e:t})}function Et(r,e,t){r===void 0&&(r=0),t===void 0&&(t=as);var n=-1;return e!=null&&(Hn(e)?t=e:n=e),new ne(function(s){var i=fs(r)?+r-t.now():r;i<0&&(i=0);var o=0;return t.schedule(function(){s.closed||(s.next(o++),0<=n?this.schedule(void 0,n):s.complete())},i)})}function ea(r,e){return r===void 0&&(r=0),e===void 0&&(e=Ue),r<0&&(r=0),Et(r,r,e)}function yh(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=tt(r),n=Io(r,1/0),s=r;return s.length?s.length===1?q(s[0]):Yn(n)(nt(s,t)):Ge}var ta=new ne(pe);function mh(){return ta}var gh=Array.isArray;function jt(r){return r.length===1&&gh(r[0])?r[0]:r}function na(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=jt(r);return new ne(function(n){var s=0,i=function(){if(s<t.length){var o=void 0;try{o=q(t[s++])}catch(c){i();return}var a=new ss(n,void 0,pe,pe);o.subscribe(a),a.add(i)}else n.complete()};i()})}function vh(r,e){return nt(Object.entries(r),e)}function wh(r,e){return function(t,n){return!r.call(e,t,n)}}function gt(r,e){return z(function(t,n){var s=0;t.subscribe(M(n,function(i){return r.call(e,i,s++)&&n.next(i)}))})}function bh(r,e,t){return[gt(e,t)(q(r)),gt(wh(e,t))(q(r))]}function xh(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return r=jt(r),r.length===1?q(r[0]):new ne(ra(r))}function ra(r){return function(e){for(var t=[],n=function(i){t.push(q(r[i]).subscribe(M(e,function(o){if(t){for(var a=0;a<t.length;a++)a!==i&&t[a].unsubscribe();t=null}e.next(o)})))},s=0;t&&!e.closed&&s<r.length;s++)n(s)}}function Eh(r,e,t){if(e==null&&(e=r,r=0),e<=0)return Ge;var n=e+r;return new ne(t?function(s){var i=r;return t.schedule(function(){i<n?(s.next(i++),this.schedule()):s.complete()})}:function(s){for(var i=r;i<n&&!s.closed;)s.next(i++);s.complete()})}function kh(r,e){return new ne(function(t){var n=r(),s=e(n),i=s?q(s):Ge;return i.subscribe(t),function(){n&&n.unsubscribe()}})}function ps(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=Zt(r),n=jt(r);return n.length?new ne(function(s){var i=n.map(function(){return[]}),o=n.map(function(){return!1});s.add(function(){i=o=null});for(var a=function(u){q(n[u]).subscribe(M(s,function(l){if(i[u].push(l),i.every(function(y){return y.length})){var f=i.map(function(y){return y.shift()});s.next(t?t.apply(void 0,ie([],se(f))):f),i.some(function(y,p){return!y.length&&o[p]})&&s.complete()}},function(){o[u]=!0,!i[u].length&&s.complete()}))},c=0;!s.closed&&c<n.length;c++)a(c);return function(){i=o=null}}):Ge}function sa(r){return z(function(e,t){var n=!1,s=null,i=null,o=!1,a=function(){if(i==null||i.unsubscribe(),i=null,n){n=!1;var u=s;s=null,t.next(u)}o&&t.complete()},c=function(){i=null,o&&t.complete()};e.subscribe(M(t,function(u){n=!0,s=u,i||q(r(u)).subscribe(i=M(t,a,c))},function(){o=!0,(!n||!i||i.closed)&&t.complete()}))})}function _h(r,e){return e===void 0&&(e=Ue),sa(function(){return Et(r,e)})}function Ah(r){return z(function(e,t){var n=[];return e.subscribe(M(t,function(s){return n.push(s)},function(){t.next(n),t.complete()})),q(r).subscribe(M(t,function(){var s=n;n=[],t.next(s)},pe)),function(){n=null}})}function Sh(r,e){return e===void 0&&(e=null),e=e!=null?e:r,z(function(t,n){var s=[],i=0;t.subscribe(M(n,function(o){var a,c,u,l,f=null;i++%e===0&&s.push([]);try{for(var y=Ie(s),p=y.next();!p.done;p=y.next()){var d=p.value;d.push(o),r<=d.length&&(f=f!=null?f:[],f.push(d))}}catch(g){a={error:g}}finally{try{p&&!p.done&&(c=y.return)&&c.call(y)}finally{if(a)throw a.error}}if(f)try{for(var h=Ie(f),m=h.next();!m.done;m=h.next()){var d=m.value;et(s,d),n.next(d)}}catch(g){u={error:g}}finally{try{m&&!m.done&&(l=h.return)&&l.call(h)}finally{if(u)throw u.error}}},function(){var o,a;try{for(var c=Ie(s),u=c.next();!u.done;u=c.next()){var l=u.value;n.next(l)}}catch(f){o={error:f}}finally{try{u&&!u.done&&(a=c.return)&&a.call(c)}finally{if(o)throw o.error}}n.complete()},void 0,function(){s=null}))})}function Th(r){for(var e,t,n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];var i=(e=tt(n))!==null&&e!==void 0?e:Ue,o=(t=n[0])!==null&&t!==void 0?t:null,a=n[1]||1/0;return z(function(c,u){var l=[],f=!1,y=function(h){var m=h.buffer,g=h.subs;g.unsubscribe(),et(l,h),u.next(m),f&&p()},p=function(){if(l){var h=new Ce;u.add(h);var m=[],g={buffer:m,subs:h};l.push(g),Re(h,i,function(){return y(g)},r)}};o!==null&&o>=0?Re(u,i,p,o,!0):f=!0,p();var d=M(u,function(h){var m,g,w=l.slice();try{for(var x=Ie(w),S=x.next();!S.done;S=x.next()){var O=S.value,I=O.buffer;I.push(h),a<=I.length&&y(O)}}catch(W){m={error:W}}finally{try{S&&!S.done&&(g=x.return)&&g.call(x)}finally{if(m)throw m.error}}},function(){for(;l!=null&&l.length;)u.next(l.shift().buffer);d==null||d.unsubscribe(),u.complete(),u.unsubscribe()},void 0,function(){return l=null});c.subscribe(d)})}function Oh(r,e){return z(function(t,n){var s=[];q(r).subscribe(M(n,function(i){var o=[];s.push(o);var a=new Ce,c=function(){et(s,o),n.next(o),a.unsubscribe()};a.add(q(e(i)).subscribe(M(n,c,pe)))},pe)),t.subscribe(M(n,function(i){var o,a;try{for(var c=Ie(s),u=c.next();!u.done;u=c.next()){var l=u.value;l.push(i)}}catch(f){o={error:f}}finally{try{u&&!u.done&&(a=c.return)&&a.call(c)}finally{if(o)throw o.error}}},function(){for(;s.length>0;)n.next(s.shift());n.complete()}))})}function Ph(r){return z(function(e,t){var n=null,s=null,i=function(){s==null||s.unsubscribe();var o=n;n=[],o&&t.next(o),q(r()).subscribe(s=M(t,i,pe))};i(),e.subscribe(M(t,function(o){return n==null?void 0:n.push(o)},function(){n&&t.next(n),t.complete()},void 0,function(){return n=s=null}))})}function ia(r){return z(function(e,t){var n=null,s=!1,i;n=e.subscribe(M(t,void 0,void 0,function(o){i=q(r(o,ia(r)(e))),n?(n.unsubscribe(),n=null,i.subscribe(t)):s=!0})),s&&(n.unsubscribe(),n=null,i.subscribe(t))})}function oa(r,e,t,n,s){return function(i,o){var a=t,c=e,u=0;i.subscribe(M(o,function(l){var f=u++;c=a?r(c,l,f):(a=!0,l),n&&o.next(c)},s&&function(){a&&o.next(c),o.complete()}))}}function en(r,e){return z(oa(r,e,arguments.length>=2,!1,!0))}var Ih=function(r,e){return r.push(e),r};function aa(){return z(function(r,e){en(Ih,[])(r).subscribe(e)})}function ca(r,e){return rs(aa(),We(function(t){return r(t)}),e?xt(e):xe)}function ua(r){return ca(Qo,r)}var Rh=ua;function la(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=Zt(r);return t?rs(la.apply(void 0,ie([],se(r))),xt(t)):z(function(n,s){Xo(ie([n],se(jt(r))))(s)})}function Ch(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return la.apply(void 0,ie([],se(r)))}function Lr(r,e){return Q(e)?We(r,e,1):We(r,1)}function Nh(r,e){return Q(e)?Lr(function(){return r},e):Lr(function(){return r})}function $h(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=tt(r);return z(function(n,s){ds()(nt(ie([n],se(r)),t)).subscribe(s)})}function jh(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return $h.apply(void 0,ie([],se(r)))}function Bh(r){return new ne(function(e){return r.subscribe(e)})}var Lh={connector:function(){return new ve}};function ys(r,e){e===void 0&&(e=Lh);var t=e.connector;return z(function(n,s){var i=t();q(r(Bh(i))).subscribe(s),s.add(n.subscribe(i))})}function Dh(r){return en(function(e,t,n){return!r||r(t,n)?e+1:e},0)}function Uh(r){return z(function(e,t){var n=!1,s=null,i=null,o=function(){if(i==null||i.unsubscribe(),i=null,n){n=!1;var a=s;s=null,t.next(a)}};e.subscribe(M(t,function(a){i==null||i.unsubscribe(),n=!0,s=a,i=M(t,o,pe),q(r(a)).subscribe(i)},function(){o(),t.complete()},void 0,function(){s=i=null}))})}function Fh(r,e){return e===void 0&&(e=Ue),z(function(t,n){var s=null,i=null,o=null,a=function(){if(s){s.unsubscribe(),s=null;var u=i;i=null,n.next(u)}};function c(){var u=o+r,l=e.now();if(l<u){s=this.schedule(void 0,u-l),n.add(s);return}a()}t.subscribe(M(n,function(u){i=u,o=e.now(),s||(s=e.schedule(c,r),n.add(s))},function(){a(),n.complete()},void 0,function(){i=s=null}))})}function Qn(r){return z(function(e,t){var n=!1;e.subscribe(M(t,function(s){n=!0,t.next(s)},function(){n||t.next(r),t.complete()}))})}function Wt(r){return r<=0?function(){return Ge}:z(function(e,t){var n=0;e.subscribe(M(t,function(s){++n<=r&&(t.next(s),r<=n&&t.complete())}))})}function fa(){return z(function(r,e){r.subscribe(M(e,pe))})}function ha(r){return bt(function(){return r})}function ms(r,e){return e?function(t){return zt(e.pipe(Wt(1),fa()),t.pipe(ms(r)))}:We(function(t,n){return q(r(t,n)).pipe(Wt(1),ha(t))})}function Mh(r,e){e===void 0&&(e=Ue);var t=Et(r,e);return ms(function(){return t})}function Kh(){return z(function(r,e){r.subscribe(M(e,function(t){return zo(t,e)}))})}function Vh(r,e){return z(function(t,n){var s=new Set;t.subscribe(M(n,function(i){var o=r?r(i):i;s.has(o)||(s.add(o),n.next(i))})),e&&q(e).subscribe(M(n,function(){return s.clear()},pe))})}function da(r,e){return e===void 0&&(e=xe),r=r!=null?r:zh,z(function(t,n){var s,i=!0;t.subscribe(M(n,function(o){var a=e(o);(i||!r(s,a))&&(i=!1,s=a,n.next(o))}))})}function zh(r,e){return r===e}function Wh(r,e){return da(function(t,n){return e?e(t[r],n[r]):t[r]===n[r]})}function Xn(r){return r===void 0&&(r=Hh),z(function(e,t){var n=!1;e.subscribe(M(t,function(s){n=!0,t.next(s)},function(){return n?t.complete():t.error(r())}))})}function Hh(){return new wt}function Jh(r,e){if(r<0)throw new jr;var t=arguments.length>=2;return function(n){return n.pipe(gt(function(s,i){return i===r}),Wt(1),t?Qn(e):Xn(function(){return new jr}))}}function qh(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return function(t){return zt(t,ls.apply(void 0,ie([],se(r))))}}function Yh(r,e){return z(function(t,n){var s=0;t.subscribe(M(n,function(i){r.call(e,i,s++,t)||(n.next(!1),n.complete())},function(){n.next(!0),n.complete()}))})}function gs(r,e){return e?function(t){return t.pipe(gs(function(n,s){return q(r(n,s)).pipe(bt(function(i,o){return e(n,i,s,o)}))}))}:z(function(t,n){var s=0,i=null,o=!1;t.subscribe(M(n,function(a){i||(i=M(n,void 0,function(){i=null,o&&n.complete()}),q(r(a,s++)).subscribe(i))},function(){o=!0,!i&&n.complete()}))})}function pa(){return gs(xe)}var Gh=pa;function Qh(r,e,t){return e===void 0&&(e=1/0),e=(e||0)<1?1/0:e,z(function(n,s){return hs(n,s,r,e,void 0,!0,t)})}function Xh(r){return z(function(e,t){try{e.subscribe(t)}finally{t.add(r)}})}function Zh(r,e){return z(ya(r,e,"value"))}function ya(r,e,t){var n=t==="index";return function(s,i){var o=0;s.subscribe(M(i,function(a){var c=o++;r.call(e,a,c,s)&&(i.next(n?c:a),i.complete())},function(){i.next(n?-1:void 0),i.complete()}))}}function ed(r,e){return z(ya(r,e,"index"))}function td(r,e){var t=arguments.length>=2;return function(n){return n.pipe(r?gt(function(s,i){return r(s,i,n)}):xe,Wt(1),t?Qn(e):Xn(function(){return new wt}))}}function nd(r,e,t,n){return z(function(s,i){var o;!e||typeof e=="function"?o=e:(t=e.duration,o=e.element,n=e.connector);var a=new Map,c=function(d){a.forEach(d),d(i)},u=function(d){return c(function(h){return h.error(d)})},l=0,f=!1,y=new ss(i,function(d){try{var h=r(d),m=a.get(h);if(!m){a.set(h,m=n?n():new ve);var g=p(h,m);if(i.next(g),t){var w=M(m,function(){m.complete(),w==null||w.unsubscribe()},void 0,void 0,function(){return a.delete(h)});y.add(q(t(g)).subscribe(w))}}m.next(o?o(d):d)}catch(x){u(x)}},function(){return c(function(d){return d.complete()})},u,function(){return a.clear()},function(){return f=!0,l===0});s.subscribe(y);function p(d,h){var m=new ne(function(g){l++;var w=h.subscribe(g);return function(){w.unsubscribe(),--l===0&&f&&y.unsubscribe()}});return m.key=d,m}})}function rd(){return z(function(r,e){r.subscribe(M(e,function(){e.next(!1),e.complete()},function(){e.next(!0),e.complete()}))})}function ma(r){return r<=0?function(){return Ge}:z(function(e,t){var n=[];e.subscribe(M(t,function(s){n.push(s),r<n.length&&n.shift()},function(){var s,i;try{for(var o=Ie(n),a=o.next();!a.done;a=o.next()){var c=a.value;t.next(c)}}catch(u){s={error:u}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(s)throw s.error}}t.complete()},void 0,function(){n=null}))})}function sd(r,e){var t=arguments.length>=2;return function(n){return n.pipe(r?gt(function(s,i){return r(s,i,n)}):xe,ma(1),t?Qn(e):Xn(function(){return new wt}))}}function id(){return z(function(r,e){r.subscribe(M(e,function(t){e.next(kn.createNext(t))},function(){e.next(kn.createComplete()),e.complete()},function(t){e.next(kn.createError(t)),e.complete()}))})}function od(r){return en(Q(r)?function(e,t){return r(e,t)>0?e:t}:function(e,t){return e>t?e:t})}var ad=We;function cd(r,e,t){return t===void 0&&(t=1/0),Q(e)?We(function(){return r},e,t):(typeof e=="number"&&(t=e),We(function(){return r},t))}function ud(r,e,t){return t===void 0&&(t=1/0),z(function(n,s){var i=e;return hs(n,s,function(o,a){return r(i,o,a)},t,function(o){i=o},!1,void 0,function(){return i=null})})}function ld(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=tt(r),n=Io(r,1/0);return r=jt(r),z(function(s,i){Yn(n)(nt(ie([s],se(r)),t)).subscribe(i)})}function fd(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return ld.apply(void 0,ie([],se(r)))}function hd(r){return en(Q(r)?function(e,t){return r(e,t)<0?e:t}:function(e,t){return e<t?e:t})}function vs(r,e){var t=Q(r)?r:function(){return r};return Q(e)?ys(e,{connector:t}):function(n){return new zn(n,t)}}function dd(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=jt(r);return function(n){return na.apply(void 0,ie([n],se(t)))}}function pd(){return z(function(r,e){var t,n=!1;r.subscribe(M(e,function(s){var i=t;t=s,n&&e.next([i,s]),n=!0}))})}function yd(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=r.length;if(t===0)throw new Error("list of properties cannot be empty.");return bt(function(n){for(var s=n,i=0;i<t;i++){var o=s==null?void 0:s[r[i]];if(typeof o!="undefined")s=o;else return}return s})}function md(r){return r?function(e){return ys(r)(e)}:function(e){return vs(new ve)(e)}}function gd(r){return function(e){var t=new _o(r);return new zn(e,function(){return t})}}function vd(){return function(r){var e=new os;return new zn(r,function(){return e})}}function wd(r,e,t,n){t&&!Q(t)&&(n=t);var s=Q(t)?t:void 0;return function(i){return vs(new is(r,e,n),s)(i)}}function bd(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return r.length?z(function(t,n){ra(ie([t],se(r)))(n)}):xe}function xd(r){var e,t=1/0,n;return r!=null&&(typeof r=="object"?(e=r.count,t=e===void 0?1/0:e,n=r.delay):t=r),t<=0?function(){return Ge}:z(function(s,i){var o=0,a,c=function(){if(a==null||a.unsubscribe(),a=null,n!=null){var l=typeof n=="number"?Et(n):q(n(o)),f=M(i,function(){f.unsubscribe(),u()});l.subscribe(f)}else u()},u=function(){var l=!1;a=s.subscribe(M(i,void 0,function(){++o<t?a?c():l=!0:i.complete()})),l&&c()};u()})}function Ed(r){return z(function(e,t){var n,s=!1,i,o=!1,a=!1,c=function(){return a&&o&&(t.complete(),!0)},u=function(){return i||(i=new ve,q(r(i)).subscribe(M(t,function(){n?l():s=!0},function(){o=!0,c()}))),i},l=function(){a=!1,n=e.subscribe(M(t,void 0,function(){a=!0,!c()&&u().next()})),s&&(n.unsubscribe(),n=null,s=!1,l())};l()})}function kd(r){r===void 0&&(r=1/0);var e;r&&typeof r=="object"?e=r:e={count:r};var t=e.count,n=t===void 0?1/0:t,s=e.delay,i=e.resetOnSuccess,o=i===void 0?!1:i;return n<=0?xe:z(function(a,c){var u=0,l,f=function(){var y=!1;l=a.subscribe(M(c,function(p){o&&(u=0),c.next(p)},void 0,function(p){if(u++<n){var d=function(){l?(l.unsubscribe(),l=null,f()):y=!0};if(s!=null){var h=typeof s=="number"?Et(s):q(s(p,u)),m=M(c,function(){m.unsubscribe(),d()},function(){c.complete()});h.subscribe(m)}else d()}else c.error(p)})),y&&(l.unsubscribe(),l=null,f())};f()})}function _d(r){return z(function(e,t){var n,s=!1,i,o=function(){n=e.subscribe(M(t,void 0,void 0,function(a){i||(i=new ve,q(r(i)).subscribe(M(t,function(){return n?o():s=!0}))),i&&i.next(a)})),s&&(n.unsubscribe(),n=null,s=!1,o())};o()})}function ga(r){return z(function(e,t){var n=!1,s=null;e.subscribe(M(t,function(i){n=!0,s=i})),q(r).subscribe(M(t,function(){if(n){n=!1;var i=s;s=null,t.next(i)}},pe))})}function Ad(r,e){return e===void 0&&(e=Ue),ga(ea(r,e))}function Sd(r,e){return z(oa(r,e,arguments.length>=2,!0))}function Td(r,e){return e===void 0&&(e=function(t,n){return t===n}),z(function(t,n){var s=ui(),i=ui(),o=function(c){n.next(c),n.complete()},a=function(c,u){var l=M(n,function(f){var y=u.buffer,p=u.complete;y.length===0?p?o(!1):c.buffer.push(f):!e(f,y.shift())&&o(!1)},function(){c.complete=!0;var f=u.complete,y=u.buffer;f&&o(y.length===0),l==null||l.unsubscribe()});return l};t.subscribe(a(s,i)),q(r).subscribe(a(i,s))})}function ui(){return{buffer:[],complete:!1}}function va(r){r===void 0&&(r={});var e=r.connector,t=e===void 0?function(){return new ve}:e,n=r.resetOnError,s=n===void 0?!0:n,i=r.resetOnComplete,o=i===void 0?!0:i,a=r.resetOnRefCountZero,c=a===void 0?!0:a;return function(u){var l,f,y,p=0,d=!1,h=!1,m=function(){f==null||f.unsubscribe(),f=void 0},g=function(){m(),l=y=void 0,d=h=!1},w=function(){var x=l;g(),x==null||x.unsubscribe()};return z(function(x,S){p++,!h&&!d&&m();var O=y=y!=null?y:t();S.add(function(){p--,p===0&&!h&&!d&&(f=yr(w,c))}),O.subscribe(S),!l&&p>0&&(l=new Ct({next:function(I){return O.next(I)},error:function(I){h=!0,m(),f=yr(g,s,I),O.error(I)},complete:function(){d=!0,m(),f=yr(g,o),O.complete()}}),q(x).subscribe(l))})(u)}}function yr(r,e){for(var t=[],n=2;n<arguments.length;n++)t[n-2]=arguments[n];if(e===!0){r();return}if(e!==!1){var s=new Ct({next:function(){s.unsubscribe(),r()}});return q(e.apply(void 0,ie([],se(t)))).subscribe(s)}}function Od(r,e,t){var n,s,i,o,a=!1;return r&&typeof r=="object"?(n=r.bufferSize,o=n===void 0?1/0:n,s=r.windowTime,e=s===void 0?1/0:s,i=r.refCount,a=i===void 0?!1:i,t=r.scheduler):o=r!=null?r:1/0,va({connector:function(){return new is(o,e,t)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:a})}function Pd(r){return z(function(e,t){var n=!1,s,i=!1,o=0;e.subscribe(M(t,function(a){i=!0,(!r||r(a,o++,e))&&(n&&t.error(new Ho("Too many matching values")),n=!0,s=a)},function(){n?(t.next(s),t.complete()):t.error(i?new Wo("No matching values"):new wt)}))})}function Id(r){return gt(function(e,t){return r<=t})}function Rd(r){return r<=0?xe:z(function(e,t){var n=new Array(r),s=0;return e.subscribe(M(t,function(i){var o=s++;if(o<r)n[o]=i;else{var a=o%r,c=n[a];n[a]=i,t.next(c)}})),function(){n=null}})}function Cd(r){return z(function(e,t){var n=!1,s=M(t,function(){s==null||s.unsubscribe(),n=!0},pe);q(r).subscribe(s),e.subscribe(M(t,function(i){return n&&t.next(i)}))})}function Nd(r){return z(function(e,t){var n=!1,s=0;e.subscribe(M(t,function(i){return(n||(n=!r(i,s++)))&&t.next(i)}))})}function $d(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=tt(r);return z(function(n,s){(t?zt(r,n,t):zt(r,n)).subscribe(s)})}function Ht(r,e){return z(function(t,n){var s=null,i=0,o=!1,a=function(){return o&&!s&&n.complete()};t.subscribe(M(n,function(c){s==null||s.unsubscribe();var u=0,l=i++;q(r(c,l)).subscribe(s=M(n,function(f){return n.next(e?e(c,f,l,u++):f)},function(){s=null,a()}))},function(){o=!0,a()}))})}function jd(){return Ht(xe)}function Bd(r,e){return Q(e)?Ht(function(){return r},e):Ht(function(){return r})}function Ld(r,e){return z(function(t,n){var s=e;return Ht(function(i,o){return r(s,i,o)},function(i,o){return s=o,o})(t).subscribe(n),function(){s=null}})}function Dd(r){return z(function(e,t){q(r).subscribe(M(t,function(){return t.complete()},pe)),!t.closed&&e.subscribe(t)})}function Ud(r,e){return e===void 0&&(e=!1),z(function(t,n){var s=0;t.subscribe(M(n,function(i){var o=r(i,s++);(o||e)&&n.next(i),!o&&n.complete()}))})}function Fd(r,e,t){var n=Q(r)||e||t?{next:r,error:e,complete:t}:r;return n?z(function(s,i){var o;(o=n.subscribe)===null||o===void 0||o.call(n);var a=!0;s.subscribe(M(i,function(c){var u;(u=n.next)===null||u===void 0||u.call(n,c),i.next(c)},function(){var c;a=!1,(c=n.complete)===null||c===void 0||c.call(n),i.complete()},function(c){var u;a=!1,(u=n.error)===null||u===void 0||u.call(n,c),i.error(c)},function(){var c,u;a&&((c=n.unsubscribe)===null||c===void 0||c.call(n)),(u=n.finalize)===null||u===void 0||u.call(n)}))}):xe}function wa(r,e){return z(function(t,n){var s=e!=null?e:{},i=s.leading,o=i===void 0?!0:i,a=s.trailing,c=a===void 0?!1:a,u=!1,l=null,f=null,y=!1,p=function(){f==null||f.unsubscribe(),f=null,c&&(m(),y&&n.complete())},d=function(){f=null,y&&n.complete()},h=function(g){return f=q(r(g)).subscribe(M(n,p,d))},m=function(){if(u){u=!1;var g=l;l=null,n.next(g),!y&&h(g)}};t.subscribe(M(n,function(g){u=!0,l=g,!(f&&!f.closed)&&(o?m():h(g))},function(){y=!0,!(c&&u&&f&&!f.closed)&&n.complete()}))})}function Md(r,e,t){e===void 0&&(e=Ue);var n=Et(r,e);return wa(function(){return n},t)}function Kd(r){return r===void 0&&(r=Ue),z(function(e,t){var n=r.now();e.subscribe(M(t,function(s){var i=r.now(),o=i-n;n=i,t.next(new Vd(s,o))}))})}var Vd=function(){function r(e,t){this.value=e,this.interval=t}return r}();function zd(r,e,t){var n,s,i;if(t=t!=null?t:as,fs(r)?n=r:typeof r=="number"&&(s=r),e)i=function(){return e};else throw new TypeError("No observable provided to switch to");if(n==null&&s==null)throw new TypeError("No timeout provided.");return qo({first:n,each:s,scheduler:t,with:i})}function Wd(r){return r===void 0&&(r=Wn),bt(function(e){return{value:e,timestamp:r.now()}})}function Hd(r){return z(function(e,t){var n=new ve;t.next(n.asObservable());var s=function(i){n.error(i),t.error(i)};return e.subscribe(M(t,function(i){return n==null?void 0:n.next(i)},function(){n.complete(),t.complete()},s)),q(r).subscribe(M(t,function(){n.complete(),t.next(n=new ve)},pe,s)),function(){n==null||n.unsubscribe(),n=null}})}function Jd(r,e){e===void 0&&(e=0);var t=e>0?e:r;return z(function(n,s){var i=[new ve],o=[],a=0;s.next(i[0].asObservable()),n.subscribe(M(s,function(c){var u,l;try{for(var f=Ie(i),y=f.next();!y.done;y=f.next()){var p=y.value;p.next(c)}}catch(m){u={error:m}}finally{try{y&&!y.done&&(l=f.return)&&l.call(f)}finally{if(u)throw u.error}}var d=a-r+1;if(d>=0&&d%t===0&&i.shift().complete(),++a%t===0){var h=new ve;i.push(h),s.next(h.asObservable())}},function(){for(;i.length>0;)i.shift().complete();s.complete()},function(c){for(;i.length>0;)i.shift().error(c);s.error(c)},function(){o=null,i=null}))})}function qd(r){for(var e,t,n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];var i=(e=tt(n))!==null&&e!==void 0?e:Ue,o=(t=n[0])!==null&&t!==void 0?t:null,a=n[1]||1/0;return z(function(c,u){var l=[],f=!1,y=function(m){var g=m.window,w=m.subs;g.complete(),w.unsubscribe(),et(l,m),f&&p()},p=function(){if(l){var m=new Ce;u.add(m);var g=new ve,w={window:g,subs:m,seen:0};l.push(w),u.next(g.asObservable()),Re(m,i,function(){return y(w)},r)}};o!==null&&o>=0?Re(u,i,p,o,!0):f=!0,p();var d=function(m){return l.slice().forEach(m)},h=function(m){d(function(g){var w=g.window;return m(w)}),m(u),u.unsubscribe()};return c.subscribe(M(u,function(m){d(function(g){g.window.next(m),a<=++g.seen&&y(g)})},function(){return h(function(m){return m.complete()})},function(m){return h(function(g){return g.error(m)})})),function(){l=null}})}function Yd(r,e){return z(function(t,n){var s=[],i=function(o){for(;0<s.length;)s.shift().error(o);n.error(o)};q(r).subscribe(M(n,function(o){var a=new ve;s.push(a);var c=new Ce,u=function(){et(s,a),a.complete(),c.unsubscribe()},l;try{l=q(e(o))}catch(f){i(f);return}n.next(a.asObservable()),c.add(l.subscribe(M(n,u,pe,i)))},pe)),t.subscribe(M(n,function(o){var a,c,u=s.slice();try{for(var l=Ie(u),f=l.next();!f.done;f=l.next()){var y=f.value;y.next(o)}}catch(p){a={error:p}}finally{try{f&&!f.done&&(c=l.return)&&c.call(l)}finally{if(a)throw a.error}}},function(){for(;0<s.length;)s.shift().complete();n.complete()},i,function(){for(;0<s.length;)s.shift().unsubscribe()}))})}function Gd(r){return z(function(e,t){var n,s,i=function(a){n.error(a),t.error(a)},o=function(){s==null||s.unsubscribe(),n==null||n.complete(),n=new ve,t.next(n.asObservable());var a;try{a=q(r())}catch(c){i(c);return}a.subscribe(s=M(t,o,o,i))};o(),e.subscribe(M(t,function(a){return n.next(a)},function(){n.complete(),t.complete()},i,function(){s==null||s.unsubscribe(),n=null}))})}function Qd(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];var t=Zt(r);return z(function(n,s){for(var i=r.length,o=new Array(i),a=r.map(function(){return!1}),c=!1,u=function(f){q(r[f]).subscribe(M(s,function(y){o[f]=y,!c&&!a[f]&&(a[f]=!0,(c=a.every(xe))&&(a=null))},pe))},l=0;l<i;l++)u(l);n.subscribe(M(s,function(f){if(c){var y=ie([f],se(o));s.next(t?t.apply(void 0,ie([],se(y))):y)}}))})}function Xd(r){return ca(ps,r)}function Zd(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return z(function(t,n){ps.apply(void 0,ie([t],se(r))).subscribe(n)})}function ep(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return Zd.apply(void 0,ie([],se(r)))}const tp=Object.freeze(Object.defineProperty({__proto__:null,Observable:ne,ConnectableObservable:zn,observable:Vn,animationFrames:mf,Subject:ve,BehaviorSubject:_o,ReplaySubject:is,AsyncSubject:os,asap:_f,asapScheduler:So,async:as,asyncScheduler:Ue,queue:Tf,queueScheduler:To,animationFrame:If,animationFrameScheduler:Oo,VirtualTimeScheduler:Rf,VirtualAction:Po,Scheduler:Nr,Subscription:Ce,Subscriber:Kn,Notification:kn,get NotificationKind(){return $r},pipe:rs,noop:pe,identity:xe,isObservable:Wf,lastValueFrom:Hf,firstValueFrom:Jf,ArgumentOutOfRangeError:jr,EmptyError:wt,NotFoundError:Wo,ObjectUnsubscribedError:ko,SequenceError:Ho,TimeoutError:Jo,UnsubscriptionError:xn,bindCallback:Qf,bindNodeCallback:Xf,combineLatest:Qo,concat:zt,connectable:ih,defer:Gn,empty:Cf,forkJoin:oh,from:nt,fromEvent:Br,fromEventPattern:Zo,generate:dh,iif:ph,interval:ea,merge:yh,never:mh,of:ls,onErrorResumeNext:na,pairs:vh,partition:bh,race:xh,range:Eh,throwError:Vo,timer:Et,using:kh,zip:ps,scheduled:Ko,EMPTY:Ge,NEVER:ta,config:ft,audit:sa,auditTime:_h,buffer:Ah,bufferCount:Sh,bufferTime:Th,bufferToggle:Oh,bufferWhen:Ph,catchError:ia,combineAll:Rh,combineLatestAll:ua,combineLatestWith:Ch,concatAll:ds,concatMap:Lr,concatMapTo:Nh,concatWith:jh,connect:ys,count:Dh,debounce:Uh,debounceTime:Fh,defaultIfEmpty:Qn,delay:Mh,delayWhen:ms,dematerialize:Kh,distinct:Vh,distinctUntilChanged:da,distinctUntilKeyChanged:Wh,elementAt:Jh,endWith:qh,every:Yh,exhaust:Gh,exhaustAll:pa,exhaustMap:gs,expand:Qh,filter:gt,finalize:Xh,find:Zh,findIndex:ed,first:td,groupBy:nd,ignoreElements:fa,isEmpty:rd,last:sd,map:bt,mapTo:ha,materialize:id,max:od,mergeAll:Yn,flatMap:ad,mergeMap:We,mergeMapTo:cd,mergeScan:ud,mergeWith:fd,min:hd,multicast:vs,observeOn:Jn,onErrorResumeNextWith:dd,pairwise:pd,pluck:yd,publish:md,publishBehavior:gd,publishLast:vd,publishReplay:wd,raceWith:bd,reduce:en,repeat:xd,repeatWhen:Ed,retry:kd,retryWhen:_d,refCount:bo,sample:ga,sampleTime:Ad,scan:Sd,sequenceEqual:Td,share:va,shareReplay:Od,single:Pd,skip:Id,skipLast:Rd,skipUntil:Cd,skipWhile:Nd,startWith:$d,subscribeOn:qn,switchAll:jd,switchMap:Ht,switchMapTo:Bd,switchScan:Ld,take:Wt,takeLast:ma,takeUntil:Dd,takeWhile:Ud,tap:Fd,throttle:wa,throttleTime:Md,throwIfEmpty:Xn,timeInterval:Kd,timeout:qo,timeoutWith:zd,timestamp:Wd,toArray:aa,window:Hd,windowCount:Jd,windowTime:qd,windowToggle:Yd,windowWhen:Gd,withLatestFrom:Qd,zipAll:Xd,zipWith:ep},Symbol.toStringTag,{value:"Module"}));export{rp as default};
//# sourceMappingURL=swyger-client-auth.min.js.map
